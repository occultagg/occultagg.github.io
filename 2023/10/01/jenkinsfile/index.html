<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="https://cdn.jsdelivr.net/gh/occultagg/blog-pics/hexo-blog/202206120024516.ico"><link rel="icon" href="https://cdn.jsdelivr.net/gh/occultagg/blog-pics/hexo-blog/202206120024516.ico"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#2f4154"><meta name="author" content="Peter Pan"><meta name="keywords" content=""><meta name="description" content="基础声明式vs脚本式 脚本式流水线更依赖groovy(特别是错误检查和异常处理)，全写node&#123;&#125;块内。  声明式更关注实现逻辑步骤，一般都是直接写声明式。  需要理解，jenkinsfile写的是一种基于groovy开发而来的语法（DSL：领域特定语言Domain-Specific Language），100%兼容groovy，意味着：  你可以直接写groovy，比如定义"><meta property="og:type" content="article"><meta property="og:title" content="JenkinsFile 工作总结"><meta property="og:url" content="http://example.com/2023/10/01/jenkinsfile/index.html"><meta property="og:site_name" content="Any &amp; Nothing"><meta property="og:description" content="基础声明式vs脚本式 脚本式流水线更依赖groovy(特别是错误检查和异常处理)，全写node&#123;&#125;块内。  声明式更关注实现逻辑步骤，一般都是直接写声明式。  需要理解，jenkinsfile写的是一种基于groovy开发而来的语法（DSL：领域特定语言Domain-Specific Language），100%兼容groovy，意味着：  你可以直接写groovy，比如定义"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://raw.githubusercontent.com/occultagg/blog-pics/master/hexo-blog%5Clogo-title-opengraph.png"><meta property="article:published_time" content="2023-10-01T09:46:04.000Z"><meta property="article:modified_time" content="2024-12-11T09:52:23.055Z"><meta property="article:author" content="Peter Pan"><meta property="article:tag" content="JenkinsFile"><meta property="article:tag" content="Devops"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://raw.githubusercontent.com/occultagg/blog-pics/master/hexo-blog%5Clogo-title-opengraph.png"><meta name="referrer" content="no-referrer-when-downgrade"><title>JenkinsFile 工作总结 - Any &amp; Nothing</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"example.com",root:"/",version:"1.9.7",typing:{enable:!0,typeSpeed:70,cursorChar:"|",loop:!1,scope:["home"]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!0,offset_factor:2},web_analytics:{enable:!0,follow_dnt:!0,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml",include_content_in_search:!0};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Any & Nothing" type="application/atom+xml">
</head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Any &amp; Nothing</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/" target="_self"><i class="iconfont icon-home-fill"></i> <span>首页</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/" target="_self"><i class="iconfont icon-archive-fill"></i> <span>归档</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/" target="_self"><i class="iconfont icon-category-fill"></i> <span>分类</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/" target="_self"><i class="iconfont icon-tags-fill"></i> <span>标签</span></a></li><li class="nav-item"><a class="nav-link" href="/about/" target="_self"><i class="iconfont icon-user-fill"></i> <span>关于</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle">JenkinsFile 工作总结</span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2023-10-01 17:46" pubdate>2023年10月1日 下午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 2.5k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 21 分钟</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 id="seo-header">JenkinsFile 工作总结</h1><div class="markdown-body"><p><img src="https://raw.githubusercontent.com/occultagg/blog-pics/master/hexo-blog%5Clogo-title-opengraph.png" srcset="/img/loading.gif" lazyload></p><h1 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h1><h2 id="声明式vs脚本式"><a href="#声明式vs脚本式" class="headerlink" title="声明式vs脚本式"></a>声明式vs脚本式</h2><ul><li><p>脚本式流水线更依赖groovy(特别是错误检查和异常处理)，全写<code>node&#123;&#125;</code>块内。</p></li><li><p>声明式更关注实现逻辑步骤，一般都是直接写声明式。</p></li><li><p>需要理解，jenkinsfile写的是一种基于groovy开发而来的语法（DSL：领域特定语言<code>Domain-Specific Language</code>），100%兼容groovy，意味着：</p><ul><li><p>你可以直接写groovy，比如定义一个groovy函数</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs groovy"><span class="hljs-keyword">def</span> function(a)&#123;<br>    ...<br><br>&#125;<br><span class="hljs-comment">// 并在Jenkinsfile的任何地方调用它,a是要传递给函数的参数</span><br>function(a)<br></code></pre></td></tr></table></figure></li><li><p>声明式中<code>script&#123;&#125;</code>块用来处理groovy代码</p></li></ul></li></ul><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><h3 id="节点"><a href="#节点" class="headerlink" title="节点"></a>节点</h3><p>一个概念，包含<code>任何可以执行jenkins任务的系统</code>，包括<code>主节点和代理节点</code>，也可以是一个容器。</p><ul><li><p>主节点</p><p>是一个jenkins实例的<code>主要控制系统</code>,它完全可以访问所有的配置选项和任务（jpb）列表,负责调度构建任务,执行管理任务,处理用户请求,更新配置等,如果没有指定其他节点,它也是默认的任务执行节点.</p></li><li><p>代理节点</p><p>早期版本的jenkins中也称作slave(从节点),连接到主节点的一台或多台机器(物理,虚拟,容器,云服务器).由主节点控制,负责执行构建和测试任务.使用从节点可以创建一个多机器的分布式构建环境,以适配不同平台或配置的环境进行构建.</p></li></ul><h3 id="执行器-Excutor"><a href="#执行器-Excutor" class="headerlink" title="执行器(Excutor)"></a>执行器(Excutor)</h3><p>一个执行器是指可以执行任务的槽位或线程.一个节点配置了多少个执行器就可以<code>并发</code>运行多少个独立的构建任务.执行器的数量可以根据节点的资源(cpu,内存)来确定.数量的设置影响jenkins的负载均衡和任务调度能力.</p><blockquote><p>Jenkins处理并发任务的机制基于Excutor模型,每个节点都可以配置一定数量的执行者,这些执行者决定了同时可以运行多少个作业.</p></blockquote><h3 id="项目-Item"><a href="#项目-Item" class="headerlink" title="项目(Item)"></a>项目(Item)</h3><p>一个持续集成&#x2F;持续部署的<code>任务或作业</code>,jenkins支持多种类型的项目,比如“Freestyle project”，“Pipeline”，“Multibranch Pipeline”等</p><h2 id="声明式结构"><a href="#声明式结构" class="headerlink" title="声明式结构"></a>声明式结构</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><code class="hljs groovy">pipeline &#123;<br>    agent any<br>    <br>    triggers &#123; <span class="hljs-comment">// triggers用于定义触发器,比如配合cron实现定时触发</span><br>        cron(<span class="hljs-string">&#x27;H */4 * * 1-5&#x27;</span>)<br>    &#125;<br><br>    environment &#123;<br>        <span class="hljs-comment">// 定义环境变量</span><br>        MY_ENV_VAR = <span class="hljs-string">&#x27;some_value&#x27;</span><br>    &#125;<br>    <br>    parameters &#123; <span class="hljs-comment">// 定义pipeline的用户输入参数，description支持一些简单的html标签(高版本).通过`params.&lt;name&gt;`调用参数</span><br>        string(<span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;GREETING&#x27;</span>, <span class="hljs-attr">defaultValue:</span> <span class="hljs-string">&#x27;Hello&#x27;</span>, <span class="hljs-attr">description:</span> <span class="hljs-string">&#x27;The greeting you want to use&#x27;</span>)<br>        booleanParam(<span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;INCLUDE_TIMESTAMP&#x27;</span>, <span class="hljs-attr">defaultValue:</span> <span class="hljs-literal">true</span>, <span class="hljs-attr">description:</span> <span class="hljs-string">&#x27;Include a timestamp with the greeting?&#x27;</span>)<br>        choice(<span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;ENVIRONMENT&#x27;</span>, <span class="hljs-attr">choices:</span> [<span class="hljs-string">&#x27;Staging&#x27;</span>, <span class="hljs-string">&#x27;QA&#x27;</span>, <span class="hljs-string">&#x27;Production&#x27;</span>], <span class="hljs-attr">description:</span> <span class="hljs-string">&#x27;The target environment&#x27;</span>)<br>        password(<span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;DEPLOY_KEY&#x27;</span>, <span class="hljs-attr">defaultValue:</span> <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-attr">description:</span> <span class="hljs-string">&#x27;The deployment key&#x27;</span>)<br>    &#125;<br><br>    stages &#123; <span class="hljs-comment">// 包含所有stage块的主块</span><br>        stage(<span class="hljs-string">&#x27;Prepare&#x27;</span>) &#123; <span class="hljs-comment">// stage定义流水线一个阶段</span><br>            steps &#123; <span class="hljs-comment">// steps块则是定义这一阶段具体要执行的操作</span><br>                <span class="hljs-comment">// 执行准备工作</span><br>                echo <span class="hljs-string">&#x27;Preparing the environment...&#x27;</span><br>                script &#123;<br>                    println <span class="hljs-string">&#x27;Hello World&#x27;</span><br>                &#125;<br>            &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;Checkout&#x27;</span>) &#123;<br>            steps &#123;<br>                <span class="hljs-comment">// 从版本控制系统检出代码</span><br>                checkout scm<br>            &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;Build&#x27;</span>) &#123;<br>            when &#123;<br>                expression&#123;<br>                    anyOf &#123; <span class="hljs-comment">// anyOf表示或关系,allOf表示与关系,可以嵌套</span><br>                        not &#123; <span class="hljs-comment">// 加一层not块就表示非</span><br>                        	params.GREETING == <span class="hljs-string">&#x27;Hello&#x27;</span><br>                        	params.INCLUDE_TIMESTAMP == <span class="hljs-string">&#x27;false&#x27;</span><br>                        &#125;<br>                	&#125;<br>                &#125;<br>            &#125;<br>            steps &#123;<br>                <span class="hljs-comment">// 执行构建</span><br>                echo <span class="hljs-string">&#x27;Building...&#x27;</span><br>                script &#123;<br>                    <span class="hljs-comment">// 执行脚本命令</span><br>                    env.BUILD_ID = sh(<span class="hljs-attr">returnStdout:</span> <span class="hljs-literal">true</span>, <span class="hljs-attr">script:</span> <span class="hljs-string">&#x27;date +%F_%H-%M-%S&#x27;</span>).trim()<br>                    echo <span class="hljs-string">&quot;Build ID: $&#123;env.BUILD_ID&#125;&quot;</span><br>                &#125;<br>            &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;Test&#x27;</span>) &#123;<br>            steps &#123;<br>                <span class="hljs-comment">// 运行测试</span><br>                echo <span class="hljs-string">&#x27;Testing...&#x27;</span><br>                script &#123;<br>                    currentBuild.result = <span class="hljs-string">&#x27;SUCCESS&#x27;</span> <span class="hljs-comment">// currentBuild是Pipeline插件提供的一个全局变量,这个变量指向一个RunWrapper类的实例,其中有result属性用于表示构建的状态(结果)</span><br>                &#125;<br>            &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;Deploy&#x27;</span>) &#123;<br>            when &#123; <span class="hljs-comment">// 有条件地执行stage</span><br>                expression &#123;<br>                    currentBuild.result == <span class="hljs-string">&#x27;SUCCESS&#x27;</span> <br>                &#125;<br>            &#125;<br>            steps &#123;<br>                <span class="hljs-comment">// 部署到服务器</span><br>                echo <span class="hljs-string">&#x27;Deploying...&#x27;</span><br>            &#125;<br>        &#125;<br>        <br>        stage(<span class="hljs-string">&#x27;Parallel Stage&#x27;</span>) &#123;<br>            steps &#123;<br>                script &#123;<br>                    parallel( <span class="hljs-comment">// 并发执行,注意格式</span><br>                        <span class="hljs-symbol">stage1:</span> &#123; <span class="hljs-comment">// 这里的stage1和下面的stage2都是标识符,用来区分,没有其他特别的含义,可以自定义其他名字</span><br>                            echo <span class="hljs-string">&#x27;Running stage 1&#x27;</span><br>                        &#125;,<br>                        <span class="hljs-symbol">stage2:</span> &#123;<br>                            echo <span class="hljs-string">&#x27;Running stage 2&#x27;</span><br>                        &#125;,<br>                        <span class="hljs-symbol">failFast:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">// 可选参数,true表示任一并发阶段失败,则整个parallel都会失败</span><br>                    )<br>                &#125;<br>            &#125;<br>    	&#125;<br>    &#125;<br><br>    post &#123;<br>        <span class="hljs-comment">// 构建后的操作</span><br>        always &#123;<br>            echo <span class="hljs-string">&#x27;This will always run&#x27;</span><br>        &#125;<br>        success &#123;<br>            echo <span class="hljs-string">&#x27;Build was successful!&#x27;</span><br>        &#125;<br>        failure &#123;<br>            echo <span class="hljs-string">&#x27;Build failed.&#x27;</span><br>        &#125;<br>        unstable &#123;<br>            echo <span class="hljs-string">&#x27;Build is unstable.&#x27;</span><br>        &#125;<br>        cleanup &#123;<br>            <span class="hljs-comment">// 清理后续操作</span><br>            echo <span class="hljs-string">&#x27;Performing cleanup steps&#x27;</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h1><p>使用docker部署个一主一从Jenkins</p><ol><li><p>创建master镜像</p><p>这是官方文档给的例子,包含blue-ocean插件</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> jenkins/jenkins:<span class="hljs-number">2.426</span>.<span class="hljs-number">3</span>-jdk17<br><span class="hljs-keyword">USER</span> root<br><span class="hljs-keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get install -y lsb-release</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> curl -fsSLo /usr/share/keyrings/docker-archive-keyring.asc \</span><br><span class="language-bash">  https://download.docker.com/linux/debian/gpg</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;deb [arch=<span class="hljs-subst">$(dpkg --print-architecture)</span> \</span></span><br><span class="hljs-string"><span class="language-bash">  signed-by=/usr/share/keyrings/docker-archive-keyring.asc] \</span></span><br><span class="hljs-string"><span class="language-bash">  https://download.docker.com/linux/debian \</span></span><br><span class="hljs-string"><span class="language-bash">  <span class="hljs-subst">$(lsb_release -cs)</span> stable&quot;</span> &gt; /etc/apt/sources.list.d/docker.list</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get install -y docker-ce-cli</span><br><span class="hljs-keyword">USER</span> jenkins<br><span class="hljs-keyword">RUN</span><span class="language-bash"> jenkins-plugin-cli --plugins <span class="hljs-string">&quot;blueocean docker-workflow&quot;</span></span><br></code></pre></td></tr></table></figure></li><li><p>启动master</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker build . -t myjenkins-blueocean:2.426.3-1<br>docker network create jenkins<br>docker run --name jenkins-blueocean --restart=on-failure --detach \<br>--network jenkins --env DOCKER_HOST=tcp://docker:2376 \<br>--env DOCKER_CERT_PATH=/certs/client --env DOCKER_TLS_VERIFY=1 \<br>--publish 8080:8080 --publish 50000:50000 \<br>--volume jenkins-data:/var/jenkins_home \<br>--volume jenkins-docker-certs:/certs/client:ro \<br>myjenkins-blueocean:2.426.3-1<br><span class="hljs-meta prompt_"># </span><span class="language-bash">获取token用于首次登录</span><br>docker logs -f jenkins-blueocean<br></code></pre></td></tr></table></figure></li><li><p>添加slave节点</p><p><img src="https://cdn.jsdelivr.net/gh/occultagg/blog-pics/hexo-blog/image-20240326203656002.png" srcset="/img/loading.gif" lazyload alt="image-20240326203656002"></p></li></ol><p>​	<img src="https://cdn.jsdelivr.net/gh/occultagg/blog-pics/hexo-blog/image-20240326203717691.png" srcset="/img/loading.gif" lazyload alt="image-20240326203717691"></p><p><img src="https://cdn.jsdelivr.net/gh/occultagg/blog-pics/hexo-blog/image-20240326203741886.png" srcset="/img/loading.gif" lazyload alt="image-20240326203741886"></p><p><img src="https://cdn.jsdelivr.net/gh/occultagg/blog-pics/hexo-blog/image-20240326203840196.png" srcset="/img/loading.gif" lazyload alt="image-20240326203840196"></p><p>启动方式选择<code>java代理</code></p><p>创建节点后,点解节点的配置,就能看到启动jenkins-agent的命令,记下里面的<code>secret</code>参数</p><ol start="4"><li><p>创建slave镜像</p><p>实际上任何一个可以运行jenkins.jar的环境都可以是jenkins的节点,如果是裸机,先通过主节点获取jenkins.jar,然后直接执行上一步展示出来的命令即可,我这里懒得再开一台虚拟机,所以直接docker完事.</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-comment"># 使用带有 Java 的官方基础镜像</span><br><span class="hljs-keyword">FROM</span> openjdk:<span class="hljs-number">17</span>-jdk<br><br><span class="hljs-comment"># 设置 Jenkins 主节点地址，代理节点名称和代理秘密的环境变量</span><br><span class="hljs-comment"># 这些环境变量应该在运行容</span><br><span class="hljs-keyword">ENV</span> JENKINS_URL=http://<span class="hljs-number">172.18</span>.<span class="hljs-number">0.2</span>:<span class="hljs-number">8080</span> <span class="hljs-comment"># 由于是同一台机器上的两个docker镜像,所以我写的是docker网络的地址</span><br><span class="hljs-keyword">ENV</span> JENKINS_NODE_NAME=test-slave <span class="hljs-comment"># 与创建slave的时候名字一致</span><br><span class="hljs-keyword">ENV</span> JENKINS_SECRET=<span class="hljs-number">1735</span>b637d6de619d0396e3198fdc418da5e5cfd35c5cbff70f222821ce85dfdc <span class="hljs-comment"># 使用上面步骤保存下来的secret</span><br><br><span class="hljs-comment"># 设置 Jenkins 从节点的工作目录环境变量</span><br><span class="hljs-keyword">ENV</span> JENKINS_AGENT_WORKDIR=/home/jenkins/agent<br><br><span class="hljs-comment"># 添加 Jenkins 用户</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> useradd -m -d /home/jenkins -s /bin/bash jenkins &amp;&amp; \</span><br><span class="language-bash">    <span class="hljs-built_in">mkdir</span> -p /home/jenkins/agent &amp;&amp; \</span><br><span class="language-bash">    <span class="hljs-built_in">chown</span> -R jenkins:jenkins /home/jenkins</span><br><br><span class="hljs-comment"># 作为用户 jenkins 操作</span><br><span class="hljs-keyword">USER</span> jenkins<br><br><span class="hljs-comment"># 将工作目录设置为 Jenkins 用户的家目录</span><br><span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /home/jenkins</span><br><br><span class="hljs-comment"># 下载 Jenkins 代理 JAR，确保 Jenkins 主节点 URL 是可访问的</span><br><span class="hljs-comment"># 此命令需在主节点 URL 可用的情况下执行，或者手动复制 agent.jar 到工作目录下</span><br><span class="hljs-keyword">COPY</span><span class="language-bash"> ./agent.jar /home/jenkins/agent.jar</span><br><br><span class="hljs-comment"># 容器启动时默认执行的命令</span><br><span class="hljs-keyword">CMD</span><span class="language-bash"> java -jar /home/jenkins/agent.jar \</span><br><span class="language-bash">    -jnlpUrl <span class="hljs-variable">$&#123;JENKINS_URL&#125;</span>/computer/<span class="hljs-variable">$&#123;JENKINS_NODE_NAME&#125;</span>/slave-agent.jnlp \</span><br><span class="language-bash">    -secret <span class="hljs-variable">$&#123;JENKINS_SECRET&#125;</span> \</span><br><span class="language-bash">    -workDir <span class="hljs-variable">$&#123;JENKINS_AGENT_WORKDIR&#125;</span></span><br></code></pre></td></tr></table></figure></li><li><p>运行slave</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker build . -t jenkins-slave:2.0.0<br>docker run --name jenkins-agent --detach \<br>--network jenkins --env JENKINS_MASTER=http://172.18.0.2:8080 \<br>--env JENKINS_AGENT_NAME=test-slave --env JENKINS_SECRET=1735b637d6de619d0396e3198fdc418da5e5cfd35c5cbff70f222821ce85dfdc \<br>--env JENKINS_AGENT_WORKDIR=/home/jenkins/agent \<br>jenkins-slave:2.0.0<br></code></pre></td></tr></table></figure><p>稍等一会,刷新下主节点,显示slave已经在线</p></li></ol><h1 id="凭证"><a href="#凭证" class="headerlink" title="凭证"></a>凭证</h1><blockquote><p>Jenkins的凭证都存放在JENKINS_HOME底下,里面有几个子目录:</p><ul><li><p>secrets: 加密用的密钥</p></li><li><p>credentials.xml: 系统范围的凭证</p></li><li><p>users&#x2F;<username>&#x2F;credentials.xml: 每个用户的私有凭证</username></p></li></ul><p>安全地管理这些目录和文件的权限</p></blockquote><h2 id="凭证的范围"><a href="#凭证的范围" class="headerlink" title="凭证的范围"></a>凭证的范围</h2><ul><li>全局: Jenkins 实例中的所有项目可用，除非在域中做了特定的限制</li><li>系统: 只允许jenkins自身以及它的节点使用</li><li>用户: 顾名思义,只能该用户使用</li><li>folder: 只能在folder中的pipeline使用,要先创建folder再创建凭证</li></ul><h2 id="凭证域"><a href="#凭证域" class="headerlink" title="凭证域"></a>凭证域</h2><p>对凭证进行<code>逻辑分组</code>的机制.将凭证划分到不同的环境或上下文,你就可以根据凭证将要使用的地方来限制凭证的可见性和可用性.</p><blockquote><p>例如,创建不同的域来区分生产和测试环境的凭证</p></blockquote><p>每个域包含一套规则,定义凭证的可用性.jenkins总是有一个默认的<code>全局域</code>,该域没有任何规范,意味着可以被jenkins的任何东西去使用</p><blockquote><p>例如可以为域配置一组说明符,只有满足这些条件,相应域的凭证才会被提供.</p><p><img src="https://cdn.jsdelivr.net/gh/occultagg/blog-pics/hexo-blog/image-20240328154342393.png" srcset="/img/loading.gif" lazyload alt="image-20240328154342393"></p><p>比如上图就表示,只有jenkins的任务需要访问*.prod.example.com的时候才能用这个域的凭证</p></blockquote><h1 id="授权策略"><a href="#授权策略" class="headerlink" title="授权策略"></a>授权策略</h1><p>Jenkins对于用户的授权提供了多种策略:</p><p>路径: dashboard –&gt; 系统管理 –&gt; 全局系统配置</p><ul><li><p>任何人可以做任何事: 顾名思义</p></li><li><p>登录用户可以做任何事: 一旦用户登录就可以做任何事</p></li><li><p>安全矩阵(Matrix-based security):</p><p><img src="https://cdn.jsdelivr.net/gh/occultagg/blog-pics/hexo-blog/image-20240326222025486.png" srcset="/img/loading.gif" lazyload alt="image-20240326222025486"></p></li><li><p>项目矩阵: 与安全矩阵类似,但是它可以针对项目授权</p><p><img src="https://cdn.jsdelivr.net/gh/occultagg/blog-pics/hexo-blog/image-20240326222849457.png" srcset="/img/loading.gif" lazyload alt="image-20240326222849457"></p></li></ul><h1 id="工作总结"><a href="#工作总结" class="headerlink" title="工作总结"></a>工作总结</h1><h2 id="凭证的处理"><a href="#凭证的处理" class="headerlink" title="凭证的处理"></a>凭证的处理</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs groovy"># withCredentials()获取凭证,指定环境变量名赋值<br>stage&#123;<br>    withCredentials([usernamPassword(<span class="hljs-attr">credentialsId:</span> <span class="hljs-string">&#x27;XXX&#x27;</span>, <span class="hljs-attr">passwordVariable:</span> <span class="hljs-string">&#x27;PASSWORD&#x27;</span>, <span class="hljs-attr">usernamVariable:</span> <span class="hljs-string">&#x27;USER&#x27;</span>)])&#123;<br>        git_account = env.USER<br>        git_password = env.PASSWORD<br>    &#125;  <br>&#125;<br><br><br># credentials()获取凭证,通过固定的环境变量名使用,可以在environment&#123;&#125;中获取<br>pipeline&#123;<br>    agent any<br>    environment &#123;<br>        BITBUCKET_COMMON_CREDS = credentials(<span class="hljs-string">&#x27;peter-cred&#x27;</span>)<br>    &#125;<br>    stages &#123;<br>        stage (<span class="hljs-string">&#x27;test&#x27;</span>) &#123;<br>            steps &#123;<br>                echo $BITBUCKET_COMMON_CREDS_USR # 固定格式&lt;env_name&gt;_[USR|PSW]<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="groovy变量-环境变量"><a href="#groovy变量-环境变量" class="headerlink" title="groovy变量&#x2F;环境变量"></a>groovy变量&#x2F;环境变量</h2><p>groovy定义的变量不可以直接在其他脚本（例如sh）中使用，可以把它转为环境变量</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs groovy">steps &#123;<br>    script &#123;<br>        <span class="hljs-keyword">def</span> curTime = <span class="hljs-keyword">new</span> Data().format(<span class="hljs-string">&#x27;yyyyMMddHHmmss&#x27;</span>)<br>        <span class="hljs-keyword">def</span> model_version = <span class="hljs-string">&#x27;abc&#x27;</span> + curTime[<span class="hljs-number">0.</span><span class="hljs-number">.7</span>]<br>        <span class="hljs-keyword">def</span> model_file = model_version + <span class="hljs-string">&#x27;.zip&#x27;</span><br>        <span class="hljs-comment">//使用脚本式将变量转为环境变量</span><br>        env.model_file = model_file<br>        sh <span class="hljs-string">&quot;echo $&#123;model_file&#125;&quot;</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="html-description"><a href="#html-description" class="headerlink" title="html description"></a>html description</h2><p>example:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;border:1px solid black;border-collapse: collapse;cellpadding=25&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">th</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;border:1px solid black;padding:5px;&quot;</span>&gt;</span>aaa<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">th</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;border:1px solid black;padding:5px;&quot;</span>&gt;</span>bbb<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="工作坑点"><a href="#工作坑点" class="headerlink" title="工作坑点"></a>工作坑点</h2><ol><li>假如通过jenkins跑云资源的terraform，要注意你要操作的是不是就是你正在跑的jenkins本身，因为有些人会把操作jenkins节点资源的pepeline跑在那个jenkins上</li></ol></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/" class="category-chain-item">工作笔记</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/JenkinsFile/" class="print-no-link">#JenkinsFile</a> <a href="/tags/Devops/" class="print-no-link">#Devops</a></div></div><div class="license-box my-3"><div class="license-title"><div>JenkinsFile 工作总结</div><div>http://example.com/2023/10/01/jenkinsfile/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>Peter Pan</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2023年10月1日</div></div><div class="license-meta-item"><div>许可协议</div><div><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2023/12/25/python-function/" title="Python笔记-函数参数"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">Python笔记-函数参数</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2023/05/21/k8s-istio-2/" title="k8s进阶:Istio流量管理"><span class="hidden-mobile">k8s进阶:Istio流量管理</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">总访问量 <span id="busuanzi_value_site_pv"></span> 次 </span><span id="busuanzi_container_site_uv" style="display:none">总访客数 <span id="busuanzi_value_site_uv"></span> 人</span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>