<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="https://cdn.jsdelivr.net/gh/occultagg/blog-pics/hexo-blog/202206120024516.ico"><link rel="icon" href="https://cdn.jsdelivr.net/gh/occultagg/blog-pics/hexo-blog/202206120024516.ico"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#2f4154"><meta name="author" content="Peter Pan"><meta name="keywords" content=""><meta name="description" content="基础教程tetrate发行版有一个简单的istio入门教程,感觉还不错,视频+文字,中文字幕. 传送门,懒得在官方文档里面跳来跳去的可以直接看这个. 本文为基于该教程作的一些记录,基于istioctl+operator的部署方式,版本为1.10.3 发现选择器: Discovery selectorsIstio:1.10引入的新功能.   默认情况下,istio会watch和update集群中所"><meta property="og:type" content="article"><meta property="og:title" content="k8s进阶:Istio流量管理"><meta property="og:url" content="http://example.com/2023/05/21/k8s-istio-2/index.html"><meta property="og:site_name" content="Any &amp; Nothing"><meta property="og:description" content="基础教程tetrate发行版有一个简单的istio入门教程,感觉还不错,视频+文字,中文字幕. 传送门,懒得在官方文档里面跳来跳去的可以直接看这个. 本文为基于该教程作的一些记录,基于istioctl+operator的部署方式,版本为1.10.3 发现选择器: Discovery selectorsIstio:1.10引入的新功能.   默认情况下,istio会watch和update集群中所"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/occultagg/blog-pics/hexo-blog/202304170944993.png"><meta property="article:published_time" content="2023-05-21T08:09:38.000Z"><meta property="article:modified_time" content="2024-12-11T09:52:23.056Z"><meta property="article:author" content="Peter Pan"><meta property="article:tag" content="k8s"><meta property="article:tag" content="istio"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/occultagg/blog-pics/hexo-blog/202304170944993.png"><meta name="referrer" content="no-referrer-when-downgrade"><title>k8s进阶:Istio流量管理 - Any &amp; Nothing</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"example.com",root:"/",version:"1.9.7",typing:{enable:!0,typeSpeed:70,cursorChar:"|",loop:!1,scope:["home"]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!0,offset_factor:2},web_analytics:{enable:!0,follow_dnt:!0,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml",include_content_in_search:!0};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Any & Nothing" type="application/atom+xml">
</head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Any &amp; Nothing</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/" target="_self"><i class="iconfont icon-home-fill"></i> <span>首页</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/" target="_self"><i class="iconfont icon-archive-fill"></i> <span>归档</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/" target="_self"><i class="iconfont icon-category-fill"></i> <span>分类</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/" target="_self"><i class="iconfont icon-tags-fill"></i> <span>标签</span></a></li><li class="nav-item"><a class="nav-link" href="/about/" target="_self"><i class="iconfont icon-user-fill"></i> <span>关于</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle">k8s进阶:Istio流量管理</span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2023-05-21 16:09" pubdate>2023年5月21日 下午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 3.6k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 31 分钟</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 id="seo-header">k8s进阶:Istio流量管理</h1><div class="markdown-body"><p><img src="https://cdn.jsdelivr.net/gh/occultagg/blog-pics/hexo-blog/202304170944993.png" srcset="/img/loading.gif" lazyload></p><h1 id="基础教程"><a href="#基础教程" class="headerlink" title="基础教程"></a>基础教程</h1><p>tetrate发行版有一个简单的istio入门教程,感觉还不错,视频+文字,中文字幕.<br><a target="_blank" rel="noopener" href="https://academy.tetrate.io/collections/zh">传送门</a>,懒得在官方文档里面跳来跳去的可以直接看这个.</p><p>本文为基于该教程作的一些记录,基于istioctl+operator的部署方式,版本为1.10.3</p><h1 id="发现选择器-Discovery-selectors"><a href="#发现选择器-Discovery-selectors" class="headerlink" title="发现选择器: Discovery selectors"></a>发现选择器: Discovery selectors</h1><p>Istio:1.10引入的新功能.</p><blockquote><p>默认情况下,istio会watch和update集群中所有的服务,也就是所有集群中的服务都会被记录并维护在istiod的服务发现表中.</p><p>默认情况下所有envoy代理的配置方式是,他们可以到达服务网格中的每个工作负载,并接受与其相关的所有端口的流量.</p><p>例如有两个服务,foo和bar,尽管他们不需要相互通信,但是他们的端点都会被记录在对方的已发现端点列表中.</p><p>当服务数量越来越大,将不可避免地导致某程度的slow down.</p></blockquote><p>discovery selectors就是为了解决这个问题存在的,配置在mesh层,可以限制被istio观察和处理的项目数量.</p><p>同样有类似功能的还有一个叫sidecar resource的解决方案.</p><h2 id="一些命令"><a href="#一些命令" class="headerlink" title="一些命令"></a>一些命令</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">列出某foo命名空间的foo工作负载的服务发现表</span><br>istioctl proxy-config endpoints deploy/foo.foo<br></code></pre></td></tr></table></figure><h3 id="开启功能"><a href="#开启功能" class="headerlink" title="开启功能"></a>开启功能</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl edit istiooperators.install.istio.io -n istio-system installed-state<br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">install.istio.io/v1alpha1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">IstioOperator</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">istio-system</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">istio-demo</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">meshConfig:</span><br>    <span class="hljs-attr">discoverySelectors:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">matchLabels:</span><br>        <span class="hljs-attr">env:</span> <span class="hljs-string">test</span> <span class="hljs-comment">#只watch和update匹配这个标签的命名空间的工作负载</span><br></code></pre></td></tr></table></figure><h1 id="可观测性-遥测和日志"><a href="#可观测性-遥测和日志" class="headerlink" title="可观测性:遥测和日志"></a>可观测性:遥测和日志</h1><ul><li><p>监控: prometheus</p></li><li><p>追踪: zipkin</p></li><li><p>数据可视化: grafana</p></li></ul><blockquote><p>为了使grafana和kiali工作,需要先安装prometheus addon</p></blockquote><p>istio会生成三种类型的遥测数据:指标度量(metric), 分布式追踪, 访问日志.</p><p>envoy代理负责收集指标.</p><h2 id="Metric-指标"><a href="#Metric-指标" class="headerlink" title="Metric:指标"></a>Metric:指标</h2><p>istio基于四个黄金信号生成指标:</p><ul><li><p>延迟: 分为成功和失败请求的延迟</p></li><li><p>流量: 用于衡量系统需求,如每秒http请求数,并发会话,每秒检索量等</p></li><li><p>错误: 衡量失败请求的比率</p></li><li><p>饱和度: 衡量一个服务中最紧张的资源有多满.例如线程池利用率</p></li></ul><h2 id="代理级指标"><a href="#代理级指标" class="headerlink" title="代理级指标"></a>代理级指标</h2><p>可以从每个envoy代理实例的<code>/stats</code>查看代理级指标</p><h2 id="服务级指标"><a href="#服务级指标" class="headerlink" title="服务级指标"></a>服务级指标</h2><p>涵盖前面提到的四个黄金信号.这些指标可以让我们能够监控服务于服务之间的通讯.此外,istio还提供了一组仪表盘,我们可以根据这些指标监控服务行为.</p><p>默认情况下,istio的标准指标集会被导出到Prometheus.</p><h2 id="控制平面度量"><a href="#控制平面度量" class="headerlink" title="控制平面度量"></a>控制平面度量</h2><p>istio的控制平面也会有指标,用于监控istio的控制平面,[指标列表](<a target="_blank" rel="noopener" href="https://istio.io/latest/docs/reference/commands/pilot-discovery/#metrics">Istio &#x2F; pilot-discovery</a>).</p><p>包括: 入站&#x2F;出站监听器的数量,没有实例的集群数量,被拒绝或被忽略的配置等指标</p><h2 id="Prometheus"><a href="#Prometheus" class="headerlink" title="Prometheus"></a>Prometheus</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">使用安装包的示例配置文件安装</span><br>kubectl apply -f samples/addons/prometheus.yaml<br><span class="hljs-meta prompt_">#</span><span class="language-bash">打开dashboard,默认监听locahost</span><br>istioctl dashboard prometheus --address 11.0.1.121<br><span class="hljs-meta prompt_">#</span><span class="language-bash">暴露先前创建的deployment my-nginx并请求</span><br>kubectl expose deployment my-nginx  --port 80 --target-port 80 --name my-nginx-svc --type=ClusterIP<br>curl http://&lt;cluster-ip&gt;<br></code></pre></td></tr></table></figure><p>然后在prometheus的dashboard中搜索<code>istio_requests_total</code>就能看到刚刚的请求产生了1个请求数</p><h2 id="Grafana"><a href="#Grafana" class="headerlink" title="Grafana"></a>Grafana</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">使用安装包的示例配置文件安装</span><br>kubectl apply -f samples/addons/grafana.yaml<br><span class="hljs-meta prompt_">#</span><span class="language-bash">打开dashboard,默认监听locahost</span><br>istioctl dashboard grafana --address 11.0.1.121<br></code></pre></td></tr></table></figure><p>注意: 这里的配置不建议在生产中运行,因为它没有经过性能和安全方面的调整</p><p>默认已经在grafna配置了一些仪表盘:</p><ul><li><p>istio控制平面仪表盘:control plane dashboard,展示控制平面的资源使用情况(mem,cpu,disk,go goutines),以及ilot,envoy和webhook信息.</p></li><li><p>网格仪表盘: mesh dashboard,提供网格中运行的所有服务的概览,包括全局请求数,成功率以及错误响应数.</p></li><li><p>性能仪表盘: performence,展示istio主要组件在稳定负载下的资源利用率</p></li><li><p>服务仪表盘: service,展示网格中的服务的细节,比如请求量,成功率,持续时间,以及显示按来源和响应代码,持续时间和大小的传入请求的详细图表</p></li><li><p>wash扩展: wash extension:显示于webassembly模块有关的指标,通过这个仪表盘,我们可以监控活动的和创建的wash虚拟机和获取删除wash模块和代理资源使用的数据.</p></li><li><p>istio工作负载: workload:关于工作负载的指标</p></li></ul><h2 id="分布式追踪"><a href="#分布式追踪" class="headerlink" title="分布式追踪"></a>分布式追踪</h2><p>是一种检测微服务apps的方法.</p><blockquote><p>当一个请求进入服务网格时,Envoy都会生成一个唯一的请求ID和追踪信息,并存储在http请求头中,任何apps都可以将这些header转发给它缩调用的其他服务,这样就可以在震哥哥系统中创建一个完整的追踪.</p></blockquote><h3 id="span"><a href="#span" class="headerlink" title="span"></a>span</h3><p>分布式追踪是一个<code>跨度(span)</code>的集合.</p><blockquote><p>每当有请求流经不同的系统组件时,每个组件都会产生一个跨度.每个跨度包含:</p><ul><li><p>一个名称</p></li><li><p>一组&lt;标签tag&gt;:&lt;日志log&gt;的键值对</p></li><li><p>以及一个span context,跨度上下文</p></li></ul></blockquote><p>单个跨度,识别跨度,父跨度和追踪ID的上下文头一起被发送到一个叫做采集器的组件,采集器负责对数据进行验证,索引和存储.</p><p>当请求流经Envoy代理时,Envoy代理会自动生成各个跨度.但是,envoy只能在边缘收集跨度,任何如果需要的额外的跨度,由我们的app需要负责生成.</p><p>我们的app还要确保我们在调用其他服务时转发追踪header.这样,各个跨度才能正确地关联到一个单一的追踪中.</p><h3 id="Zipkin"><a href="#Zipkin" class="headerlink" title="Zipkin"></a>Zipkin</h3><blockquote><p><a target="_blank" rel="noopener" href="https://zipkin.io/">Zipkin</a>是一款开源的分布式实时数据追踪系统（Distributed Tracking System），基于 Google Dapper的论文设计而来，由 Twitter 公司开发贡献。其主要功能是聚集来自各个异构系统的实时监控数据。分布式跟踪系统还有其他比较成熟的实现，例如：Naver的Pinpoint、Apache的HTrace、阿里的鹰眼Tracing、京东的Hydra、新浪的Watchman，美团点评的CAT，skywalking等。</p></blockquote><p>上面说到,为了让我们的服务参与分布式追踪,我们需要在进行任何下游服务调用时传播http header.</p><p>但是尽管所有请求都经过istio sidecar,istio没有办法将出站和入站请求关联起来,而zipkin可以利用在服务之间传播的header,将这些请求拼接起来,形成完整的追踪.</p><p>istio依赖B3跟踪头(以x-b3开头的header)和envoy生成的请求id(x-request-id),通常做法是我们的应用程序需要捕获传入请求的以下header并将他们包含在所有从你的app发送出去的请求中:</p><ul><li><p>x-request-id</p></li><li><p>x-b3-traceid</p></li><li><p>x-b3-spanid</p></li><li><p>x-b3-parentspanid</p></li><li><p>x-b3-sampled</p></li><li><p>x-b3-flags</p></li><li><p>b3</p></li><li><p>如果使用lightstep,还需要转发x-ot-span-context</p></li></ul><p>zipkin的安装运行方式于上面的addon类似,在samples&#x2F;addons&#x2F;extras中有示例配置yaml文件.</p><h3 id="Jaeger"><a href="#Jaeger" class="headerlink" title="Jaeger"></a>Jaeger</h3><p>也是一个分布式追踪平台,它与zipkin的对比可以看看这篇文章: <a target="_blank" rel="noopener" href="https://www.kubernetes.org.cn/8611.html">Jaeger与Zipkin：分布式跟踪平台该选谁_Kubernetes中文社区</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl apply - samples/addons/jaeger.yaml<br>istioctl dashboard jaeger --address 11.0.1.121<br></code></pre></td></tr></table></figure><h2 id="Kiali"><a href="#Kiali" class="headerlink" title="Kiali"></a>Kiali</h2><p><a target="_blank" rel="noopener" href="https://kiali.io/">Kiali</a>是一个基于istio的service mesh管理控制台.提供dashboard,可视化,允许我们通过web界面配置,验证,操作网格.它通过推断流量拓扑来显示服务网格,并显示网格的健康状况.</p><p>它提供强大的验证,详细的指标,grafana访问,以及于jaeger的分布式追踪的强大集成.</p><p>安装部署与上面其他addon类似,示例配置文件在&#x2F;spamles&#x2F;addon&#x2F;kiali.yaml</p><p>如果遇到报错:<code>unable to recognize &quot;samples/addons/kiali.yaml&quot;: no matches for kind &quot;MonitoringDashboard&quot; in version &quot;monitoring.kiali.io/v1alpha1&quot;</code>,重新执行一次apply即可,原因是在安装CRD(自定义资源定义)和该CRD定义的资源时,会存在一个匹配条件.</p><h1 id="流量管理"><a href="#流量管理" class="headerlink" title="流量管理"></a>流量管理</h1><p>在<a target="_blank" rel="noopener" href="https://anthing.cn/2023/03/21/k8s-istio/#%E5%AE%9E%E9%AA%8C">k8s进阶:Istio - Any &amp; Nothing</a> 一文中我们已经根据官方文档操作了一遍流量管理的功能,这里再进行一些复习或查漏补缺.</p><h2 id="gateway"><a href="#gateway" class="headerlink" title="gateway"></a>gateway</h2><p>默认安装了两个gateway: ingressgateway和engressgateway</p><p>入口网关接受入站连接,出口网关接受从集群出去的连接.网关都运行一个envoy代理,他们再网格的边缘作为负载均衡器运行.</p><p>默认使用的是loadbalance类型的svc,私有环境没有外置的负载均衡器可以通过以下方式获取它的nodeIP和nodePort:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">export</span> INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath=<span class="hljs-string">&#x27;&#123;.spec.ports[?(@.name==&quot;http2&quot;)].nodePort&#125;&#x27;</span>)<br><span class="hljs-built_in">export</span> SECURE_INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath=<span class="hljs-string">&#x27;&#123;.spec.ports[?(@.name==&quot;https&quot;)].nodePort&#125;&#x27;</span>)<br><span class="hljs-built_in">export</span> INGRESS_HOST=$(kubectl get po -l istio=ingressgateway -n istio-system -o jsonpath=<span class="hljs-string">&#x27;&#123;.items[0].status.hostIP&#125;&#x27;</span>)<br><span class="hljs-built_in">export</span> GATEWAY_URL=<span class="hljs-variable">$INGRESS_HOST</span>:<span class="hljs-variable">$INGRESS_PORT</span><br><span class="hljs-comment">#这就是你的gateway访问地址</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$GATEWAY_URL</span>&quot;</span><br></code></pre></td></tr></table></figure><p>有了网关,我们还需要配置网关资源(Gateway)来配置网关.</p><blockquote><p>这两个东西叫法上容易叫混:</p><ul><li><p>网关,ingressgateway和engressgateway部署在网格边缘,可以叫做<code>网关控制器</code>或者叫<code>网关代理</code></p></li><li><p>网关资源,Gateway,是用来配置网关控制器的,也可以叫<code>网关配置</code></p></li></ul></blockquote><p>下面是一个例子:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.istio.io/v1alpha3</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Gateway</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">my-gateway</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">istio:</span> <span class="hljs-string">ingressgateway</span> <span class="hljs-comment"># use istio default controller</span><br>  <span class="hljs-attr">servers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span><br>      <span class="hljs-attr">number:</span> <span class="hljs-number">80</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">http</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">HTTP</span><br>    <span class="hljs-attr">hosts:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">dev.example.com</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">test.example.com</span>   <br>    <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;*&quot;</span> <span class="hljs-comment">#支持通配符</span><br></code></pre></td></tr></table></figure><p>网关控制器部署时默认有个istio&#x3D;ingressgateway的标签,网关配置根据这个标签来选择它使用的网关控制器.</p><p>hosts是一个过滤器,只有以符合它配置规则为目的地的流量才能允许通过.</p><h1 id="简单路由"><a href="#简单路由" class="headerlink" title="简单路由"></a>简单路由</h1><h2 id="virtual-service"><a href="#virtual-service" class="headerlink" title="virtual service"></a>virtual service</h2><p>使用virtual service实现路由,通过virtual service我们可以定义流量路由规则,并在客户端连接服务时应用这些规则.例如上一篇文章配置的将流量路由到不同version的pod.下面再举一个例子:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.istio.io/v1alpha3</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">VirtualService</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">customers-route</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">hosts:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">customers.default.svc.cluster.local</span><br>  <span class="hljs-attr">gateway:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">my-gateway</span><br>  <span class="hljs-attr">http:</span> <br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">customers-v1-route</span><br>    <span class="hljs-attr">route:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">destination:</span> <br>        <span class="hljs-attr">host:</span> <span class="hljs-string">customers.default.svc.cluster.local</span><br>        <span class="hljs-attr">subset:</span> <span class="hljs-string">v1</span><br>      <span class="hljs-attr">weight:</span> <span class="hljs-number">70</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">customers-v2-route</span><br>    <span class="hljs-attr">route:</span>  <br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">destination:</span><br>        <span class="hljs-attr">host:</span> <span class="hljs-string">customers.default.svc.cluster.local</span><br>        <span class="hljs-attr">subset:</span> <span class="hljs-string">v2</span><br>      <span class="hljs-attr">weight:</span> <span class="hljs-number">30</span><br></code></pre></td></tr></table></figure><p>在这个例子中,我们定义流量发送到customers.default.svc.cluster.local这个kubernetes的SVC,这个SVC下绑定了两个版本的pod,通过virtual service定义70%流量去到v1,30%去到v2.</p><p>http是一个包含http流量的路由规则的有序列表.</p><p>destination是指服务注册表中的一个服务,也是路由规则处理后请求将被发送的目的地.istio的服务注册表上记录的都是合法值,也包括通过serviceEntry手动添加的合法服务.</p><p>gateway字段则用来绑定对应的网关资源,有点类似ingressclass和ingress的关系</p><h2 id="virtual-service和gateway的hosts匹配关系"><a href="#virtual-service和gateway的hosts匹配关系" class="headerlink" title="virtual service和gateway的hosts匹配关系"></a>virtual service和gateway的hosts匹配关系</h2><table><thead><tr><th>gateway hosts</th><th>virtualservice hosts</th><th>action</th></tr></thead><tbody><tr><td>*</td><td>customers.default.svc.cluster.local</td><td>流量会直接通过virtual service发送到目的地customers,因为gateway允许了所有</td></tr><tr><td>customers.default.svc.cluster.local</td><td>customers.default.svc.cluster.local</td><td>host匹配,流量将被发送</td></tr><tr><td>hello.com</td><td>customers.default.svc.cluster.local</td><td>hosts不匹配,无效</td></tr><tr><td>hello.com</td><td>[“hello.com”, “customers.default.svc.cluster.local”]</td><td>只会允许hello.com,这依然是一个有效配置,因为virtual service可以连接到第二个网关,该网关的hosts包含*.default.svc.cluster.local即可</td></tr></tbody></table><h2 id="subset-和-destination-rule"><a href="#subset-和-destination-rule" class="headerlink" title="subset 和 destination rule"></a>subset 和 destination rule</h2><p>目的地指的是不同子集(subset)或服务版本.通过subset,我们可以识别应用程序的不同变体.比如version1和version2.对应于我们对应服务的两个不同版本.</p><p>每个子集都使用label去确定那些pod包含在子集中.</p><p>subset在destination rule中声明,这里前文就有例子.</p><p>另外destination rule还可以配置流量策略.</p><h3 id="destination-rule的流量策略"><a href="#destination-rule的流量策略" class="headerlink" title="destination rule的流量策略"></a>destination rule的流量策略</h3><h4 id="负载均衡策略"><a href="#负载均衡策略" class="headerlink" title="负载均衡策略"></a>负载均衡策略</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.istio.io/v1alpha3</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">DestinationRule</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">customer-destination</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">host:</span> <span class="hljs-string">customers.default.svc.cluster.local</span><br>  <span class="hljs-attr">trafficPolicy:</span><br>    <span class="hljs-attr">loadBalancer:</span><br>      <span class="hljs-attr">simple:</span> <span class="hljs-string">ROUND_ROBIN</span><br>  <span class="hljs-attr">subsets:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">v1</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">version:</span> <span class="hljs-string">v1</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">v2</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">version:</span> <span class="hljs-string">v2</span><br></code></pre></td></tr></table></figure><p>还可以基于哈希的负载均衡,并基于http头,cookies或其他请求属性实现亲和性,例如:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">trafficPolicy:</span><br>  <span class="hljs-attr">loadBalancer:</span><br>    <span class="hljs-attr">consistentHash:</span> <span class="hljs-comment">#基于hash的负载均衡</span><br>      <span class="hljs-attr">httpCookie:</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">location</span> <span class="hljs-comment">#使用cookie中的location实现会话亲和</span><br>        <span class="hljs-attr">ttl:</span> <span class="hljs-string">4s</span><br></code></pre></td></tr></table></figure><h4 id="连接池配置"><a href="#连接池配置" class="headerlink" title="连接池配置"></a>连接池配置</h4><p>应用于上游服务的每个主机,用它来控制连接量:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">host:</span> <span class="hljs-string">myredissrv.prod.svc.cluster.local</span><br>  <span class="hljs-attr">trafficPolicy:</span><br>    <span class="hljs-attr">connectionPool:</span><br>      <span class="hljs-attr">http:</span><br>        <span class="hljs-attr">http2MaxRequests:</span> <span class="hljs-number">50</span><br></code></pre></td></tr></table></figure><h4 id="异常点检测-断路器-熔断"><a href="#异常点检测-断路器-熔断" class="headerlink" title="异常点检测&#x2F;断路器&#x2F;熔断"></a>异常点检测&#x2F;断路器&#x2F;熔断</h4><p>跟踪<code>上游</code>服务中每个主机(pod)的状态,如果一个主机开始返回错误,它就会在预定的时间内被负载均衡池中弹出.</p><p>对于TCP服务,envoy将连接超时或失败计算判定为错误.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">trafficPolicy:</span><br>  <span class="hljs-attr">connectionPool:</span><br>    <span class="hljs-attr">http:</span><br>      <span class="hljs-attr">http2MaxRequests:</span> <span class="hljs-number">500</span> <span class="hljs-comment">#限制500并发http2请求</span><br>      <span class="hljs-attr">maxRequestsPerConnection:</span> <span class="hljs-number">10</span> <span class="hljs-comment">#每个连接不超过10个请求</span><br>  <span class="hljs-attr">outlierDetection:</span><br>    <span class="hljs-attr">interval:</span> <span class="hljs-string">5m</span> <span class="hljs-comment">#每5分钟扫描一次上游主机(pod)</span><br>    <span class="hljs-attr">consecutiveError:</span> <span class="hljs-number">10</span> <span class="hljs-comment">#如果任何一个主机连续失败10次</span><br>    <span class="hljs-attr">bashEjectionTime:</span> <span class="hljs-string">10m</span> <span class="hljs-comment">#就把它弹出10分钟</span><br></code></pre></td></tr></table></figure><h4 id="客户端TLS设置"><a href="#客户端TLS设置" class="headerlink" title="客户端TLS设置"></a>客户端TLS设置</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">trafficPolicy:</span><br>  <span class="hljs-attr">tls:</span><br>    <span class="hljs-attr">mode:</span> <span class="hljs-string">MUTUAL</span> <span class="hljs-comment">#mTLS</span><br>    <span class="hljs-attr">clientCertificate:</span> <span class="hljs-string">/etc/certs/cert.pem</span><br>    <span class="hljs-attr">privateKey:</span> <span class="hljs-string">/etc/certs/key.pem</span><br>    <span class="hljs-attr">caCertificates:</span> <span class="hljs-string">/etc/certs/ca.pem</span><br></code></pre></td></tr></table></figure><p>其他支持的TLS模式有:</p><ul><li><p>DISABLE: 没有TLS连接</p></li><li><p>SIMPLE: 在上游端点发起TLS连接</p></li><li><p>ISTIO_MUTUAL: 类似MUTUAL但使用的istio的mTLS证书</p></li></ul><h4 id="端口流量策略"><a href="#端口流量策略" class="headerlink" title="端口流量策略"></a>端口流量策略</h4><p>可以根据不同的端口配置不同的流量策略</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">trafficPolicy:</span><br>  <span class="hljs-attr">portLevelSettings:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span><br>      <span class="hljs-attr">number:</span> <span class="hljs-number">80</span><br>    <span class="hljs-attr">loadBanlancer:</span><br>      <span class="hljs-attr">simple:</span> <span class="hljs-string">LEAST_CONN</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span><br>      <span class="hljs-attr">number:</span> <span class="hljs-number">8000</span><br>    <span class="hljs-attr">loadBalancer:</span><br>      <span class="hljs-attr">simple:</span> <span class="hljs-string">ROUND_ROBIN</span><br></code></pre></td></tr></table></figure><h1 id="弹性-Resiliency"><a href="#弹性-Resiliency" class="headerlink" title="弹性:Resiliency"></a>弹性:Resiliency</h1><p>弹性的目的是故障发生后将服务恢复到一个完全正常的状态.也就是failover.</p><p>服务的可用关键是在提出服务请求时使用超时(timeout)和重试(retry)策略.可以在istio的virtual service上配置这两者.下面是两个例子.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">...</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">route:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">destination:</span> <span class="hljs-string">customers.default.svc.cluster.local</span><br>      <span class="hljs-attr">host:</span> <br>      <span class="hljs-attr">subset:</span> <span class="hljs-string">v1</span><br>   <span class="hljs-attr">timeout:</span> <span class="hljs-string">10s</span> <span class="hljs-comment">#设置10s超时</span><br><span class="hljs-string">...</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">route:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">destination:</span><br>      <span class="hljs-attr">host:</span> <br>      <span class="hljs-attr">subset:</span> <span class="hljs-string">v1</span><br>  <span class="hljs-attr">retries:</span><br>    <span class="hljs-attr">attempts:</span> <span class="hljs-number">10</span> <span class="hljs-comment">#尝试次数为10</span><br>    <span class="hljs-attr">perTryTimeout:</span> <span class="hljs-string">2s</span> <span class="hljs-comment">#每次超时时间为2s</span><br>    <span class="hljs-comment">#重试任何连接超时(connect-failure)或服务不响应(reset)的失败请求</span><br>    <span class="hljs-attr">retryOn:</span> <span class="hljs-string">connect-failure,reset</span><br><span class="hljs-string">...</span><br></code></pre></td></tr></table></figure><p>注意: 如果同时设置超时和重试,超时值是请求等待的最长时间,比如如果我们在上面的第二个例子中设置了超时10s,那么10s一过,即使重试策略还剩下一些尝试,也会终止直接判断服务不可用.</p><blockquote><p>重试策略可以更加细化:</p><p>例如我们可以只在上游服务器返回5xx错误或者网关错误(502,503,504)时重试,或者在请求头中指定可重试的状态代码.</p><p>重试和超时都发生在客户端.</p><p>当envoy重试请求时,最初失败并导致重试的端点就不再包含在负载均衡池中,例如:</p><p>假设kubernetes有3个端点(pod),其中一个失败了,并出现了可重试的错误代码,Envoy重试请求时,将不会向原来的端点重新发送,而只发送给另外两个没有失败的端点的一个.</p></blockquote><h1 id="故障注入-failure-injection"><a href="#故障注入-failure-injection" class="headerlink" title="故障注入: failure injection"></a>故障注入: failure injection</h1></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/" class="category-chain-item">技术笔记</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/k8s/" class="print-no-link">#k8s</a> <a href="/tags/istio/" class="print-no-link">#istio</a></div></div><div class="license-box my-3"><div class="license-title"><div>k8s进阶:Istio流量管理</div><div>http://example.com/2023/05/21/k8s-istio-2/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>Peter Pan</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2023年5月21日</div></div><div class="license-meta-item"><div>许可协议</div><div><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2023/10/01/jenkinsfile/" title="JenkinsFile 工作总结"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">JenkinsFile 工作总结</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2023/05/21/k8s-ingress/" title="k8s进阶:Ingress-Nginx"><span class="hidden-mobile">k8s进阶:Ingress-Nginx</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">总访问量 <span id="busuanzi_value_site_pv"></span> 次 </span><span id="busuanzi_container_site_uv" style="display:none">总访客数 <span id="busuanzi_value_site_uv"></span> 人</span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>