<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="https://cdn.jsdelivr.net/gh/occultagg/blog-pics/hexo-blog/202206120024516.ico"><link rel="icon" href="https://cdn.jsdelivr.net/gh/occultagg/blog-pics/hexo-blog/202206120024516.ico"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#2f4154"><meta name="author" content="Peter Pan"><meta name="keywords" content=""><meta name="description" content="中文文档 原理 Ansible的名字来自小说&lt;安德的游戏&gt;是一个跨越时空的通讯工具  Ansible本质上只是一个框架,用python开发,实际通过它的库实现功能,其中有三个关键库:  Paramiko: Python对ssh的实现 PyYaml: 解析和生成yaml jinjia2: 用于模板的生成，在使用 template 模块自动生成文件时特别有用  特性:  基于python"><meta property="og:type" content="article"><meta property="og:title" content="ansible-必知必会"><meta property="og:url" content="http://example.com/2024/02/22/ansible-mustknow/index.html"><meta property="og:site_name" content="Any &amp; Nothing"><meta property="og:description" content="中文文档 原理 Ansible的名字来自小说&lt;安德的游戏&gt;是一个跨越时空的通讯工具  Ansible本质上只是一个框架,用python开发,实际通过它的库实现功能,其中有三个关键库:  Paramiko: Python对ssh的实现 PyYaml: 解析和生成yaml jinjia2: 用于模板的生成，在使用 template 模块自动生成文件时特别有用  特性:  基于python"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/occultagg/blog-pics/hexo-blog/1*8H4XYCNV-xamG0joz22apQ.png"><meta property="article:published_time" content="2024-02-22T13:11:34.000Z"><meta property="article:modified_time" content="2024-12-11T09:52:23.054Z"><meta property="article:author" content="Peter Pan"><meta property="article:tag" content="ansible"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/occultagg/blog-pics/hexo-blog/1*8H4XYCNV-xamG0joz22apQ.png"><meta name="referrer" content="no-referrer-when-downgrade"><title>ansible-必知必会 - Any &amp; Nothing</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"example.com",root:"/",version:"1.9.7",typing:{enable:!0,typeSpeed:70,cursorChar:"|",loop:!1,scope:["home"]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!0,offset_factor:2},web_analytics:{enable:!0,follow_dnt:!0,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml",include_content_in_search:!0};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Any & Nothing" type="application/atom+xml">
</head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Any &amp; Nothing</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/" target="_self"><i class="iconfont icon-home-fill"></i> <span>首页</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/" target="_self"><i class="iconfont icon-archive-fill"></i> <span>归档</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/" target="_self"><i class="iconfont icon-category-fill"></i> <span>分类</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/" target="_self"><i class="iconfont icon-tags-fill"></i> <span>标签</span></a></li><li class="nav-item"><a class="nav-link" href="/about/" target="_self"><i class="iconfont icon-user-fill"></i> <span>关于</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle">ansible-必知必会</span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2024-02-22 21:11" pubdate>2024年2月22日 晚上</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 4.7k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 40 分钟</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 id="seo-header">ansible-必知必会</h1><div class="markdown-body"><p><img src="https://cdn.jsdelivr.net/gh/occultagg/blog-pics/hexo-blog/1*8H4XYCNV-xamG0joz22apQ.png" srcset="/img/loading.gif" lazyload alt="Ansible 101 Getting Started. Ansible is an agentless automation that… | by  Winton Huang | Medium"></p><p><a target="_blank" rel="noopener" href="https://ansible-tran.readthedocs.io/en/latest/index.html">中文文档</a></p><h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><blockquote><p>Ansible的名字来自小说&lt;安德的游戏&gt;是一个跨越时空的通讯工具</p></blockquote><p>Ansible本质上只是一个框架,用python开发,实际通过它的库实现功能,其中有三个关键库:</p><ul><li>Paramiko: Python对ssh的实现</li><li>PyYaml: 解析和生成yaml</li><li>jinjia2: 用于模板的生成，在使用 <code>template</code> 模块自动生成文件时特别有用</li></ul><p>特性:</p><ul><li>基于python和ssh,无需agent</li><li>安全,基于openssh</li><li><code>幂等</code>: 一个任务执行一遍和执行n遍效果一样,不会因重复执行而带来意料之外的效果</li></ul><h1 id="安装使用"><a href="#安装使用" class="headerlink" title="安装使用"></a>安装使用</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum -y install epel-release<br>yum -y install ansible<br></code></pre></td></tr></table></figure><p>配置ssh –&gt; 定义inventory –&gt; 执行ansible命令&#x2F;执行playbook</p><h1 id="Inventory"><a href="#Inventory" class="headerlink" title="Inventory"></a>Inventory</h1><p>Ansible管理的主机清单配置文件, 默认地址: <code>/etc/ansible/hosts</code></p><blockquote><p>ansible可以同时操作一个组的多台主机</p><p>组和主机之间的关系通过inventory文件配置</p><p>可以同时使用多个inventory文件</p></blockquote><h2 id="INI格式"><a href="#INI格式" class="headerlink" title="INI格式"></a>INI格式</h2><p>也支持<code>yaml</code>格式, 个人觉得<code>ini</code>更清晰易读.</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># 单个主机</span><br>server1.example.com<br><br><span class="hljs-comment"># 主机组 &#x27;web&#x27; 下的主机</span><br><span class="hljs-section">[web]</span><br>server2.example.com<br>server3.example.com<br><br><span class="hljs-comment"># 范围指定的主机</span><br><span class="hljs-section">[database]</span><br>db<span class="hljs-section">[01:10]</span>.example.com<br><br><span class="hljs-comment"># 使用端口和变量的主机定义</span><br><span class="hljs-section">[loadbalancer]</span><br>lb.example.com:8080 <span class="hljs-attr">ansible_connection</span>=ssh ansible_ssh_user=myuser<br></code></pre></td></tr></table></figure><h2 id="定义属于整个组的变量"><a href="#定义属于整个组的变量" class="headerlink" title="定义属于整个组的变量"></a>定义属于整个组的变量</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[atlanta]</span><br>host1<br>host2<br><br><span class="hljs-section">[atlanta:vars]</span><br><span class="hljs-attr">ntp_server</span>=ntp.atlanta.example.com<br><span class="hljs-attr">proxy</span>=proxy.atlanta.example.com<br></code></pre></td></tr></table></figure><h2 id="把一个组作为另一个组的子成员"><a href="#把一个组作为另一个组的子成员" class="headerlink" title="把一个组作为另一个组的子成员"></a>把一个组作为另一个组的子成员</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[webservers]</span><br>web1.example.com<br>web2.example.com<br><br><span class="hljs-section">[dbservers]</span><br>db1.example.com<br>db2.example.com<br><br><span class="hljs-comment"># 使用children关键字定义linux父组下有webservers和dbservers子组</span><br><span class="hljs-section">[linux:children]</span><br>webservers<br>dbservers<br></code></pre></td></tr></table></figure><h2 id="分文件保存变量"><a href="#分文件保存变量" class="headerlink" title="分文件保存变量"></a>分文件保存变量</h2><p><code>ansible&gt;1.4</code>才有的功能</p><p>在inventory文件中保存所有变量并不是最佳实践,以<code>独立文件</code>的方式保存是更优选择.这些文件应该使用<code>yaml</code>格式配置.</p><blockquote><p>假设有一个主机名为: <code>football</code>, 它同时属于两个组: <code>foo</code>和<code>bar</code>,那么以下配置文件中的变量都可以为它所用</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">/etc/ansible/group_vars/&lt;group_name&gt;</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">/etc/ansible/host_vars/&lt;hostname_name&gt;</span><br>/etc/ansible/group_vars/foo<br>/etc/ansible/group_vars/bar<br>/etc/ansible/host_vars/football<br></code></pre></td></tr></table></figure><p>另外,还可以为一个主机一个组创建一个以主机名或组名命名的目录,目录中创建多个文件,目录中的文件的变量都会被读取为主机或组的变量.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">/etc/ansible/group_vars/&lt;group_name&gt;/&lt;any_file_name&gt;</span><br>/etc/ansible/group_vars/raleigh/db_settings<br>/etc/ansible/group_vars/raleigh/cluster_settings<br></code></pre></td></tr></table></figure><blockquote><ul><li>Tip1: ansible1.2+,<code>group_vars</code>和<code>host_vars</code>可以放在inventory目录下<code>/etc/ansible/hosts</code>或是playbook目录下,其中palybook优先级更高.</li><li>Tips: 把inventory文件和变量文件都放入git中管理,是推荐做法</li></ul></blockquote><h2 id="inventory参数"><a href="#inventory参数" class="headerlink" title="inventory参数"></a>inventory参数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible_ssh_host #将要连接的远程主机名.与你想要设定的主机的别名不同的话,可通过此变量设置.<br><br>ansible_ssh_port #ssh端口号.如果不是默认的端口号,通过此变量设置.<br><br>ansible_ssh_user #默认的 ssh 用户名<br><br>ansible_ssh_pass #ssh 密码(这种方式并不安全,我们强烈建议使用 --ask-pass 或 SSH 密钥)<br><br>ansible_sudo_pass # sudo 密码(这种方式并不安全,我们强烈建议使用 --ask-sudo-pass)<br><br>ansible_sudo_exe (new in version 1.8) #sudo 命令路径(适用于1.8及以上版本)<br><br>ansible_connection #与主机的连接类型.比如:local, ssh 或者 paramiko. Ansible 1.2 以前默认使用 paramiko.1.2 以后默认使用 &#x27;smart&#x27;,&#x27;smart&#x27; 方式会根据是否支持 ControlPersist, 来判断&#x27;ssh&#x27; 方式是否可行.<br><br>ansible_ssh_private_key_file #ssh 使用的私钥文件.适用于有多个密钥,而你不想使用 SSH 代理的情况.<br><br>ansible_shell_type #目标系统的shell类型.默认情况下,命令的执行使用 &#x27;sh&#x27; 语法,可设置为 &#x27;csh&#x27; 或 &#x27;fish&#x27;.<br><br>ansible_python_interpreter # 目标主机的 python 路径.适用于的情况: 系统中有多个 Python, 或者命令路径不是&quot;/usr/bin/python&quot;,比如  \*BSD, 或者 /usr/bin/python<br><span class="hljs-meta prompt_"># </span><span class="language-bash">不是 2.X 版本的 Python.我们不使用 <span class="hljs-string">&quot;/usr/bin/env&quot;</span> 机制,因为这要求远程用户的路径设置正确,且要求 <span class="hljs-string">&quot;python&quot;</span> 可执行程序名不可为 python以外的名字(实际有可能名为python26).</span><br><br>ansible_[ruby|perl]_interpreter<br><span class="hljs-meta prompt_"># </span><span class="language-bash">与 ansible_python_interpreter 的工作方式相同,可设定如 ruby 或 perl 的路径....</span><br></code></pre></td></tr></table></figure><p>一个配置例子</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ini">some_host         <span class="hljs-attr">ansible_ssh_port</span>=<span class="hljs-number">2222</span>     ansible_ssh_user=manager<br>aws_host          <span class="hljs-attr">ansible_ssh_private_key_file</span>=/home/example/.ssh/aws.pem<br>freebsd_host      <span class="hljs-attr">ansible_python_interpreter</span>=/usr/local/bin/python<br>ruby_module_host  <span class="hljs-attr">ansible_ruby_interpreter</span>=/usr/bin/ruby.<span class="hljs-number">1.9</span>.<span class="hljs-number">3</span><br></code></pre></td></tr></table></figure><h1 id="动态Inventory"><a href="#动态Inventory" class="headerlink" title="动态Inventory"></a>动态Inventory</h1><blockquote><p>动态生成或发现目标主机的清单,并不是预先固定写在一个静态文件里面.允许ansible与云服务提供商,虚拟化平台或其他API驱动的服务集成,从而实时获取和更新主机信息.也可以收用kubernetes模块与k8s集群集成.</p></blockquote><h1 id="Ansible-ad-hoc命令"><a href="#Ansible-ad-hoc命令" class="headerlink" title="Ansible ad-hoc命令"></a>Ansible ad-hoc命令</h1><p>其实就是命令行执行ansible命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible --help<br>-a MODULE_ARGS<br>-C #dry run模式,测试<br>-f FORK #ansible一般用来管控多台主机,此选项定义ansible分批发送管控请求,一次多少台<br>--list-hosts #列出本次操作会对哪些主机执行,不真正执行<br>--syntax-check #语法检查<br>-t TREE #将日志输出到指定目录<br>-u UESERNAME #指明使用哪个用户名连接目标主机<br>-b,--become #sudo切换root<br>   --become-user=USERNAME #指定sudo的runas用户,默认root<br>-K #提示输入sudo时的口令<br>-k #提示输入ssh连接密码<br></code></pre></td></tr></table></figure><p>用法</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible HOST-PATTERN -m MOD_NAME -a MOD_ARGS -f FORKS<br></code></pre></td></tr></table></figure><h2 id="Pattern"><a href="#Pattern" class="headerlink" title="Pattern"></a>Pattern</h2><p><code>PATTERN</code>是指如何指定要操作的主机,可以是主机名,也可以是组名,除此以为还有很多高级写法:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">invertory内的所有主机</span><br>all<br>*<br><span class="hljs-meta prompt_"># </span><span class="language-bash">IP或多个主机名(<span class="hljs-string">&quot;:&quot;</span>分割),支持<span class="hljs-string">&quot;*&quot;</span>通配</span><br>one.example.com<br>one.example.com:two.example.com<br>192.168.1.50<br>192.168.1.*<br><span class="hljs-meta prompt_"># </span><span class="language-bash">多个组(<span class="hljs-string">&quot;:&quot;</span>分割)</span><br>webservers:dbservers<br><span class="hljs-meta prompt_"># </span><span class="language-bash">组排队</span><br>webservers:!phoenix # 执行的主机必须隶属webservers组但同时不在phoenix组<br>webservers:dbservers:&amp;staging:!phoenix # ‘webservers’ 和 ‘dbservers’ 两个组中隶属于 ‘staging’ 组并且不属于 ‘phoenix’ 组的机器才执行命令<br><span class="hljs-meta prompt_"># </span><span class="language-bash">还可以通过-e传变量</span><br>webservers:!&#123;&#123;excluded&#125;&#125;:&amp;&#123;&#123;required&#125;&#125;<br><span class="hljs-meta prompt_"># </span><span class="language-bash">组编号选主机</span><br>webservers[0]<br>webservers[0-25]<br><span class="hljs-meta prompt_"># </span><span class="language-bash">支持通配和正则,通配何以和组混用</span><br>one*.com:dbservers<br>~(web|db).*\.example\.com<br><span class="hljs-meta prompt_"># </span><span class="language-bash">--<span class="hljs-built_in">limit</span>排除目标</span><br>ansible-playbook site.yml --limit datacenter2<br><span class="hljs-meta prompt_"># </span><span class="language-bash">ansible1.2后支持从文件读取hosts,使用<span class="hljs-string">&quot;@&quot;</span></span><br>ansible-playbook site.yml --limit @retry_hosts.txt<br></code></pre></td></tr></table></figure><p>支持与或非:</p><ul><li><code>:&amp;</code>: 与</li><li><code>:</code>: 或</li><li><code>:!</code>: 非</li></ul><h2 id="模块"><a href="#模块" class="headerlink" title="模块"></a>模块</h2><p><code>-m</code>指定使用的模块,<code>-a</code>指定模块参数.ansible的具体功能都由这些模块提供.下面列举一些常用模块和常用参数.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible-doc -l #列出可用模块<br>ansible-doc -s MOD_NAME #列出模块可用参数和playbook片段<br></code></pre></td></tr></table></figure><h3 id="group"><a href="#group" class="headerlink" title="group"></a>group</h3><blockquote><p>创建删除组</p></blockquote><p><code>args</code>:</p><ul><li><p>gid</p></li><li><p>*name: 自定义组名</p></li><li><p>state</p><ul><li>present: 存在,即创建</li><li>absent: 不存在,即删除</li></ul></li><li><p>system: 是否创建系统用户组</p><ul><li>yes</li><li>no</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible all -m group -a &quot;gid=3000 name=mygrp state=present system=no&quot;<br></code></pre></td></tr></table></figure></li></ul><h3 id="user"><a href="#user" class="headerlink" title="user"></a>user</h3><blockquote><p>创建删除用户</p></blockquote><p><code>args</code>:</p><ul><li><p>*name</p></li><li><p>uid</p></li><li><p>groups</p></li><li><p>home</p></li><li><p>state&#x3D;present | absent</p></li><li><p>system&#x3D;yes | no</p></li><li><p>move_home&#x3D;yes | no</p><blockquote><p>如果系统已存在该用户,但ansible又创建了一遍,两次定义的家目录路径不一致,是否移动家目录到新位置</p></blockquote></li><li><p>generate_ssh_key&#x3D;yes | no</p><blockquote><p>是否为用户自动创建ssh密钥,如果原来就有了,不会覆盖原来的,而是创建新的</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible all -m user -a &quot;uid=5000 name=testuser state=present groups=mygrp shell=/bin/tcsh&quot;<br></code></pre></td></tr></table></figure></li></ul><h3 id="copy"><a href="#copy" class="headerlink" title="copy"></a>copy</h3><blockquote><p>以并行的方式同时 SCP 大量的文件到多台机器</p></blockquote><p><code>args</code>:</p><ul><li><p>*dest: 目标路径</p></li><li><p>*src:源路径,支持相对&#x2F;绝对地址</p><blockquote><p>源是目录,默认会递归复制</p><p>源以”&#x2F;“结尾,只复制目录内的内容</p><p>源不以”&#x2F;“结尾,则把目录本身也复制过去</p></blockquote></li><li><p>owner: 属主</p></li><li><p>group: 属组</p></li><li><p>mode: 权限</p></li><li><p>remote_src: 从远程源复制到主机</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible all -m copy -a &quot;src=/etc/fstab dest=/tmp/fstab.ansible mode=600&quot;<br>ansible all -m copy -a &quot;src=/etc/pam.d/ dest=/tmp/&quot;<br>ansible all -m copy -a &quot;content=&#x27;hi there\n&#x27; dest=/tmp/hi.txt&quot;<br></code></pre></td></tr></table></figure></li></ul><h3 id="fetch"><a href="#fetch" class="headerlink" title="fetch"></a>fetch</h3><blockquote><p>从远端复制文件到本机</p></blockquote><h3 id="file"><a href="#file" class="headerlink" title="file"></a>file</h3><blockquote><p>创建或删除文件&#x2F;目录</p></blockquote><ul><li><p>state&#x3D;present | absent | directory | file | link</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible all -m file -a &quot;path=/var/tmp/hello.txt state=directory&quot;<br>ansible all -m file -a &quot;path=/var/tmp/hello.txt state=file&quot;<br>ansible all -m file -a &quot;src=/var/tmp/hello.txt path=/var/tmp/fstab.link state=link&quot; #创建软链文件<br></code></pre></td></tr></table></figure></li></ul><h3 id="command"><a href="#command" class="headerlink" title="command"></a>command</h3><blockquote><p>执行给定的命令,但不会使用<code>目标主机</code>shell环境,因此不支持shell特有的语法和通配符.</p><p>command模块<code>不是幂等的</code>,重复执行会失败.</p><p>比如你用command模块创建文件夹,多次执行,就会失败.command模块有相关的参数比如<code>create</code>或<code>remove</code>去处理这种情况.</p><p>当然也可以选择其他幂等的module去处理有不幂等风险的操作.</p></blockquote><ul><li><p>chdir: 切换工作目录</p></li><li><p>executable: 切换执行程序的shell,要使用绝对路径</p></li><li><p>free_from: 自由格式(命令直接给出没不需要kv格式)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible all -m command -a &quot;ifconfig&quot;<br>ansible all -m command -a &quot;chdir=/var/tmp mkdir hi.dir&quot;<br>ansible all -m command -a &quot;echo mageedu | passwd --stdin testuser&quot; # 执行失败<br></code></pre></td></tr></table></figure></li></ul><h3 id="shell"><a href="#shell" class="headerlink" title="shell"></a>shell</h3><blockquote><p>使用<code>目标主机的shell环境</code>执行命令,这意味着它支持管道,通配,重定向等shell特有的操作,以及可以使用环境变量.</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible all -m shell -a &quot;echo mageedu | passwd --stdin testuser&quot; # 用shell就会成功<br></code></pre></td></tr></table></figure><h3 id="cron"><a href="#cron" class="headerlink" title="cron"></a>cron</h3><blockquote><p>设定周期性任务,实际上就是操作目标主机的crontab</p></blockquote><ul><li><p>name: 指定任务名称, 默认为none</p></li><li><p>day</p></li><li><p>hour</p></li><li><p>job</p></li><li><p>state&#x3D;present | absent</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible all -m cron -a &quot;minute=*/3 job=&#x27;/usr/sbin/update 172.16.0.1 &amp;&gt; /dev/null&#x27;&quot;<br>ansible all -m cron -a &quot;minute=*/3 job=&#x27;/usr/sbin/update 172.16.0.1 &amp;&gt; /dev/null&#x27; name=None state=absent&quot;<br></code></pre></td></tr></table></figure></li></ul><h3 id="yum-dnf"><a href="#yum-dnf" class="headerlink" title="yum&#x2F;dnf"></a>yum&#x2F;dnf</h3><blockquote><p>包管理程序</p><p>一般redhat 8及以上使用dnf</p><p>redhat 8以下使用yum</p></blockquote><ul><li><p>*name: 包名</p></li><li><p>state&#x3D;present | installed | latest | absent | removed</p></li><li><p>disable_gpg_check</p></li><li><p>disablerepo</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible all -m yum -a &quot;name=nginx state=installed&quot;<br></code></pre></td></tr></table></figure></li></ul><h3 id="service"><a href="#service" class="headerlink" title="service"></a>service</h3><blockquote><p>通用的服务管理模块,它会检测系统使用的是哪一种服务管理方式(sysvinit, upstart, systemd等),并尝试用正确的方式来广利服务.</p><p>当然,针对不同的服务管理方式,ansible都有对应模块,如果不清楚,或者通用功能就行,就使用service就好了</p></blockquote><ul><li><p>*name: 服务名</p></li><li><p>pattern: 如果服务不支持status命令,可以使用pattern过滤字符以获取运行状态</p></li><li><p>runlevel: 设定启动等级</p></li><li><p>enabled: 开机自启动</p></li><li><p>state&#x3D;started | stopped</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible all -m service -a &quot;name=nginx state=started&quot;<br></code></pre></td></tr></table></figure></li></ul><h3 id="script"><a href="#script" class="headerlink" title="script"></a>script</h3><blockquote><p>复制本地脚本到目标主机运行,不幂等</p></blockquote><ul><li><p>chdir: 切换目标主机的工作目录</p></li><li><p>cmd: 要使用的本地脚本的路径, 后面可以跟参数</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible all -m script -a &quot;/tmp/test.sh&quot;<br></code></pre></td></tr></table></figure></li></ul><h1 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h1><p><code>/etc/ansible/ansible.cfg</code></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[defaults]</span><br><span class="hljs-comment">#inventory     = /etc/ansible/hosts      # 主机列表配置文件</span><br><span class="hljs-comment">#library       = /usr/share/my_modules/  # 库文件存放目录</span><br><span class="hljs-comment">#remote_tmp    = $HOME/.ansible/tmp      # 临时py命令文件存放在远程主机目录</span><br><span class="hljs-comment">#local_tmp     = $HOME/.ansible/tmp      # 本机的临时命令执行目录  </span><br><span class="hljs-comment">#forks         = 5                       # 默认并发数,同时可以执行5次</span><br><span class="hljs-comment">#sudo_user     = root                    # 默认sudo 用户</span><br><span class="hljs-comment">#ask_sudo_pass = True                    # 每次执行ansible命令是否询问ssh密码</span><br><span class="hljs-comment">#ask_pass      = True                    # 每次执行ansible命令是否询问ssh口令</span><br><span class="hljs-comment">#remote_port   = 22                      # 远程主机的端口号(默认22)</span><br><br><span class="hljs-comment">#建议优化项： </span><br><br><span class="hljs-attr">host_key_checking</span> = <span class="hljs-literal">False</span>               <span class="hljs-comment"># 检查对应服务器的host_key，建议取消注释</span><br><span class="hljs-attr">log_path</span>=/var/log/ansible.log           <span class="hljs-comment"># 日志文件,建议取消注释</span><br><span class="hljs-attr">module_name</span>   = command                 <span class="hljs-comment"># 默认模块</span><br></code></pre></td></tr></table></figure><h1 id="ansible命令执行过程"><a href="#ansible命令执行过程" class="headerlink" title="ansible命令执行过程"></a>ansible命令执行过程</h1><ol><li>加载配置文件&#x2F;etc&#x2F;ansible&#x2F;ansible.cfg</li><li>加载自己对应的模块文件</li><li>通过ansible将模块命令生成临时的py文件<ol><li>并将该文件传输到目标主机对应执行用户的$HOME&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-数字&#x2F;XXX.py</li></ol></li><li>给文件+x</li><li>执行并返回结果</li><li>删除临时py文件, sleep 0 退出</li></ol><p>执行结果:</p><ul><li><p>绿色: 成功应用变更</p></li><li><p>黄色: 成功但无变更</p></li><li><p>红色: 失败</p></li></ul><h1 id="ansible-playbook"><a href="#ansible-playbook" class="headerlink" title="ansible-playbook"></a>ansible-playbook</h1><blockquote><p>ad-hoc与playbook就类似shell命令与shell脚本的关系.</p><p>playbook使用yaml编写.</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Enhanced</span> <span class="hljs-string">Playbook</span> <span class="hljs-string">Example</span> <span class="hljs-comment"># playbook name</span><br>  <span class="hljs-attr">hosts:</span> <span class="hljs-string">web_servers</span> <span class="hljs-comment"># inventory pattern</span><br>  <span class="hljs-attr">become:</span> <span class="hljs-literal">yes</span> <span class="hljs-comment"># 用于权限提升或用户切换</span><br>  <span class="hljs-attr">become_method:</span> <span class="hljs-string">sudo</span> <span class="hljs-comment"># 指定权限提升或用户切换的具体方式</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">admin</span> <span class="hljs-comment"># 定义执行远程任务的用户帐户。当 Ansible 与远程主机建立连接时，它将使用这个用户的身份来登录</span><br>  <span class="hljs-attr">tasks:</span> <span class="hljs-comment"># 任务列表</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">Apache</span> <span class="hljs-comment"># task name</span><br>      <span class="hljs-attr">yum:</span> <span class="hljs-comment"># 使用的模块</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">httpd</span> <span class="hljs-comment"># 模块参数</span><br>        <span class="hljs-attr">state:</span> <span class="hljs-string">present</span><br>      <span class="hljs-attr">notify:</span> <span class="hljs-comment"># notify是handlers的触发标志</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">Restart</span> <span class="hljs-string">Apache</span> <span class="hljs-comment"># 触发哪个handlers</span><br>      <span class="hljs-attr">tags:</span> <span class="hljs-comment"># 标签,可以根据标签指定运行或跳过运行某个或某些task</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">installation</span><br><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Copy</span> <span class="hljs-string">Apache</span> <span class="hljs-string">Configuration</span> <span class="hljs-string">File</span><br>      <span class="hljs-attr">copy:</span><br>        <span class="hljs-attr">src:</span> <span class="hljs-string">/path/to/conf/httpd.conf</span><br>        <span class="hljs-attr">dest:</span> <span class="hljs-string">/etc/httpd/conf/httpd.conf</span><br>      <span class="hljs-attr">notify:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">Restart</span> <span class="hljs-string">Apache</span><br>      <span class="hljs-attr">tags:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">configuration</span><br><br>  <span class="hljs-attr">handlers:</span> <span class="hljs-comment"># 定义handlers任务列表</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Restart</span> <span class="hljs-string">Apache</span><br>      <span class="hljs-attr">service:</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">httpd</span><br>        <span class="hljs-attr">state:</span> <span class="hljs-string">restarted</span><br>      <span class="hljs-attr">tags:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">handlers</span><br></code></pre></td></tr></table></figure><p>其实就是命令调用模块改为yaml写法.</p><h2 id="notify和handlers"><a href="#notify和handlers" class="headerlink" title="notify和handlers"></a>notify和handlers</h2><p>notify是触发器,handlers是响应器.</p><p>如果notify所在的task没有触发变更,notify所定义的handler也不会被触发</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">确保</span> <span class="hljs-string">web</span> <span class="hljs-string">服务正确运行</span><br>  <span class="hljs-attr">hosts:</span> <span class="hljs-string">web_servers</span><br>  <span class="hljs-attr">become:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">将配置文件拷贝到远程服务器</span><br>      <span class="hljs-attr">copy:</span><br>        <span class="hljs-attr">src:</span> <span class="hljs-string">/src/webserver.conf</span><br>        <span class="hljs-attr">dest:</span> <span class="hljs-string">/etc/webserver.conf</span><br>      <span class="hljs-attr">notify:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">重启</span> <span class="hljs-string">web</span> <span class="hljs-string">服务</span><br><br>  <span class="hljs-attr">handlers:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">重启</span> <span class="hljs-string">web</span> <span class="hljs-string">服务</span><br>      <span class="hljs-attr">service:</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">webserver</span><br>        <span class="hljs-attr">state:</span> <span class="hljs-string">restarted</span><br></code></pre></td></tr></table></figure><h2 id="tags"><a href="#tags" class="headerlink" title="tags"></a>tags</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">指执行有这个tag的任务</span><br>ansible-playbook install_apache.yml --tags &quot;configuration&quot;<br><span class="hljs-meta prompt_"># </span><span class="language-bash">跳过执行有这个tag的任务</span><br>ansible-playbook install_apache.yml --skip-tags &quot;configuration&quot;<br></code></pre></td></tr></table></figure><h2 id="常用参数"><a href="#常用参数" class="headerlink" title="常用参数"></a>常用参数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">-C #dry run<br>--syntax-check #语法检查<br>-t #指定调用对应标签的任务<br>--list-hosts<br>--list-tags<br>--list-tasks<br></code></pre></td></tr></table></figure><h2 id="Variables"><a href="#Variables" class="headerlink" title="Variables"></a>Variables</h2><p><code>vars</code>定义变量,<code>&#123;&#123;var_name&#125;&#125;</code>调用变量</p><h3 id="Fact"><a href="#Fact" class="headerlink" title="Fact"></a>Fact</h3><p>ansible的setup模块获取的主机自带的系统信息</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum -y install facter<br><span class="hljs-meta prompt_"># </span><span class="language-bash">获取本机的系统信息,setup模块获取的也就是这些信息</span><br>facter -p<br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看setup模块参数</span><br>ansible-doc -s setup<br><span class="hljs-meta prompt_"># </span><span class="language-bash">获取facts并通过filter参数过滤想要的fact</span><br>ansible all -i inventory.ini -m setup -a &#x27;filter=ansible_*_mb&#x27;<br></code></pre></td></tr></table></figure><p>这种类型的变量直接调用即可.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Collect</span> <span class="hljs-string">only</span> <span class="hljs-string">certain</span> <span class="hljs-string">facts</span><br>  <span class="hljs-attr">hosts:</span> <span class="hljs-string">all</span><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Gather</span> <span class="hljs-string">only</span> <span class="hljs-string">memory</span> <span class="hljs-string">related</span> <span class="hljs-string">facts</span><br>      <span class="hljs-attr">setup:</span> <span class="hljs-comment"># 通过setup模块获取fact</span><br>        <span class="hljs-attr">filter:</span> <span class="hljs-string">ansible_*_mb</span> <span class="hljs-comment"># 过滤fact</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Print</span> <span class="hljs-string">out</span> <span class="hljs-string">the</span> <span class="hljs-string">total</span> <span class="hljs-string">memory</span><br>  <span class="hljs-attr">debug:</span> <span class="hljs-comment"># debug模块用于打印或调试信息，它主要用于输出变量的值来帮助理解和调试 playbook 的执行流程。`debug`可以用来输出字符串信息，也可以用来展示`register`所捕获的变量内容。</span><br>    <span class="hljs-attr">msg:</span> <span class="hljs-string">&quot;Total memory on this machine is <span class="hljs-template-variable">&#123;&#123; ansible_memtotal_mb &#125;&#125;</span> MB&quot;</span> <span class="hljs-comment"># 直接使用fact变量</span><br><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Check</span> <span class="hljs-string">if</span> <span class="hljs-string">a</span> <span class="hljs-string">directory</span> <span class="hljs-string">exists</span><br>  <span class="hljs-attr">ansible.builtin.stat:</span> <span class="hljs-comment"># Ansible 中的一个内置模块，它用于获取文件或文件夹在远程主机上的状态信息。这些信息包括文件的存在性、类型、大小、权限、所属用户、所属组、最后修改时间等。</span><br>    <span class="hljs-attr">path:</span> <span class="hljs-string">&quot;/a/specific/path&quot;</span><br>  <span class="hljs-attr">register:</span> <span class="hljs-string">result</span> <span class="hljs-comment"># register关键词用于捕获任务执行的输出结果，例如命令执行的输出，模块执行的详细结果等。通过`register`保存的结果可以被后续的任务使用，像条件判断、循环迭代等。</span><br><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Display</span> <span class="hljs-string">results</span> <span class="hljs-string">if</span> <span class="hljs-string">directory</span> <span class="hljs-string">exists</span><br>  <span class="hljs-attr">debug:</span><br>    <span class="hljs-attr">msg:</span> <span class="hljs-string">&quot;The directory exists!&quot;</span><br>  <span class="hljs-attr">when:</span> <span class="hljs-string">result.stat.exists</span><br></code></pre></td></tr></table></figure><h3 id="用户自定义"><a href="#用户自定义" class="headerlink" title="用户自定义"></a>用户自定义</h3><ol><li><p>命令行定义</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible-playbook -e pkgname=memcached test.yaml<br></code></pre></td></tr></table></figure></li><li><p>playbook中定义</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">vars:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">var1:</span> <span class="hljs-string">value1</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">var2:</span> <span class="hljs-string">value2</span><br></code></pre></td></tr></table></figure></li></ol><h3 id="通过roles传递"><a href="#通过roles传递" class="headerlink" title="通过roles传递"></a>通过roles传递</h3><h3 id="通过-Invertory传递"><a href="#通过-Invertory传递" class="headerlink" title="通过 Invertory传递"></a>通过 Invertory传递</h3><p>前面有说过Invertory文件可以定义变量,但是要注意跟inventory参数的区分</p><h2 id="template模块"><a href="#template模块" class="headerlink" title="template模块"></a>template模块</h2><p>主要用来动态生成配置文件.</p><blockquote><p>用于基于Jinja2模板语言处理模板文件。Jinja2模板中可以包含变量和表达式，这些变量将在Ansible运行时根据具体的上下文环境进行替换。<code>template</code> 模块主要用于生成配置文件或其他类型的文本文件，并且将这些文件复制到远程主机上.</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Configure</span> <span class="hljs-string">nginx</span><br>  <span class="hljs-attr">hosts:</span> <span class="hljs-string">webservers</span><br>  <span class="hljs-attr">vars:</span> <span class="hljs-comment"># playbook定义的变量,会被使用到模板上</span><br>    <span class="hljs-attr">http_port:</span> <span class="hljs-number">80</span><br>    <span class="hljs-attr">max_clients:</span> <span class="hljs-number">200</span><br><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Create</span> <span class="hljs-string">nginx</span> <span class="hljs-string">configuration</span> <span class="hljs-string">file</span> <span class="hljs-string">from</span> <span class="hljs-string">template</span><br>      <span class="hljs-attr">template:</span><br>        <span class="hljs-attr">src:</span> <span class="hljs-string">/srv/http/nginx.conf.j2</span> <span class="hljs-comment"># 要使用的jinja2模板</span><br>        <span class="hljs-attr">dest:</span> <span class="hljs-string">/etc/nginx/nginx.conf</span><br>        <span class="hljs-attr">owner:</span> <span class="hljs-string">root</span><br>        <span class="hljs-attr">group:</span> <span class="hljs-string">root</span><br>        <span class="hljs-attr">mode:</span> <span class="hljs-string">&#x27;0644&#x27;</span><br></code></pre></td></tr></table></figure><h2 id="task高级用法"><a href="#task高级用法" class="headerlink" title="task高级用法"></a>task高级用法</h2><h3 id="条件测试"><a href="#条件测试" class="headerlink" title="条件测试"></a>条件测试</h3><p>关键字: <code>when</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">tasks:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">conf</span> <span class="hljs-string">file</span> <span class="hljs-string">to</span> <span class="hljs-string">centos7</span><br>  <span class="hljs-attr">template:</span> <span class="hljs-string">src=files/nginx.conf.c7.j2</span><br>  <span class="hljs-attr">when:</span> <span class="hljs-string">ansible_distribution_major_version</span> <span class="hljs-string">==</span> <span class="hljs-string">&quot;7&quot;</span> <span class="hljs-comment"># when语句为true则执行</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">conf</span> <span class="hljs-string">file</span> <span class="hljs-string">to</span> <span class="hljs-string">centos6</span><br>  <span class="hljs-attr">template:</span> <span class="hljs-string">src=files/nginx.conf.c6.j2</span><br>  <span class="hljs-attr">when:</span> <span class="hljs-string">ansible_distribution_major_version</span> <span class="hljs-string">==</span> <span class="hljs-string">&quot;6&quot;</span><br></code></pre></td></tr></table></figure><h3 id="迭代循环"><a href="#迭代循环" class="headerlink" title="迭代循环"></a>迭代循环</h3><p>关键字:</p><ul><li><p>旧版本: <code>item</code>, <code>with_item</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">some</span> <span class="hljs-string">packages</span><br>  <span class="hljs-attr">yum:</span> <span class="hljs-string">name=&#123;&#123;</span> <span class="hljs-string">item</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">state=present</span><br>  <span class="hljs-attr">with_items:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">nginx</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">memcached</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">php-fpm</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">add</span> <span class="hljs-string">some</span> <span class="hljs-string">groups</span><br>  <span class="hljs-attr">group:</span> <span class="hljs-string">name=&#123;&#123;</span> <span class="hljs-string">item</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">state=present</span><br>  <span class="hljs-attr">with_items:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">group1</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">group2</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">add</span> <span class="hljs-string">some</span> <span class="hljs-string">users</span><br>  <span class="hljs-attr">user:</span> <span class="hljs-string">name=&#123;&#123;</span> <span class="hljs-string">item.name</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">group=&#123;&#123;</span> <span class="hljs-string">item.group</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">state=present</span><br>  <span class="hljs-attr">with_items:</span><br>  <span class="hljs-bullet">-</span> &#123; <span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;user1&#x27;</span>, <span class="hljs-attr">group:</span> <span class="hljs-string">&#x27;group1&#x27;</span> &#125;<br><span class="hljs-bullet">-</span> &#123; <span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;user2&#x27;</span>, <span class="hljs-attr">group:</span> <span class="hljs-string">&#x27;group2&#x27;</span> &#125;<br></code></pre></td></tr></table></figure></li><li><p>新版本: <code>loop</code>,<code>item</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 基本迭代,迭代列表的每一项</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Add</span> <span class="hljs-string">several</span> <span class="hljs-string">users</span><br>  <span class="hljs-attr">ansible.builtin.user:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">&quot;<span class="hljs-template-variable">&#123;&#123; item &#125;&#125;</span>&quot;</span><br>    <span class="hljs-attr">state:</span> <span class="hljs-string">present</span><br>    <span class="hljs-attr">groups:</span> <span class="hljs-string">&quot;wheel&quot;</span><br>  <span class="hljs-attr">loop:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">testuser1</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">testuser2</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">testuser3</span><br><span class="hljs-meta">---</span><br><span class="hljs-comment"># 迭代字典</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Ensure</span> <span class="hljs-string">several</span> <span class="hljs-string">users</span> <span class="hljs-string">have</span> <span class="hljs-string">specific</span> <span class="hljs-string">properties</span><br>  <span class="hljs-attr">ansible.builtin.user:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">&quot;<span class="hljs-template-variable">&#123;&#123; item.key &#125;&#125;</span>&quot;</span><br>    <span class="hljs-attr">state:</span> <span class="hljs-string">present</span><br>    <span class="hljs-attr">groups:</span> <span class="hljs-string">&quot;<span class="hljs-template-variable">&#123;&#123; item.value.groups &#125;&#125;</span>&quot;</span><br>    <span class="hljs-attr">uid:</span> <span class="hljs-string">&quot;<span class="hljs-template-variable">&#123;&#123; item.value.uid &#125;&#125;</span>&quot;</span><br>  <span class="hljs-attr">loop:</span> <span class="hljs-string">&quot;<span class="hljs-template-variable">&#123;&#123; users | dict2items &#125;&#125;</span>&quot;</span> <span class="hljs-comment"># dict2items过滤器将字典转换为项列表</span><br>  <span class="hljs-attr">vars:</span><br>    <span class="hljs-attr">users:</span> <span class="hljs-comment"># dict name</span><br>      <span class="hljs-attr">alice:</span><br>        <span class="hljs-attr">uid:</span> <span class="hljs-number">1001</span><br>        <span class="hljs-attr">groups:</span> <span class="hljs-string">&quot;wheel&quot;</span><br>      <span class="hljs-attr">bob:</span><br>        <span class="hljs-attr">uid:</span> <span class="hljs-number">1002</span><br>        <span class="hljs-attr">groups:</span> <span class="hljs-string">&quot;staff&quot;</span><br></code></pre></td></tr></table></figure></li></ul><h1 id="role"><a href="#role" class="headerlink" title="role"></a>role</h1><blockquote><p>是一种组织playbook的方式,可以把复杂的任务拆分成更小的,可复用的文件.类似python的模块,role也可以让ansible代码更加模块化,更容易管理和服用.</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">创建role</span><br>ansible-galaxy init my_role<br></code></pre></td></tr></table></figure><h2 id="目录架构"><a href="#目录架构" class="headerlink" title="目录架构"></a>目录架构</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs shell">my_role/<br>├── defaults<br>│   └── main.yml # 定义变量默认值<br>├── files # 存放role需要复制到目标主机的源文件<br>├── handlers<br>│   └── main.yml # 存放handlers任务,只有被notify触发才会执行<br>├── meta<br>│   └── main.yml # 定义role的元数据(作者信息, 支持平台, 依赖关系等)<br>├── README.md # 项目README<br>├── tasks <br>│   └── main.yml # 定义role要执行的主要任务列表,当角色被引用,这里的任务将会按序执行<br>├── templates # jinjia2模板文件<br>├── tests # 用于存放测试role的文件<br>│   ├── inventory # 列出测试用的主机<br>│   └── test.yml # 测试用playbook (ansible-playbook -i tests/inventory tests/test.yml)<br>└── vars<br>    └── main.yml # 定义变量<br></code></pre></td></tr></table></figure><h2 id="meta-main-yaml-例子"><a href="#meta-main-yaml-例子" class="headerlink" title="meta&#x2F;main.yaml 例子"></a>meta&#x2F;main.yaml 例子</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">galaxy_info:</span> <span class="hljs-comment"># role的相关信息</span><br>  <span class="hljs-attr">author:</span> <span class="hljs-string">your_name</span><br>  <span class="hljs-attr">description:</span> <span class="hljs-string">Example</span> <span class="hljs-string">role</span> <span class="hljs-string">for</span> <span class="hljs-string">web</span> <span class="hljs-string">server</span> <span class="hljs-string">setup</span><br>  <span class="hljs-attr">company:</span> <span class="hljs-string">Your</span> <span class="hljs-string">Company</span> <span class="hljs-string">(optional)</span><br>  <span class="hljs-attr">license:</span> <span class="hljs-string">MIT</span> <span class="hljs-string">(或你选择的其他许可证)</span><br>  <span class="hljs-attr">min_ansible_version:</span> <span class="hljs-number">2.9</span> <span class="hljs-string">(或其他最小版本要求)</span> <span class="hljs-comment"># ansible版本要求</span><br>  <span class="hljs-attr">platforms:</span> <span class="hljs-comment"># 支持的平台</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">EL</span><br>      <span class="hljs-attr">versions:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-number">7</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-number">8</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Ubuntu</span><br>      <span class="hljs-attr">versions:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">xenial</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">bionic</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">focal</span><br>  <span class="hljs-attr">galaxy_tags:</span>                    <span class="hljs-comment"># 类似于标签，用于在Ansible Galaxy中分类和搜索你的角色</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">web</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">server</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">httpd</span><br><br><span class="hljs-attr">dependencies:</span>                     <span class="hljs-comment"># 如果你的角色依赖于其他角色，则在这里列出</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">role:</span> <span class="hljs-string">other_role</span><br>  <span class="hljs-bullet">-</span> &#123; <span class="hljs-attr">role:</span> <span class="hljs-string">conditional_role</span>, <span class="hljs-attr">when:</span> <span class="hljs-string">&quot;some_condition|bool&quot;</span>, <span class="hljs-attr">var1:</span> <span class="hljs-string">&quot;value1&quot;</span>, <span class="hljs-attr">var2:</span> <span class="hljs-string">&quot;value2&quot;</span> &#125;<br></code></pre></td></tr></table></figure><h2 id="default-main-yaml"><a href="#default-main-yaml" class="headerlink" title="default&#x2F;main.yaml"></a>default&#x2F;main.yaml</h2><p>列出kv定义变量和默认值即可</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">nginx_user:</span> <span class="hljs-string">www-data</span><br><span class="hljs-attr">nginx_http_port:</span> <span class="hljs-number">80</span><br><span class="hljs-attr">nginx_configure_default_site:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure><h2 id="handlers-main-yaml"><a href="#handlers-main-yaml" class="headerlink" title="handlers&#x2F;main.yaml"></a>handlers&#x2F;main.yaml</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">restart</span> <span class="hljs-string">nginx</span><br>  <span class="hljs-attr">service:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">state:</span> <span class="hljs-string">restarted</span><br>  <span class="hljs-attr">become:</span> <span class="hljs-literal">true</span>  <span class="hljs-comment"># 若需要管理员权限，则设置为true</span><br><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">reload</span> <span class="hljs-string">nginx</span><br>  <span class="hljs-attr">service:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">state:</span> <span class="hljs-string">reloaded</span><br>  <span class="hljs-attr">become:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure><h2 id="task-main-yaml"><a href="#task-main-yaml" class="headerlink" title="task&#x2F;main.yaml"></a>task&#x2F;main.yaml</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">nginx</span><br>  <span class="hljs-attr">apt:</span> <br>    <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">state:</span> <span class="hljs-string">present</span><br>  <span class="hljs-attr">become:</span> <span class="hljs-literal">true</span><br><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Configure</span> <span class="hljs-string">nginx</span><br>  <span class="hljs-attr">template:</span> <br>    <span class="hljs-attr">src:</span> <span class="hljs-string">nginx.conf.j2</span><br>    <span class="hljs-attr">dest:</span> <span class="hljs-string">/etc/nginx/nginx.conf</span><br>  <span class="hljs-attr">notify:</span> <br>    <span class="hljs-bullet">-</span> <span class="hljs-string">restart</span> <span class="hljs-string">nginx</span><br><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Ensure</span> <span class="hljs-string">nginx</span> <span class="hljs-string">is</span> <span class="hljs-string">running</span> <span class="hljs-string">(and</span> <span class="hljs-string">enable</span> <span class="hljs-string">it</span> <span class="hljs-string">at</span> <span class="hljs-string">boot)</span><br>  <span class="hljs-attr">service:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">state:</span> <span class="hljs-string">started</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">become:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure><h2 id="vars-main-yaml"><a href="#vars-main-yaml" class="headerlink" title="vars&#x2F;main.yaml"></a>vars&#x2F;main.yaml</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">nginx_version:</span> <span class="hljs-string">&quot;1.14.2&quot;</span><br><span class="hljs-attr">nginx_core_module_settings:</span><br>  <span class="hljs-attr">worker_processes:</span> <span class="hljs-string">&quot;auto&quot;</span><br>  <span class="hljs-attr">worker_connections:</span> <span class="hljs-number">1024</span><br>  <span class="hljs-attr">multi_accept:</span> <span class="hljs-string">&quot;on&quot;</span><br><span class="hljs-attr">nginx_event_module_settings:</span> <span class="hljs-comment"># 嵌套变量,通过&quot;.&quot;表达式引用: &#123;&#123; nginx_event_module_settings.use &#125;&#125;</span><br>  <span class="hljs-attr">use:</span> <span class="hljs-string">&quot;epoll&quot;</span><br></code></pre></td></tr></table></figure><h2 id="playbook引用"><a href="#playbook引用" class="headerlink" title="playbook引用"></a>playbook引用</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">webservers</span><br>  <span class="hljs-attr">become:</span> <span class="hljs-literal">yes</span><br>  <span class="hljs-attr">roles:</span> <span class="hljs-comment"># role可以引用多个,playbook将会按次序执行</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">common</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">application</span><br></code></pre></td></tr></table></figure><h1 id="完整的目录架构"><a href="#完整的目录架构" class="headerlink" title="完整的目录架构"></a>完整的目录架构</h1><p>一个完整的playbook+role的典型目录架构</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs shell">playbook-directory/<br>│<br>├── ansible.cfg  # Ansible 配置文件（可选）不存在则使用默认的/etc/ansible/ansible.cfg<br>├── inventory    # 存储库存信息的文件或目录 (可选) 不存在则使用默认的/etc/ansible/hosts<br>│<br>├── group_vars/<br>│   └── group1   # 组1的变量<br>│<br>├── host_vars/<br>│   └── hostname # 特定主机的变量<br>│<br>├── roles/<br>│   ├── role1/   # 第一个 role<br>│   │   ├── defaults/<br>│   │   │   └── main.yml  # role 的默认变量<br>│   │   ├── handlers/<br>│   │   │   └── main.yml  # role 的 handlers<br>│   │   ├── meta/<br>│   │   │   └── main.yml  # role 的元数据<br>│   │   ├── tasks/<br>│   │   │   └── main.yml  # role 的任务列表<br>│   │   ├── templates/<br>│   │   │   └── template.j2  # Jinja2 模版文件<br>│   │   └── vars/<br>│   │       └── main.yml  # role 的其他变量<br>│   │<br>│   └── role2/   # 第二个 role<br>│       ├── defaults/<br>│       ├── handlers/<br>│       ├── meta/<br>│       ├── tasks/<br>│       ├── templates/<br>│       └── vars/<br>│<br>├── site.yml      # 主 playbook 文件<br>├── webservers.yml    # 针对 web 服务器的 playbook<br>└── databases.yml     # 针对数据库服务器的 playbook<br></code></pre></td></tr></table></figure><h1 id="import-playbook"><a href="#import-playbook" class="headerlink" title="import_playbook"></a>import_playbook</h1><p>playbook可以通过import来调用,这就有了上面的<code>主playbook</code></p><p>例如site.yml可以这么写</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">import_playbook:</span> <span class="hljs-string">webservers.yml</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">import_playbook:</span> <span class="hljs-string">databases.yml</span><br></code></pre></td></tr></table></figure><p>ansible会按次序执行webservers.yml和databases.yml两个playbook</p><h1 id="ansible-galaxy"><a href="#ansible-galaxy" class="headerlink" title="ansible-galaxy"></a>ansible-galaxy</h1><p><a target="_blank" rel="noopener" href="https://galaxy.ansible.com/ui/">官网</a></p><blockquote><p>在 Ansible 中，共享和使用别人创建的 roles 是一个常见的做法，用于促进可重用性和合作。Ansible 的主要方式是通过 Ansible Galaxy，它是一个共享和寻找 Ansible role 的中心化平台。</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible-galaxy install geerlingguy.apache -p /path/to/role<br></code></pre></td></tr></table></figure><h2 id="requirements-yaml"><a href="#requirements-yaml" class="headerlink" title="requirements.yaml"></a>requirements.yaml</h2><p>与python一样,playbook目录可以创建一个<code>requirements.yaml</code>,里面列出需要的role,通过命令一次安装</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible-galaxy install -r requirements.yml<br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># requirements.yaml</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">src:</span> <span class="hljs-string">geerlingguy.apache</span><br>  <span class="hljs-attr">version:</span> <span class="hljs-number">1.0</span><span class="hljs-number">.0</span><br></code></pre></td></tr></table></figure></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/" class="category-chain-item">技术笔记</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/ansible/" class="print-no-link">#ansible</a></div></div><div class="license-box my-3"><div class="license-title"><div>ansible-必知必会</div><div>http://example.com/2024/02/22/ansible-mustknow/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>Peter Pan</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2024年2月22日</div></div><div class="license-meta-item"><div>许可协议</div><div><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2024/02/24/python-oop-advance/" title="python-面向对象高级特性"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">python-面向对象高级特性</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2024/02/20/k8s-theory/" title="k8s-理论"><span class="hidden-mobile">k8s-理论</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">总访问量 <span id="busuanzi_value_site_pv"></span> 次 </span><span id="busuanzi_container_site_uv" style="display:none">总访客数 <span id="busuanzi_value_site_uv"></span> 人</span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>