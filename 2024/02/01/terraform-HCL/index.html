<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="https://cdn.jsdelivr.net/gh/occultagg/blog-pics/hexo-blog/202206120024516.ico"><link rel="icon" href="https://cdn.jsdelivr.net/gh/occultagg/blog-pics/hexo-blog/202206120024516.ico"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#2f4154"><meta name="author" content="Peter Pan"><meta name="keywords" content=""><meta name="description" content="本文记录一些关于terraform的语法,只记录一下我认为有必要记录的东西,本文绝大部分来自教程: https:&#x2F;&#x2F;lonegunmanb.github.io&#x2F;introduction-terraform&#x2F;  数据类型原始类型 string number bool  复杂类型 list(type): 下标从0开始,list(number)&#x2F;list(string)&#x2F;list(bool),用于声"><meta property="og:type" content="article"><meta property="og:title" content="terraform-HCL语法"><meta property="og:url" content="http://example.com/2024/02/01/terraform-HCL/index.html"><meta property="og:site_name" content="Any &amp; Nothing"><meta property="og:description" content="本文记录一些关于terraform的语法,只记录一下我认为有必要记录的东西,本文绝大部分来自教程: https:&#x2F;&#x2F;lonegunmanb.github.io&#x2F;introduction-terraform&#x2F;  数据类型原始类型 string number bool  复杂类型 list(type): 下标从0开始,list(number)&#x2F;list(string)&#x2F;list(bool),用于声"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/occultagg/blog-pics/hexo-blog/1*9-ILOQ1Yxautyc_uIguhVw.png"><meta property="article:published_time" content="2024-02-01T08:44:11.000Z"><meta property="article:modified_time" content="2024-12-11T09:52:23.058Z"><meta property="article:author" content="Peter Pan"><meta property="article:tag" content="terraform"><meta property="article:tag" content="HCL"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/occultagg/blog-pics/hexo-blog/1*9-ILOQ1Yxautyc_uIguhVw.png"><meta name="referrer" content="no-referrer-when-downgrade"><title>terraform-HCL语法 - Any &amp; Nothing</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"example.com",root:"/",version:"1.9.7",typing:{enable:!0,typeSpeed:70,cursorChar:"|",loop:!1,scope:["home"]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!0,offset_factor:2},web_analytics:{enable:!0,follow_dnt:!0,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml",include_content_in_search:!0};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Any & Nothing" type="application/atom+xml">
</head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Any &amp; Nothing</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/" target="_self"><i class="iconfont icon-home-fill"></i> <span>首页</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/" target="_self"><i class="iconfont icon-archive-fill"></i> <span>归档</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/" target="_self"><i class="iconfont icon-category-fill"></i> <span>分类</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/" target="_self"><i class="iconfont icon-tags-fill"></i> <span>标签</span></a></li><li class="nav-item"><a class="nav-link" href="/about/" target="_self"><i class="iconfont icon-user-fill"></i> <span>关于</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle">terraform-HCL语法</span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2024-02-01 16:44" pubdate>2024年2月1日 下午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 4.5k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 38 分钟</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 id="seo-header">terraform-HCL语法</h1><div class="markdown-body"><p><img src="https://cdn.jsdelivr.net/gh/occultagg/blog-pics/hexo-blog/1*9-ILOQ1Yxautyc_uIguhVw.png" srcset="/img/loading.gif" lazyload></p><blockquote><p>本文记录一些关于terraform的语法,只记录一下我认为有必要记录的东西,本文绝大部分来自教程: <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/">https://lonegunmanb.github.io/introduction-terraform/</a></p></blockquote><h1 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h1><h2 id="原始类型"><a href="#原始类型" class="headerlink" title="原始类型"></a>原始类型</h2><ul><li>string</li><li>number</li><li>bool</li></ul><h2 id="复杂类型"><a href="#复杂类型" class="headerlink" title="复杂类型"></a>复杂类型</h2><ul><li><code>list(type)</code>: 下标从<code>0</code>开始,<code>list(number)/list(string)/list(bool)</code>,用于声明时指定list的元素类型</li><li><code>map(...)</code>: 字典&#x2F;映射,key必须是<code>string</code>,value任意类型.声明方式推荐使用<code>=</code>: <code>&#123;foo=&quot;bar&quot;, bar=&quot;baz&quot;&#125;</code></li><li><code>set(...)</code>: 集合类型,代表一组<code>不重复的值</code></li></ul><h2 id="结构化类型"><a href="#结构化类型" class="headerlink" title="结构化类型"></a>结构化类型</h2><blockquote><p>一个结构化类型允许多个不同类型的值组成一个类型.结构化类型需要提供一个<code>schema</code>结构信息作为参数来指明元素的结构.</p></blockquote><ul><li><p><code>object(...)</code>: 允许多个不同类型作为值的map</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs terraform"># 声明&#123;&lt;KEY\=&lt;TYPE&gt;, &lt;KEY&gt;=&lt;TYPE&gt;,...&#125;<br>object(&#123;age=number, name=string&#125;)<br># 赋值时必须赋全,可以多,多的会被忽略<br>&#123; age=18, name=&quot;john&quot;, gender=&quot;male&quot; &#125; # 多出来的gender会被忽略<br></code></pre></td></tr></table></figure></li><li><p><code>tuple(...)</code>: 允许多个不同类型作为值的list</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs terraform"># 声明<br>tuple([string, number, bool])<br># 赋值时类型和数量要一致<br>[&quot;a&quot;, 15, true]<br></code></pre></td></tr></table></figure></li></ul><h2 id="any"><a href="#any" class="headerlink" title="any"></a>any</h2><p>terraform中一个特殊的类型约束,本身不是一个类型而是一个<code>占位符</code>,每当一个值被赋予<code>any</code>这个类型约束时,terraform会自动识别一个最精确的类型去取代<code>any</code>.</p><p>例如把<code>[&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]</code>赋值给<code>list(any)</code>, terraform最终赋值的类型是<code>list(string)</code>.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs terraform"># 声明一个无约束类型的变量,给terraform自己识别<br>variable &quot;no_type_constraint&quot; &#123;<br>    type = any<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="null"><a href="#null" class="headerlink" title="null"></a>null</h2><p><code>无类型</code>,代表数据缺失,如果我们将一个参数设置为<code>null</code>, terraform会认为你忘记给它赋值,如果有默认值就用默认值,没有默认值但是又是必填则会报错.</p><p>一般用于条件表达式中,在某项条件不满足时跳过对某参数的赋值.</p><h2 id="optional"><a href="#optional" class="headerlink" title="optional"></a>optional</h2><p><code>terraform &gt;= 1.3</code>引入的功能</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs terraform"># 声明一个object<br>variable &quot;an_object&quot; &#123;<br>  type = object(&#123;<br>    a = string<br>    b = string<br>    c = number<br>  &#125;)<br>&#125;<br># 赋值时,必须赋齐全,但是又不准备给b,c赋值,可以用null<br>&#123;<br>  a = &quot;a&quot;<br>  b = null<br>  c = null<br>&#125;<br># 但是加入object含有的参数很多且复杂,我们赋值时就会很麻烦,于是引入optional,在定义时候使用<br>variable &quot;with_optional_attribute&quot; &#123;<br>  type = object(&#123;<br>    a = string                # a required attribute<br>    b = optional(string)      # an optional attribute<br>    c = optional(number, 127) # an optional attribute with default value<br>  &#125;)<br>&#125;<br></code></pre></td></tr></table></figure><p><code>optional</code>有两个参数:</p><ul><li>类型: 必填,<code>第一个参数</code>标明属性的类型</li><li>默认值: 选填,如果object没有定义该属性,就使用默认值,没有默认值就使用<code>null</code></li></ul><p>所以optional<code>作用</code>如下: 定义这个参数的类型和默认值,如果没有赋值就使用默认值,如果没有默认值就赋值null.</p><h2 id="例子一"><a href="#例子一" class="headerlink" title="例子一"></a>例子一</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs terraform"># 定义一个bucket变量,获取bucket需要的属性<br>variable &quot;buckets&quot; &#123;<br>    type = list(object(&#123;<br>        name = string<br>        enabled = optional(bool, true)<br>        website = optional(object(&#123;<br>            index_document = optional(string, &quot;index.html&quot;)<br>            error_document = optional(string, &quot;error.html&quot;)<br>            routing_rules = optional(string)<br>            &#125;), &#123;&#125;)<br>        &#125;))<br>    &#125;<br></code></pre></td></tr></table></figure><blockquote><p>这里定义嵌套比较复杂,只是为了演示用法.</p><p>首先<code>buckets</code>是一个类型为<code>list</code>的变量,<code>list</code>里面元素类型是<code>object</code></p><p><code>website</code>是一个<code>optional</code>属性,类型为<code>object</code>,里面又有三个<code>optional</code>属性.</p><p>下面是一个赋值例子:</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs terraform">buckets = [<br>  &#123;<br>    name = &quot;production&quot;<br>    website = &#123;<br>      routing_rules = &lt;&lt;-EOT<br>      [<br>        &#123;<br>          &quot;Condition&quot; = &#123; &quot;KeyPrefixEquals&quot;: &quot;img/&quot; &#125;,<br>          &quot;Redirect&quot;  = &#123; &quot;ReplaceKeyPrefixWith&quot;: &quot;images/&quot; &#125;<br>        &#125;<br>      ]<br>      EOT<br>    &#125;<br>  &#125;,<br>  &#123;<br>    name = &quot;archived&quot;<br>    enabled = false<br>  &#125;,<br>  &#123;<br>    name = &quot;docs&quot;<br>    website = &#123;<br>      index_document = &quot;index.txt&quot;<br>      error_document = &quot;error.txt&quot;<br>    &#125;<br>  &#125;,<br>]<br></code></pre></td></tr></table></figure><blockquote><p>上面定义三个存储桶</p><p><code>production</code>桶配置了一条重定向的路由规则</p><p><code>archived</code>桶使用默认配置,但是是关闭的</p><p><code>docs</code>桶使用文本文件取代索引页和错误页</p></blockquote><h2 id="例子二"><a href="#例子二" class="headerlink" title="例子二"></a>例子二</h2><p>下面结合<code>表达式</code>去<code>有条件地设置一个默认值</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs terraform">variable &quot;legacy_filenames&quot; &#123;<br>  type     = bool<br>  default  = false<br>  # 不能为空<br>  nullable = false<br>&#125;<br><br>module &quot;buckets&quot; &#123;<br>  source = &quot;./modules/buckets&quot;<br><br>  buckets = [<br>    &#123;<br>      name = &quot;maybe_legacy&quot;<br>      website = &#123;<br>        # 根据legacy_filenames的值设置默认值<br>        error_document = var.legacy_filenames ? &quot;ERROR.HTM&quot; : null<br>        index_document = var.legacy_filenames ? &quot;INDEX.HTM&quot; : null<br>      &#125;<br>    &#125;,<br>  ]<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h1><h2 id="声明"><a href="#声明" class="headerlink" title="声明"></a>声明</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs terraform">variable &quot;image_id&quot; &#123;<br>  type        = string<br>  description = &quot;The id of the machine image (AMI) to use for the server.&quot;<br><br>variable &quot;name&quot; &#123;<br>    # 类型<br>    type    = string<br>    # 默认值<br>    default = &quot;John Doe&quot;<br>    # 描述(描述不是注释)<br>    description = &quot;The id of the machine image (AMI) to use for the server.&quot;<br>    # 在命令行输出中隐藏敏感值(依旧会记录在statefile中) terraform &gt;= 0.14 在某些情况下还是会暴露出来<br>    sensitive = true<br>    # 不允许为空<br>    nullable = false<br>    # 断言terraform &gt;= 0.13, condition的值必须是bool<br>    validation &#123;<br>      condition     = length(var.image_id) &gt; 4 &amp;&amp; substr(var.image_id, 0, 4) == &quot;ami-&quot;<br>      error_message = &quot;The image_id value must be a valid AMI id, starting with \&quot;ami-\&quot;.&quot;<br>   &#125;<br>    # 使用can来判断获取bool<br>    validation &#123;<br>    condition     = can(regex(&quot;^ami-&quot;, var.image_id))<br>    error_message = &quot;The image_id value must be a valid AMI id, starting with \&quot;ami-\&quot;.&quot;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="赋值"><a href="#赋值" class="headerlink" title="赋值"></a>赋值</h2><p>按以下优先级排序</p><ol><li><p>环境变量: <code>TF_VAR_name</code></p></li><li><p><code>terraform.tfvars</code>: 使用HCL语法</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs terraform">image_id = &quot;ami-abc123&quot;<br>availability_zone_names = [<br>  &quot;us-east-1a&quot;,<br>  &quot;us-west-1c&quot;,<br>]<br></code></pre></td></tr></table></figure></li><li><p><code>terraform.tfvars.json</code>: 使用json语法</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;image_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ami-abc123&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;availability_zone_names&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;us-west-1a&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;us-west-1c&quot;</span><span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li><li><p><code>*.auto.tfvars</code>或<code>*.auto.tfvars.json</code>,以文件名字母排序,同样一个HCL一个json</p></li><li><p><code>-var</code>参数或者<code>-var-filr</code></p></li><li><p>交互界面获取值</p></li></ol><h2 id="调用"><a href="#调用" class="headerlink" title="调用"></a>调用</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs terraform">var.availability_zone_names<br></code></pre></td></tr></table></figure><h1 id="输出"><a href="#输出" class="headerlink" title="输出"></a>输出</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs terraform">output &quot;instance_ip_addr&quot; &#123;<br>  value       = aws_instance.server.private_ip<br>  description = &quot;The private IP address of the main server instance.&quot;<br>  sensitive = true<br><br>  # 一般output不需要定义depends_on,如果要用到请写好注释<br>  depends_on = [<br>    # Security group rule must be created before this IP address could<br>    # actually be used, otherwise the services will be unreachable.<br>    aws_security_group_rule.local_access,<br>  ]<br>  # 类似validation块的validation,确保输出值满足某种要求,防止terraform把不合法的值写入状态文件<br>  # Precondition<br>  condition = var.enable_example_output<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>关于<code>depends_on</code>: 依赖关系是通过terraform的provider去分析的,一般是不需要显式定义,但有时候它不能计算出来(比如terraform或者provider的版本过旧,对一些新资源不能很好地计算,就需要用到depends_on)</p></blockquote><h1 id="locals"><a href="#locals" class="headerlink" title="locals"></a>locals</h1><p><code>locals</code>块用于定义本地变量,只能在<code>同一模块</code>内的代码中引用.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs terraform">locals &#123;<br>  common_tags = &#123;<br>    # 注意引用是使用local,声明使用locals<br>    Service = local.service_name<br>    Owner   = local.owner<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>一般来说,只有需要重复引用同一个复杂表达式的场景才使用locals</p></blockquote><h1 id="resource"><a href="#resource" class="headerlink" title="resource"></a>resource</h1><p>定义具体资源的块,也是接触最多的块.不同平台的不同资源的定义都有所不同,具体要查看具体平台具体资源的文档.</p><p><a target="_blank" rel="noopener" href="https://registry.terraform.io/browse/providers">terraform-registry文档</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs terraform"># resource关键字 resource_type local_name<br>resource &quot;aws_instance&quot; &quot;web&quot; &#123;<br>  ami           = &quot;ami-a1b2c3d4&quot;<br>  instance_type = &quot;t2.micro&quot;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>local_name只能在同一个模块内被引用,resource_type+local_name在同一个模块内必须是唯一</p></blockquote><h2 id="资源行为"><a href="#资源行为" class="headerlink" title="资源行为"></a>资源行为</h2><blockquote><p>当terraform对一个resource块执行apply操作,创建一个新的基础设施对象,会给这个对象分配一个<code>id</code>,并写入statefile.有了这个id,后续就可以对它对更新修改删除等操作.</p></blockquote><h2 id="resource的输出"><a href="#resource的输出" class="headerlink" title="resource的输出"></a>resource的输出</h2><p>通过以下语法获取resource的输出</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs terraform">&lt;RESOURCE TYPE&gt;.&lt;NAME&gt;.&lt;ATTRIBUTE&gt;<br></code></pre></td></tr></table></figure><p>具体的resource有哪些<code>attribute</code>供访问可以通过查阅registry文档获取.</p><h2 id="依赖与并行"><a href="#依赖与并行" class="headerlink" title="依赖与并行"></a>依赖与并行</h2><blockquote><p><code>depends_on</code>用于显式声明资源的依赖关系.</p><p>一般情况下,terraform自身可以通过分析resource块内的<code>表达式</code>,根据表达式的<code>引用链</code>获取资源在创建,更新,销毁时的执行顺序.</p><p>但是有些时候是计算不出来的:</p><p>例如，Terraform必须要创建一个访问控制权限资源，以及另一个需要该权限才能成功创建的资源。<code>后者的创建依赖于前者的成功创建</code>，然而这种依赖在代码中没有表现为<code>数据引用关联</code>,此时就需要<code>depends_on</code></p></blockquote><blockquote><p>默认情况下,terraform可以并行创建<code>10</code>个<code>无依赖关系</code>的资源.</p></blockquote><h2 id="元参数"><a href="#元参数" class="headerlink" title="元参数"></a>元参数</h2><p>定义在resource块内,用于改变资源的行为,上面提到的<code>depends_on</code>就是其中一个.</p><h3 id="depends-on"><a href="#depends-on" class="headerlink" title="depends_on"></a>depends_on</h3><blockquote><p>显示声明资源之间的依赖关系,只有当资源间确实存在依赖关系,但是彼此间又没有数据引用的场景下才有必要使用</p></blockquote><h3 id="count"><a href="#count" class="headerlink" title="count"></a>count</h3><p><code>count</code>指创建多少个相似的对象,创建的对象有单独的id和下标(0开始)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs terraform">resource &quot;aws_instance&quot; &quot;server&quot; &#123;<br>  count = 4 # create four similar EC2 instances<br><br>  ami           = &quot;ami-a1b2c3d4&quot;<br>  instance_type = &quot;t2.micro&quot;<br><br>  tags = &#123;<br>    Name = &quot;Server $&#123;count.index&#125;&quot;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>count.index</code>:代表当前对象对应的下标</li><li>访问: <code>&lt;TYPE&gt;.&lt;NAME&gt;[&lt;INDEX&gt;]</code></li><li>count的值可以是<code>任意自然数</code>也可以是<code>表达式</code>,但是不能引用任何其他资源的输出属性,不过可以应用<code>data</code>查询出来的输出属性(只要该data不依赖其他resource查询)</li></ul><h3 id="for-each"><a href="#for-each" class="headerlink" title="for_each"></a>for_each</h3><p>用于创建多个相似但有些属性不一样的资源</p><blockquote><p>terraform &gt;&#x3D; 0.12.6, 不能与<code>count</code>同时用在一个resource块内</p></blockquote><p><code>for_each</code>的值可以是<code>map</code>(通过<code>each.key</code>和<code>each.value</code>获取值)或者<code>set(string)</code>(通过<code>each.key</code>获取值)</p><p><code>for_each</code>所使用的键集合不能够包含或依赖非纯函数，也就是反复执行会返回不同返回值的函数(uuid, bcrypt, timestamp)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs terraform"># 使用map<br>resource &quot;azurerm_resource_group&quot; &quot;rg&quot; &#123;<br>  for_each = &#123;<br>    a_group = &quot;eastus&quot;<br>    another_group = &quot;westus2&quot;<br>  &#125;<br>  name     = each.key<br>  location = each.value<br>&#125;<br># 使用set(string)<br>resource &quot;aws_iam_user&quot; &quot;the-accounts&quot; &#123;<br>  for_each = toset( [&quot;Todd&quot;, &quot;James&quot;, &quot;Alice&quot;, &quot;Dottie&quot;] )<br>  name     = each.key<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="provider"><a href="#provider" class="headerlink" title="provider"></a>provider</h3><p>resource块内可以通过provider关键字声明该资源使用的provider.默认情况下,使用<code>资源类型第一个单词</code>所对应的provider.</p><p>比如<code>google_compute_instance</code>的默认provider就是<code>google</code>,<code>aws_instance</code>的默认Provider就是<code>aws</code>.</p><h3 id="lifecycle"><a href="#lifecycle" class="headerlink" title="lifecycle"></a>lifecycle</h3><p>针对一个资源对象定义不一样的行为方式</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs terraform">resource &quot;azurerm_resource_group&quot; &quot;example&quot; &#123;<br>  # ...<br><br>  lifecycle &#123;<br>    create_before_destroy = true<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>lifecycle和它的参数都属于元参数,可以被声明于任意类型的资源块内部.有如下的参数:</p><ul><li><p><code>create_before_destroy</code> (<code>bool</code>): 默认情况下,需要修改一个由于服务端API限制无法直接升级的资源时,terraform会<code>先删除旧对象</code>再<code>创建新对象</code>.本参数可以修改这个行为.设置为<code>true</code>,就会先创建新对象,新对象创建成功并取代老对象后再删除老对象.<code>默认</code>是false,因为大部分技术设施资源都需要有一个<code>唯一</code>的标识来防止冲突,即使在新老对象并存的时候也有有这个约束.但有些资源可以为每个对象添加一个随机的前缀来避免冲突,具体要看具体的资源类型在这方面的约束.</p></li><li><p><code>prevent_destroy</code> (<code>bool</code>): 这是一个<code>保险措施</code>,避免资源因为错误的执行<code>terraform destroy</code>或者因为错误地修改了某个参数导致<code>terraform决定删除并重建新的实例</code>这种情况下资源被删除.</p></li><li><p><code>ignore_changes</code> (<code>list(string)</code>)：忽略改变,某些场景下,某资源可以会被第三方控制而不停被修改,此时terraform每次都会把它改回来,如果需要避免这种情况,可以使用这个参数指定要忽略的<code>某些属性</code>的变更.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs terraform"># 忽视tags属性变更<br>resource &quot;aws_instance&quot; &quot;example&quot; &#123;<br>  # ...<br><br>  lifecycle &#123;<br>    ignore_changes = [<br>      # Ignore changes to tags, e.g. because a management agent<br>      # updates these based on some ruleset managed elsewhere.<br>      tags,<br>    ]<br>  &#125;<br>&#125;<br># 忽视map中特定元素的变更,必须确保map中含有这个元素<br>resource &quot;aws_instance&quot; &quot;example&quot; &#123;<br>  tags = &#123;<br>    Name = &quot;placeholder&quot;<br>  &#125;<br>  lifecycle &#123;<br>    ignore_changes = [<br>      tags[&quot;Name&quot;],<br>    ]<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>除了使用<code>list(string)</code>指定忽略的属性还可以使用<code>all</code>忽略所有属性的变更</p></li><li><p><code>replace_triggered_by</code>: 手动指定资源的哪些属性被修改时,强制触发<code>替换资源</code>这个操作.一般情况下用不到.</p></li></ul><h1 id="data"><a href="#data" class="headerlink" title="data"></a>data</h1><p><code>data</code>,数据源,用于查询或计算数据供其他地方使用.数据源是provider定义的,不同的平台有不同的数据源可供查询.因此数据源的具体定义可以通过查registry文档获取.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs terraform"># 定义<br>data &quot;aws_ami&quot; &quot;web&quot; &#123;<br>  filter &#123;<br>    name   = &quot;state&quot;<br>    values = [&quot;available&quot;]<br>  &#125;<br><br>  filter &#123;<br>    name   = &quot;tag:Component&quot;<br>    values = [&quot;web&quot;]<br>  &#125;<br><br>  most_recent = true<br>&#125;<br># 使用<br>resource &quot;aws_instance&quot; &quot;web&quot; &#123;<br>  ami           = data.aws_ami.web.id<br>  instance_type = &quot;t1.micro&quot;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="dynamic块"><a href="#dynamic块" class="headerlink" title="dynamic块"></a>dynamic块</h1><p>比如在resource块中,如果某些资源包含了可重复的内嵌块,此时可以使用dynamic循环赋值.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs terraform"># 语法如下<br>dynamic &quot;block_type&quot; &#123;<br>  for_each = expression<br>  content &#123;<br>    # Block content<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>下面举个例子:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs terraform">variable &quot;subnets&quot; &#123;<br>  type = list(object(&#123;<br>    name     = string<br>    cidr     = string<br>    zone     = string<br>    resource = string<br>  &#125;))<br>&#125;<br><br>resource &quot;aws_subnet&quot; &quot;example_subnet&quot; &#123;<br>  dynamic &quot;subnet&quot; &#123;<br>    for_each = var.subnets<br>    content &#123;<br>      availability_zone = subnet.value.zone<br>      cidr_block        = subnet.value.cidr<br>      tags = &#123;<br>        Name = subnet.value.name<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>上面的例子中,首先定义了一个<code>subnets</code>的变量,由子网所需属性(name,cidr,zone,resource)的对象构成.(<code>list(object)</code>)</p><p>然后定义<code>subnet</code>这个dynamic块.<code>for_each</code>负责迭代对象<code>var.subnets</code></p><p><code>content</code>负责给属性赋值</p><p>值通过<code>subnet.value.zone</code>形式引用,注意引用值第一节字符串用的是<code>dynamic块的名字</code></p></blockquote><blockquote><p>过多的dynamic块会导致代码难以阅读和维护,建议只在需要构造可重用的模块代码时使用.</p></blockquote><h1 id="check"><a href="#check" class="headerlink" title="check"></a>check</h1><p><code>terraform &gt;= 1.5</code>,check 块中可以定义一个<code>有限作用范围的data块</code>以及<code>至少一个</code>断言.用于<code>验证基础设状态</code>.</p><p>check会在每次<code>plan</code>或<code>apply</code>后执行的自定义验证,作为plan或apply的最后一步执行.</p><blockquote><p><code>assert</code> 是一种在 <code>check</code> 块中使用的断言机制。<code>check</code> 块用于定义验证规则，而 <code>assert</code> 块用于在验证规则中定义断言逻辑。断言是一种用于检查条件是否为真的方法。在 <code>check</code> 块中，你可以使用 <code>assert</code> 块来添加额外的断言逻辑，以确保特定条件为真。如果断言条件为假，Terraform 将输出错误消息。</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs terraform"># 定义一个名为health_check的check块<br>check &quot;health_check&quot; &#123;<br>  data &quot;http&quot; &quot;terraform_io&quot; &#123;<br>    url = &quot;https://www.terraform.io&quot;<br>  &#125;<br><br>  assert &#123;<br>    condition = data.http.terraform_io.status_code == 200<br>    error_message = &quot;$&#123;data.http.terraform_io.url&#125; returned an unhealthy status code&quot;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="module"><a href="#module" class="headerlink" title="module"></a>module</h1><h2 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h2><p>所有包含terraform代码文件的文件夹都是一个terraform模块.直接执行<code>terraform plan/apply</code>的文件夹称为<code>根模块</code></p><p>举个例子说明模块的结构:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs shell">. # 根模块<br>├── README.md<br>├── main.tf<br>├── variables.tf<br>├── outputs.tf<br>├── ...<br>├── modules/ # modules文件夹用于存放子模块<br>│   ├── nestedA/ # 子模块1,名为nestedA<br>│   │   ├── README.md # 说明文档<br>│   │   ├── variables.tf # 模块使用的变量<br>│   │   ├── main.tf # 模块的主要入口<br>│   │   ├── outputs.tf # 模块的输出<br>│   ├── nestedB/ # 子模块2,名为nestedB<br>│   ├── .../<br>├── examples/ # 用来给出调用样例(可选),有example中代码经常会被复制到别的地方使用.所以里面的路径最好不要写相对路径<br>│   ├── exampleA/<br>│   │   ├── main.tf<br>│   ├── exampleB/<br>│   ├── .../<br></code></pre></td></tr></table></figure><blockquote><p>模块结构不宜过深,保持一层嵌入就可以了</p></blockquote><h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><p>通过<code>module</code>块的<code>source</code>关键字来指定模块的源,支持的模块源有:</p><ul><li><p>本地</p><ul><li><p>本地路径必须以<code>./</code>或<code>../</code>为前缀来声明使用的是本地路径,除了本地源,其他源的模块引用都要先下载代码才能使用</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs terraform">module &quot;consul&quot; &#123;<br>  source = &quot;./consul&quot;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul></li><li><p>terraform registry</p><ul><li><p>官方仓库: <a target="_blank" rel="noopener" href="https://registry.terraform.io/">公共仓库</a>,也可以通过terraform cloud维护一个私有模块仓库,或者通过实现 <a target="_blank" rel="noopener" href="https://www.terraform.io/docs/registry/api.html">Terraform 模块注册协议</a>来实现一个私有仓库.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs terraform">module &quot;consul&quot; &#123;<br>  # 公共仓库的的模块可以用 &lt;NAMESPACE&gt;/&lt;NAME&gt;/&lt;PROVIDER&gt; 形式的源地址来引用，在公共仓库上的模块介绍页面上都包含了确切的源地址<br>  source = &quot;hashicorp/consul/aws&quot;<br>  version = &quot;0.1.0&quot;<br>&#125;<br># 托管在其他仓库的模块，在源地址头部添加 &lt;HOSTNAME&gt;/ 部分，指定私有仓库的主机名<br>module &quot;consul&quot; &#123;<br>  source = &quot;app.terraform.io/example-corp/k8s-cluster/azurerm&quot;<br>  version = &quot;1.1.0&quot;<br>&#125; <br></code></pre></td></tr></table></figure></li></ul></li><li><p>github</p><ul><li><p>以<code>gitHub.com</code>为前缀指定</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs terraform"># 默认使用HTTPS协议克隆仓库<br>module &quot;consul&quot; &#123;<br>  source = &quot;github.com/hashicorp/example&quot;<br>&#125;<br># 使用ssh协议  <br>module &quot;consul&quot; &#123;<br>  source = &quot;git@github.com:hashicorp/example.git&quot;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul></li><li><p>bitbucket</p><ul><li><code>bitbucket.org</code> 为前缀</li></ul></li><li><p>git&#x2F;mercurial仓库</p><ul><li><p>git仓库: <code>git::</code> 为前缀</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs terraform"># https, ref参数指定分支<br>module &quot;vpc&quot; &#123;<br>  source = &quot;git::https://example.com/vpc.git?ref=v1.2.0&quot;<br>&#125;<br># ssh<br>module &quot;storage&quot; &#123;<br>  source = &quot;git::ssh://username@example.com/storage.git&quot;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>Mercurial 仓库: <code>hg::</code> 前缀</p></li></ul></li><li><p>HTTP地址</p></li><li><p>S3</p><ul><li><code>s3::</code></li></ul></li><li><p>GCS</p><ul><li><code>gcs::</code></li></ul></li><li><p>引用子文件夹中的模块,例如:</p><ul><li><code>hashicorp/consul/aws//modules/consul-cluster</code></li><li><code>git::https://example.com/network.git//modules/vpc</code></li><li><code>https://example.com/network-module.zip//modules/vpc</code></li><li><code>s3::https://s3-eu-west-1.amazonaws.com/examplecorp-terraform-modules/network.zip//modules/vpc</code></li></ul></li></ul><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>引用后直接再module块内给模块的变量赋值就能使用</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs terraform">module &quot;servers&quot; &#123;<br>  source = &quot;./app-cluster&quot;<br><br>  servers = 5<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="引用模块输出值"><a href="#引用模块输出值" class="headerlink" title="引用模块输出值"></a>引用模块输出值</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs terraform">resource &quot;aws_elb&quot; &quot;example&quot; &#123;<br>  # ...<br><br>  instances = module.servers.instance_ids<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="模块内的provider"><a href="#模块内的provider" class="headerlink" title="模块内的provider"></a>模块内的provider</h2><p>一般来说,旨在复用的模块内是不能定义任何provider的.</p><h3 id="隐式继承"><a href="#隐式继承" class="headerlink" title="隐式继承"></a>隐式继承</h3><p>默认情况下子模块会自动从调用者那里继承默认的provider配置.</p><h3 id="显式声明"><a href="#显式声明" class="headerlink" title="显式声明"></a>显式声明</h3><p>如果不同的子模块需要不同的provider,或者子模块需要的provider与调用者自己使用的不同时,则需要显式声明.</p><p>比如一个模块配置了两个aws区域之间的网络打通,所以需要配置一个源区域provider和目标区域provider.根模块代码看起来应该是这样的:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs terraform">provider &quot;aws&quot; &#123;<br>  alias  = &quot;usw1&quot;<br>  region = &quot;us-west-1&quot;<br>&#125;<br><br>provider &quot;aws&quot; &#123;<br>  alias  = &quot;usw2&quot;<br>  region = &quot;us-west-2&quot;<br>&#125;<br><br>module &quot;tunnel&quot; &#123;<br>  source    = &quot;./tunnel&quot;<br>  providers = &#123;<br>    aws.src = aws.usw1<br>    aws.dst = aws.usw2<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>而模块tunnel中必须包含下面的例子那样声明<code>provider别名</code>,声明模块调用者必须使用这些名字传递provider</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs terraform">provider &quot;aws&quot; &#123;<br>  alias = &quot;src&quot;<br>&#125;<br><br>provider &quot;aws&quot; &#123;<br>  alias = &quot;dst&quot;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>alias</code>是provider代理配置的参数,它是一个模块间传递provider配置的占位符.</p><h1 id="实践例子"><a href="#实践例子" class="headerlink" title="实践例子"></a>实践例子</h1><h2 id="有条件创建"><a href="#有条件创建" class="headerlink" title="有条件创建"></a>有条件创建</h2><p>这是很常用的一个例子,使用count+表达式实现</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs terraform">variable &quot;allocate_public_ip&quot; &#123;<br>  description = &quot;Decide whether to allocate a public ip and bind it to the host&quot;<br>  type = bool<br>  default = false<br>&#125;<br><br>resource &quot;ucloud_eip&quot; &quot;public_ip&quot; &#123;<br>  count = var.allocate_public_ip ? 1 : 0<br>  name = &quot;public_ip_for_$&#123;ucloud_instance.web.name&#125;&quot;<br>  internet_type = &quot;bgp&quot;<br>&#125;<br><br>resource &quot;ucloud_eip_association&quot; &quot;public_ip_binding&quot; &#123;<br>  count = var.allocate_public_ip ? 1 : 0<br>  eip_id = ucloud_eip.public_ip[0].id<br>  resource_id = ucloud_instance.web.id<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="target参数"><a href="#target参数" class="headerlink" title="-target参数"></a>-target参数</h2><p>多人团队执行terraform时,建议<code>以module为单位</code>运行.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">terraform plan/apply --target module.&lt;module-name&gt;<br></code></pre></td></tr></table></figure><h2 id="–plugin-dir"><a href="#–plugin-dir" class="headerlink" title="–plugin-dir"></a>–plugin-dir</h2><p>所处网络环境比较严格,只能手动下载provider等插件,需要手动指定插件目录</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">terraform init --plugin-dir=&lt;path-to-plugins&gt;<br></code></pre></td></tr></table></figure></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/Devops/" class="category-chain-item">Devops</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/terraform/" class="print-no-link">#terraform</a> <a href="/tags/HCL/" class="print-no-link">#HCL</a></div></div><div class="license-box my-3"><div class="license-title"><div>terraform-HCL语法</div><div>http://example.com/2024/02/01/terraform-HCL/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>Peter Pan</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2024年2月1日</div></div><div class="license-meta-item"><div>许可协议</div><div><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2024/02/03/kafka-must-know/" title="kakfa-必知必会"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">kakfa-必知必会</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2024/01/31/terraform-must-know/" title="terraform-必知必会"><span class="hidden-mobile">terraform-必知必会</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">总访问量 <span id="busuanzi_value_site_pv"></span> 次 </span><span id="busuanzi_container_site_uv" style="display:none">总访客数 <span id="busuanzi_value_site_uv"></span> 人</span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>