<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="https://cdn.jsdelivr.net/gh/occultagg/blog-pics/hexo-blog/202206120024516.ico"><link rel="icon" href="https://cdn.jsdelivr.net/gh/occultagg/blog-pics/hexo-blog/202206120024516.ico"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#2f4154"><meta name="author" content="Peter Pan"><meta name="keywords" content=""><meta name="description" content="外部Prometheus 关于prometheus监控k8s集群的方案可以看看:  prometheus-book 这篇文章  以上两篇参考都是将prometheus部署在集群内为前提,本文是将Prometheus部署在集群外部,主要参考了:  这篇博客 和ChatGPT-4   kube-state-metrics 用于生成关于 Kubernetes 对象状态的广泛指标。它从 Kubernete"><meta property="og:type" content="article"><meta property="og:title" content="k8s-监控与日志"><meta property="og:url" content="http://example.com/2024/02/16/k8s-monitor-2/index.html"><meta property="og:site_name" content="Any &amp; Nothing"><meta property="og:description" content="外部Prometheus 关于prometheus监控k8s集群的方案可以看看:  prometheus-book 这篇文章  以上两篇参考都是将prometheus部署在集群内为前提,本文是将Prometheus部署在集群外部,主要参考了:  这篇博客 和ChatGPT-4   kube-state-metrics 用于生成关于 Kubernetes 对象状态的广泛指标。它从 Kubernete"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://airpablog.s3.amazonaws.com/full/prometheus-grafana-logo.PNG"><meta property="article:published_time" content="2024-02-16T13:43:18.000Z"><meta property="article:modified_time" content="2024-12-11T09:52:23.057Z"><meta property="article:author" content="Peter Pan"><meta property="article:tag" content="prometheus"><meta property="article:tag" content="k8s"><meta property="article:tag" content="CRD"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://airpablog.s3.amazonaws.com/full/prometheus-grafana-logo.PNG"><meta name="referrer" content="no-referrer-when-downgrade"><title>k8s-监控与日志 - Any &amp; Nothing</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"example.com",root:"/",version:"1.9.7",typing:{enable:!0,typeSpeed:70,cursorChar:"|",loop:!1,scope:["home"]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!0,offset_factor:2},web_analytics:{enable:!0,follow_dnt:!0,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml",include_content_in_search:!0};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Any & Nothing" type="application/atom+xml">
</head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Any &amp; Nothing</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/" target="_self"><i class="iconfont icon-home-fill"></i> <span>首页</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/" target="_self"><i class="iconfont icon-archive-fill"></i> <span>归档</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/" target="_self"><i class="iconfont icon-category-fill"></i> <span>分类</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/" target="_self"><i class="iconfont icon-tags-fill"></i> <span>标签</span></a></li><li class="nav-item"><a class="nav-link" href="/about/" target="_self"><i class="iconfont icon-user-fill"></i> <span>关于</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle">k8s-监控与日志</span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2024-02-16 21:43" pubdate>2024年2月16日 晚上</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 6.4k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 54 分钟</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 id="seo-header">k8s-监控与日志</h1><div class="markdown-body"><h1 id="外部Prometheus"><a href="#外部Prometheus" class="headerlink" title="外部Prometheus"></a>外部Prometheus</h1><blockquote><p>关于prometheus监控k8s集群的方案可以看看:</p><ul><li><a target="_blank" rel="noopener" href="https://yunlzheng.gitbook.io/prometheus-book/part-iii-prometheus-shi-zhan/readmd">prometheus-book</a></li><li><a target="_blank" rel="noopener" href="https://anthing.cn/2023/03/20/k8s-monitor/">这篇文章</a></li></ul><p>以上两篇参考都是将prometheus部署在<code>集群内</code>为前提,本文是将Prometheus部署在<code>集群外部</code>,主要参考了:</p><ul><li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/ygbh/p/17328667.html#_label4">这篇博客</a></li><li>和ChatGPT-4</li></ul></blockquote><h2 id="kube-state-metrics"><a href="#kube-state-metrics" class="headerlink" title="kube-state-metrics"></a>kube-state-metrics</h2><blockquote><p>用于生成关于 Kubernetes 对象状态的广泛指标。它从 Kubernetes API 获取元数据，然后转化成Prometheus指标格式以供Prometheus等监控系统使用。它生成的是”静态”数据，例如一个Deployment有多少副本正在运行，一个Service有多少个Endpoints，等等。跟<code>metrics-server</code>是两个不同的东西,作用场景野不一样.</p><ul><li><strong>kube-state-metrics</strong> 不能提供HPA和VPA所需的实时资源使用数据。</li><li><strong>metrics-server</strong> 不像<code>kube-state-metrics</code>那样提供关于Kubernetes对象状态的丰富指标。</li></ul></blockquote><h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">需要魔法</span><br>helm repo add prometheus-community https://prometheus-community.github.io/helm-charts<br>helm repo update<br><span class="hljs-meta prompt_"># </span><span class="language-bash">拉到本地</span><br>helm pull prometheus-community/kube-state-metrics <br><span class="hljs-meta prompt_"># </span><span class="language-bash">修改镜像源使用代理(因为kubelet不能直接使用系统代理下载镜像)</span><br>sed -i &quot;+registry.k8s.io+k8s.dockerproxy.com+&quot; kube-state-metrics/values.yaml<br><span class="hljs-meta prompt_"># </span><span class="language-bash">安装</span><br>helm install kube-state-metrics ./kube-state-metrics/<br><span class="hljs-meta prompt_"># </span><span class="language-bash">由于Prometheus在集群的外部,所以需要部署个ingress将kube-state-metrics的api暴露出来</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">如果是生产环境最好配置https</span><br>cat &gt; kube-state-metrics-ingress.yaml &lt;&lt;EOF<br>apiVersion: networking.k8s.io/v1<br>kind: Ingress<br>metadata:<br>  name: kube-state-metrics-ingress<br>  namespace: default<br>  annotations:<br>    kubernetes.io/ingress.class: &quot;nginx&quot;<br>spec:<br>  rules:<br>  - http:<br>      paths:<br>      - path: /metrics<br>        pathType: ImplementationSpecific<br>        backend:<br>          service:<br>            name: kube-state-metrics<br>            port:<br>              number: 8080<br>EOF<br>kubectl apply -f kube-state-metrics-ingress<br></code></pre></td></tr></table></figure><blockquote><p>默认kube-state-metrics使用本地存储(应该都是些监控数据,部署prometheus获取后会存在prometheus中,所以应该不重要)且副本数为1,生产环境中部署要注意修改.</p></blockquote><h2 id="prometheus和grafana配置"><a href="#prometheus和grafana配置" class="headerlink" title="prometheus和grafana配置"></a>prometheus和grafana配置</h2><p>prometheus配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">scrape_configs:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">k8s-kube-state-metrics-peter-cluster</span><br>  <span class="hljs-attr">honor_timestamps:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">metrics_path:</span> <span class="hljs-string">/metrics</span><br>  <span class="hljs-attr">scheme:</span> <span class="hljs-string">http</span><br>  <span class="hljs-attr">static_configs:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">&#x27;&lt;ip&gt;:&lt;port&gt;&#x27;</span>]<br>  <span class="hljs-attr">metric_relabel_configs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">target_label:</span> <span class="hljs-string">cluster</span><br>    <span class="hljs-attr">replacement:</span> <span class="hljs-string">peter-cluster</span><br></code></pre></td></tr></table></figure><p>grafana使用dashboard: <a target="_blank" rel="noopener" href="https://grafana.com/grafana/dashboards/13332-kube-state-metrics-v2/">kube-state-metrics-v2</a></p><p>接下来就是grafana的数据源,每个图表的promql等微调了(全是图形界面).</p><p>kube-state-metrics的metrics非常丰富,上面的dashboard只是用到一小部分,实际使用要根据具体环境自己创建dashboard.</p><h2 id="原生metrics"><a href="#原生metrics" class="headerlink" title="原生metrics"></a>原生metrics</h2><p>k8s原生组件自带metrics API,下面以API-server为例子,演示如何通过<code>TLS</code>联通<code>外部的</code>Prometheus:</p><ol><li><p>要使外部的Prometheus可以安全访问首先要给它创建SA,绑定token并授权</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-monitor-sa</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">prometheus</span> <span class="hljs-comment"># SA是namespace级资源,为了好区分,我给它额外创建了个promethes的namespace</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-monitor-cr</span><br><span class="hljs-attr">rules:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">nodes</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">nodes/proxy</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">pods/proxy</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">nodes/metrics</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">services</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">endpoints</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">pods</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ingresses</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">configmaps</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">get</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;extensions&quot;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;networking.k8s.io&quot;</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ingresses/status</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ingresses</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">get</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">nonResourceURLs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;/metrics&quot;</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">get</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRoleBinding</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-monitor-crb</span><br><span class="hljs-attr">subjects:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-monitor-sa</span><br>    <span class="hljs-attr">namespace:</span> <span class="hljs-string">prometheus</span><br><span class="hljs-attr">roleRef:</span><br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br>  <span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-monitor-cr</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Secret</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-monitor-tk</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">prometheus</span> <span class="hljs-comment"># secret是namespace级资源,为了好区分,我给它额外创建了个promethes的namespace</span><br>  <span class="hljs-attr">annotations:</span><br>    <span class="hljs-attr">kubernetes.io/service-account.name:</span> <span class="hljs-string">prometheus-monitor-sa</span><br><span class="hljs-attr">type:</span> <span class="hljs-string">kubernetes.io/service-account-token</span><br></code></pre></td></tr></table></figure></li><li><p>生成token文件并传到prometheus服务器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl get secrets -n prometheus prometheus-monitor-tk -o jsonpath=&quot;&#123;.data.token&#125;&quot; | base64 --decode &gt; prometheus.token<br><span class="hljs-meta prompt_"># </span><span class="language-bash">然后scp传过去</span><br></code></pre></td></tr></table></figure></li><li><p>除了token文件,ca证书也要传过去: <code>/etc/kubernetes/pki/ca.crt</code></p></li><li><p>配置Prometheus</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">scrape_configs:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">kubernetes-apiservers</span><br>  <span class="hljs-comment"># k8s自动发现</span><br>  <span class="hljs-attr">kubernetes_sd_configs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">role:</span> <span class="hljs-string">endpoints</span><br>    <span class="hljs-attr">api_server:</span> <span class="hljs-string">https://&lt;api-server_ip&gt;:&lt;api-server_port&gt;</span><br>    <span class="hljs-attr">bearer_token_file:</span> <span class="hljs-string">/root/prometheus/pki/prometheus.token</span><br>    <span class="hljs-attr">tls_config:</span><br>      <span class="hljs-attr">ca_file:</span> <span class="hljs-string">/root/prometheus/pki/ca.crt</span><br>      <span class="hljs-comment"># 由于使用的是自签证书所以要skip_verify</span><br>      <span class="hljs-attr">insecure_skip_verify:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">relabel_configs:</span><br>  <span class="hljs-comment"># 根据regex正则匹配下面的source_labels,匹配上的就keep(保留下来写入Prometheus)</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">action:</span> <span class="hljs-string">keep</span><br>    <span class="hljs-attr">regex:</span> <span class="hljs-string">.+;kubernetes;https</span><br>    <span class="hljs-comment"># 使用k8s自动发现获取的metrics,Prometheus会给它添加上一些labels,这里是根据这些labels做了些过滤</span><br>    <span class="hljs-attr">source_labels:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">__meta_kubernetes_namespace</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">__meta_kubernetes_service_name</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">__meta_kubernetes_endpoint_port_name</span><br>  <span class="hljs-attr">scheme:</span> <span class="hljs-string">https</span><br>  <span class="hljs-attr">bearer_token_file:</span> <span class="hljs-string">/root/prometheus/pki/prometheus.token</span><br>  <span class="hljs-attr">tls_config:</span><br>    <span class="hljs-attr">insecure_skip_verify:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure></li></ol><h3 id="常用metrics"><a href="#常用metrics" class="headerlink" title="常用metrics"></a>常用metrics</h3><p>ChatGPT-4生成:</p><blockquote><p>kube-apiserver:</p><ul><li><strong>apiserver_request_total</strong>: API 服务器处理的请求数量。</li><li><strong>apiserver_request_duration_seconds</strong>: 请求的处理时间。</li><li><strong>apiserver_client_certificate_expiration_seconds</strong>: 客户端证书的过期时间大小。</li></ul><p>etcd:</p><ul><li><strong>etcd_request_duration_seconds</strong>: ETCD 存储请求的延迟时间。</li><li><strong>etcd_disk_wal_fsync_duration_seconds</strong>: 写入和同步预写日志文件操作所花费的时间。</li><li><strong>etcd_network_client_grpc_received_bytes_total</strong>: 通过 gRPC 接收的字节总数。</li></ul><p>kube-controller-manager:</p><ul><li><strong>workqueue_depth</strong>: 工作队列的深度。</li><li><strong>workqueue_adds_total</strong>: 添加到工作队列的总项目数。</li><li><strong>controller_runtime_reconcile_time_seconds</strong>: 控制器中 reconcile 方法的耗时。</li></ul><p>kube-scheduler:</p><ul><li><strong>scheduler_e2e_scheduling_duration_seconds</strong>: 调度程序从开始调度到完成调度的时间。</li><li><strong>scheduler_schedule_attempts_total</strong>: 调度尝试的总数，按结果进行分类。</li><li><strong>scheduler_pod_preemption_victims</strong>: 每次抢占事件中的受害者 pod 数量。</li></ul></blockquote><h1 id="内部Prometheus"><a href="#内部Prometheus" class="headerlink" title="内部Prometheus"></a>内部Prometheus</h1><h2 id="使用deployment部署"><a href="#使用deployment部署" class="headerlink" title="使用deployment部署"></a>使用deployment部署</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-config</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br><span class="hljs-attr">data:</span><br>  <span class="hljs-attr">prometheus.yml:</span> <span class="hljs-string">|</span><br><span class="hljs-string">    global:</span><br><span class="hljs-string">      scrape_interval:     15s</span><br><span class="hljs-string">      evaluation_interval: 15s</span><br><span class="hljs-string">    scrape_configs:</span><br><span class="hljs-string">      - job_name: &#x27;prometheus&#x27;</span><br><span class="hljs-string">        static_configs:</span><br><span class="hljs-string">        - targets: [&#x27;localhost:9090&#x27;]</span><br><span class="hljs-string">      - job_name: k8s-kube-state-metrics-peter-cluster</span><br><span class="hljs-string">        honor_timestamps: true</span><br><span class="hljs-string">        metrics_path: /metrics</span><br><span class="hljs-string">        scheme: http</span><br><span class="hljs-string">        static_configs:</span><br><span class="hljs-string">        # 与kube-state-metrics不同namespace,跨namespace访问要写全域名</span><br><span class="hljs-string">          - targets: [&#x27;kube-state-metrics.default.svc.cluster.local:8080&#x27;]</span><br><span class="hljs-string">        metric_relabel_configs:</span><br><span class="hljs-string">        - target_label: cluster</span><br><span class="hljs-string">          replacement: peter-cluster</span><br><span class="hljs-string"></span><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-deployment</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">prometheus</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">prometheus</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">prometheus</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">prom/prometheus:v2.31.1</span><br>        <span class="hljs-attr">ports:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">9090</span><br>        <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">config-volume</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/prometheus</span><br>      <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">config-volume</span><br>        <span class="hljs-attr">configMap:</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-config</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-service</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">ClusterIP</span><br>  <span class="hljs-attr">ports:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">9090</span><br>    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">9090</span><br>    <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">prometheus</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Ingress</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-ingress</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">ingressClassName:</span> <span class="hljs-string">nginx</span><br>  <span class="hljs-attr">rules:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">http:</span><br>      <span class="hljs-attr">paths:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">path:</span> <span class="hljs-string">/</span><br>        <span class="hljs-attr">pathType:</span> <span class="hljs-string">ImplementationSpecific</span><br>        <span class="hljs-attr">backend:</span><br>          <span class="hljs-attr">service:</span><br>            <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-service</span><br>            <span class="hljs-attr">port:</span><br>              <span class="hljs-attr">number:</span> <span class="hljs-number">9090</span><br></code></pre></td></tr></table></figure><h2 id="Prometheus-Operator"><a href="#Prometheus-Operator" class="headerlink" title="Prometheus-Operator"></a>Prometheus-Operator</h2><h3 id="CRD"><a href="#CRD" class="headerlink" title="CRD"></a>CRD</h3><p>在了解Operator之前,先来了解一下CRD(CustomResourceDefinition).</p><blockquote><ol><li><p>想象k8s是一个可扩展的积木系统,那么它原有的积木类型(内置资源类型)有:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-string">Pod</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">Service</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">Deployment</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">ConfigMap</span><br><span class="hljs-string">...</span><br></code></pre></td></tr></table></figure></li><li><p>就是客制化定义一个新的资源类型,比如定义一个prometheus资源类型</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 通过 CRD 定义一个新的&quot;积木类型&quot; - Prometheus</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apiextensions.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">CustomResourceDefinition</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">prometheuses.monitoring.coreos.com</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-comment"># 定义这个&quot;新积木&quot;的规格</span><br>  <span class="hljs-attr">group:</span> <span class="hljs-string">monitoring.coreos.com</span><br>  <span class="hljs-attr">names:</span><br>    <span class="hljs-attr">kind:</span> <span class="hljs-string">Prometheus</span>    <span class="hljs-comment"># 新资源类型的名字</span><br>    <span class="hljs-attr">plural:</span> <span class="hljs-string">prometheuses</span><br>  <span class="hljs-attr">scope:</span> <span class="hljs-string">Namespaced</span><br>  <span class="hljs-attr">versions:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">v1</span><br>      <span class="hljs-attr">served:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">storage:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">schema:</span><br>        <span class="hljs-comment"># 定义这个&quot;新积木&quot;可以有哪些属性</span><br>        <span class="hljs-attr">openAPIV3Schema:</span><br>          <span class="hljs-attr">properties:</span><br>            <span class="hljs-attr">spec:</span><br>              <span class="hljs-attr">type:</span> <span class="hljs-string">object</span><br>              <span class="hljs-attr">properties:</span><br>                <span class="hljs-attr">replicas:</span><br>                  <span class="hljs-attr">type:</span> <span class="hljs-string">integer</span><br>                <span class="hljs-attr">version:</span><br>                  <span class="hljs-attr">type:</span> <span class="hljs-string">string</span><br></code></pre></td></tr></table></figure></li><li><p>CRD从创建到可用大概过程</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">步骤</span> <span class="hljs-attr">1:</span> <span class="hljs-string">注册新的&quot;积木类型&quot;</span><br><span class="hljs-string">┌────────────────┐</span><br><span class="hljs-string">│</span> <span class="hljs-string">提交</span> <span class="hljs-string">CRD</span> <span class="hljs-string">定义</span>   <span class="hljs-string">│</span><br><span class="hljs-string">└────────────────┘</span><br>        <span class="hljs-string">↓</span><br><span class="hljs-string">步骤</span> <span class="hljs-attr">2:</span> <span class="hljs-string">API</span> <span class="hljs-string">Server</span> <span class="hljs-string">处理</span> <span class="hljs-string">(等待Kubernetes完全理解和接受这个新类型)</span><br><span class="hljs-string">┌─────────────────────┐</span><br><span class="hljs-string">│</span> <span class="hljs-bullet">-</span> <span class="hljs-string">验证定义</span>          <span class="hljs-string">│</span><br><span class="hljs-string">│</span> <span class="hljs-bullet">-</span> <span class="hljs-string">创建新的</span> <span class="hljs-string">API</span> <span class="hljs-string">端点</span>  <span class="hljs-string">│</span><br><span class="hljs-string">│</span> <span class="hljs-bullet">-</span> <span class="hljs-string">设置数据存储</span>      <span class="hljs-string">│</span><br><span class="hljs-string">└─────────────────────┘</span><br>        <span class="hljs-string">↓</span><br><span class="hljs-string">步骤</span> <span class="hljs-attr">3:</span> <span class="hljs-string">CRD</span> <span class="hljs-string">变为可用状态</span><br><span class="hljs-string">┌────────────────────┐</span><br><span class="hljs-string">│</span> <span class="hljs-string">现在可以创建新类型</span>  <span class="hljs-string">│</span><br><span class="hljs-string">└────────────────────┘</span><br></code></pre></td></tr></table></figure></li></ol></blockquote><h3 id="CR"><a href="#CR" class="headerlink" title="CR"></a>CR</h3><p>可以这么理解CRD是类,CR则是类的具体实例.</p><h1 id="日志收集方案"><a href="#日志收集方案" class="headerlink" title="日志收集方案"></a>日志收集方案</h1><h2 id="技术栈选择"><a href="#技术栈选择" class="headerlink" title="技术栈选择"></a>技术栈选择</h2><p><code>elasticsearch+logstash+kibana</code>: 是最著名的日志收集方案,但是elasticsearch和kibana在新版本中都推出企业lic,不能免费使用它的全功能,所以要么使用旧版本,要么只使用它的部分功能,要么给钱.至于logstash,则有不少更轻量或更新的替代产品,比如loki,Fluentd等,都是开源的.这方面的选择就比较多.</p><p><code>Prometheus+grafana+loki</code>: 比较适合中小型集群,这个技术栈的特点是全开源且轻量,还能直接集成监控系统.</p><p><code>opensearch+logstash</code>: opensearch是AWS发起的,旨在完全兼容elasticsearch功能的开源工具,它取自elasticsearch+kibana的分支,诞生在elasticsearch+kibana不再完全开源免费之后.自带一个opensearch dashboard可以替代kibana功能.性能上还比不上elasticsearch.但是如果你希望免费部署日志收集系统,可以接受一部分的性能下降,这是个很不错的选择,AWS云也有使用opensearch的公共服务.</p><blockquote><p>日志代理有很多选择: logstash&#x2F;loki&#x2F;Fluentd&#x2F;Filebeat&#x2F;…</p></blockquote><h2 id="日志收集等级"><a href="#日志收集等级" class="headerlink" title="日志收集等级"></a>日志收集等级</h2><p>k8s支持三种不同等级的日志收集方式</p><p><code>sidecar</code>: 在每个pod之内额外部署一个log agent的容器作为sidecar运行,收集日志数据,将日志发送到es&#x2F;opensearch等日志存储系统.</p><p><code>节点级</code>: 在每个节点上部署一个日志代理(Fluentd&#x2F;Filebeat等),通常以daemonset的方式部署,收集的日志信息发送到集群外部的日志存储系统.</p><p><code>集群级</code>: 就是把日志收集系统全部部署在集群内部,以获取最及时的日志数据.(比如你的集群部署在海外,如果把日志存储分析系统部署在国内,数据传输就会消耗一定时间).</p><blockquote><p>三种级别的日志收集方式需要根据实际,选择使用,或者组合使用.</p></blockquote><h2 id="EFK"><a href="#EFK" class="headerlink" title="EFK"></a>EFK</h2><p>用<code>Fluentd</code>替代了<code>Logstage</code>.</p><p>Fluentd的主要特点有:</p><ul><li>插件化架构,拥有丰富的插件生态系统,通过不同插件实现收集,过滤,缓冲和输出的不同功能</li><li>使用内存和文件基础的缓冲区机制,保护数据免受网络问题和宕机影响</li><li>CNCF云原生项目</li></ul><p>Fluentd的配置文件语法:</p><blockquote><ul><li>fluentd的配置使用自己的标记语言编写,借鉴了XML的某些视觉元素,但不是XML.</li><li>使用<tag>来表示配置开始</tag>表示配置结束</li><li>配置文件以<code>.conf</code>为后缀,其内容包括:<ul><li>指令:<source>,<match>,<filter>等</filter></match></li><li>参数: 缩进的键值对</li><li>注释: <code>#</code></li></ul></li></ul><p><code>&lt;source&gt;</code>: 指定日志数据来自何处</p><p><code>&lt;match&gt;</code>和<code>&lt;filter&gt;</code>指定如何处理这些数据</p></blockquote><p>Fluentd VS Logstage:</p><ul><li>Fluentd更轻量,默认配置配置下使用更少的内存资源</li><li>Logstash提供更多的过滤器和插件,可以处理更复杂的数据逻辑</li><li>Fluentd更容易上手</li></ul><h3 id="部署ES-Kibana"><a href="#部署ES-Kibana" class="headerlink" title="部署ES+Kibana"></a>部署ES+Kibana</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl create ns nfk<br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">elasticsearch</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">efk</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">elasticsearch</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">elasticsearch</span><br>  <span class="hljs-attr">clusterIP:</span> <span class="hljs-string">None</span> <span class="hljs-comment"># 创建一个headless service,通过service的dns即可获取集群所有节点ip</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">9200</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">rest</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">9300</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">inner</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">StatefulSet</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">es</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">efk</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">serviceName:</span> <span class="hljs-string">elasticsearch</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">elasticsearch</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">elasticsearch</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">initContainers:</span> <span class="hljs-comment"># 起两个init-pod负责初始化系统参数</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">increase-vm-max-map</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">busybox</span><br>        <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">&quot;IfNotPresent&quot;</span><br>        <span class="hljs-attr">command:</span> [<span class="hljs-string">&quot;sysctl&quot;</span>, <span class="hljs-string">&quot;-w&quot;</span>, <span class="hljs-string">&quot;vm.max_map_count=262144&quot;</span>]<br>        <span class="hljs-attr">securityContext:</span><br>          <span class="hljs-attr">privileged:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">increase-fd-ulimit</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">busybox</span><br>        <span class="hljs-attr">command:</span> [<span class="hljs-string">&quot;sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, <span class="hljs-string">&quot;ulimit -n 65536&quot;</span>]<br>        <span class="hljs-attr">securityContext:</span><br>          <span class="hljs-attr">privileged:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">elasticsearch</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">docker.elastic.co/elasticsearch/elasticsearch:7.17.1</span><br>        <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">&quot;IfNotPresent&quot;</span><br>        <span class="hljs-attr">ports:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">rest</span><br>          <span class="hljs-attr">containerPort:</span> <span class="hljs-number">9200</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">inner</span><br>          <span class="hljs-attr">containerPort:</span> <span class="hljs-number">9300</span><br>        <span class="hljs-attr">resources:</span><br>          <span class="hljs-attr">limits:</span><br>            <span class="hljs-attr">cpu:</span> <span class="hljs-string">1000m</span><br>          <span class="hljs-attr">requests:</span><br>            <span class="hljs-attr">cpu:</span> <span class="hljs-string">1000m</span><br>        <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">data</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/usr/share/elasticsearch/data</span><br>        <span class="hljs-attr">env:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">cluster.name</span><br>          <span class="hljs-attr">value:</span> <span class="hljs-string">k8s-logs</span> <span class="hljs-comment"># es-cluster-name</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">node.name</span><br>          <span class="hljs-attr">valueFrom:</span><br>            <span class="hljs-attr">fieldRef:</span><br>              <span class="hljs-attr">fieldPath:</span> <span class="hljs-string">metadata.name</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">cluster.initial_master_nodes</span><br>          <span class="hljs-attr">value:</span> <span class="hljs-string">&quot;es-0,es-1,es-2&quot;</span> <span class="hljs-comment"># &lt;sts-name&gt;-&lt;num&gt;</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">discovery.zen.minimum_master_nodes</span><br>          <span class="hljs-attr">value:</span> <span class="hljs-string">&quot;2&quot;</span> <span class="hljs-comment"># node/2-1</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">discovery.seed_hosts</span><br>          <span class="hljs-attr">value:</span> <span class="hljs-string">&quot;elasticsearch&quot;</span> <span class="hljs-comment"># 填写es的svc-name,因为在同一个namespace所以不需要写full DNS</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">ES_JAVA_OPTS</span><br>          <span class="hljs-attr">value:</span> <span class="hljs-string">&quot;-Xms512m -Xmx512m&quot;</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">network.host</span><br>          <span class="hljs-attr">value:</span> <span class="hljs-string">&quot;0.0.0.0&quot;</span><br>  <span class="hljs-attr">volumeClaimTemplates:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">data</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">elasticsearch</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">accessModes:</span> [ <span class="hljs-string">&quot;ReadWriteOnce&quot;</span> ]<br>      <span class="hljs-attr">storageClassName:</span> <span class="hljs-string">openebs-hostpath</span> <span class="hljs-comment"># 按实际填写</span><br>      <span class="hljs-attr">resources:</span><br>        <span class="hljs-attr">requests:</span><br>          <span class="hljs-attr">storage:</span> <span class="hljs-string">2Gi</span> <span class="hljs-comment"># 按需填写</span><br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">efk</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kibana-config</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">kibana</span><br><span class="hljs-attr">data:</span><br>  <span class="hljs-attr">kibana.yml:</span> <span class="hljs-string">|</span><br><span class="hljs-string">    server.name: kibana</span><br><span class="hljs-string">    server.host: &quot;0.0.0.0&quot;</span><br><span class="hljs-string">    i18n.locale: zh-CN                      #设置默认语言为中文</span><br><span class="hljs-string">    elasticsearch:</span><br><span class="hljs-string">      hosts: $&#123;ELASTICSEARCH_HOSTS&#125;         #es集群连接地址</span><br><span class="hljs-string"></span><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kibana</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">efk</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">kibana</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">ports:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">5601</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">NodePort</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">kibana</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kibana</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">efk</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">kibana</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">kibana</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">kibana</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">kibana</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">docker.elastic.co/kibana/kibana:7.17.1</span><br>        <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">&quot;IfNotPresent&quot;</span><br>        <span class="hljs-attr">resources:</span><br>          <span class="hljs-attr">limits:</span><br>            <span class="hljs-attr">cpu:</span> <span class="hljs-string">1000m</span><br>          <span class="hljs-attr">requests:</span><br>            <span class="hljs-attr">cpu:</span> <span class="hljs-string">1000m</span><br>        <span class="hljs-attr">env:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">ELASTICSEARCH_URL</span><br>          <span class="hljs-attr">value:</span> <span class="hljs-string">http://elasticsearch:9200</span>                 <span class="hljs-comment">#设置为handless service dns地址即可</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">ELASTICSEARCH_HOSTS</span><br>          <span class="hljs-attr">value:</span> <span class="hljs-string">http://elasticsearch:9200</span><br>        <span class="hljs-attr">ports:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">5601</span><br>        <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">config</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/usr/share/kibana/config/kibana.yml</span>     <span class="hljs-comment">#kibana配置文件挂载地址</span><br>          <span class="hljs-attr">readOnly:</span> <span class="hljs-literal">true</span><br>          <span class="hljs-attr">subPath:</span> <span class="hljs-string">kibana.yml</span><br>      <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">config</span>             <span class="hljs-comment"># 跟上面得volumeMounts名称匹配</span><br>        <span class="hljs-attr">configMap:</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">kibana-config</span><br></code></pre></td></tr></table></figure><h3 id="部署Fluented"><a href="#部署Fluented" class="headerlink" title="部署Fluented"></a>部署Fluented</h3><p>首先配置Fluented的配置文件,在EFK中这一步最为复杂,需要定义如何获取日志,如何处理日志,以及输出到哪里.</p><p>以下示例分三个配置文件,收集k8s集群内容器的日志文件:</p><ol><li><p>system.conf</p><blockquote><p>配置Fluentd的系统级参数</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">&lt;system&gt;<br>  root_dir /tmp/fluentd-buffers/ <span class="hljs-comment"># fluentd使用的根目录,这是fluentd运行时临时文件的总目录</span><br>&lt;/system&gt;<br></code></pre></td></tr></table></figure></li><li><p>containers.input.conf</p><blockquote><p>以下配置文件定义了一些列规则,用于从k8s容器中收集,处理和过滤日志,主要操作有:</p><p>**日志收集:**使用tail插件监控特定路径下的日志文件</p><p>**异常检测和处理:**使用<code>detect_exceptions</code>插件来识别和处理多行异常信息</p><p>**日志连接与过滤:**使用<code>concat</code>插件将多行日志合并成单个事件,使用<code>grep</code>插件根据标签过滤日志</p><p>**元数据添加:**使用k8s元数据插件来添加有关k8s环境的信息</p><p>**日志清理:**移除日志中不必要的字段</p><p>**日志解析改善:**使用<code>parser</code>插件进一步解析日志记录中的json字段,如果无法解析则保留原数据</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python">&lt;source&gt; <span class="hljs-comment"># 定义数据输入开始的标签</span><br><span class="hljs-meta">  @id fluentd-containers.log </span><span class="hljs-comment"># &quot;@id&quot;用于定义这个&lt;source&gt;配置的唯一标识符,相当于给这段&lt;source&gt;命名,方便日后管理和调试</span><br><span class="hljs-meta">  @type tail </span><span class="hljs-comment"># &quot;@type&quot;用于指定使用的插件,这里使用&quot;tail&quot;插件用于追踪日志文件的增长,并持续读取新增内容                      </span><br>  path /var/log/containers/*.log <span class="hljs-comment"># &quot;path&quot;使用路径模式指向一个日志文件,意味着fluentd会监听该路径下所有的.log文件,并读取其内容          </span><br>  pos_file /var/log/es-containers.log.pos <span class="hljs-comment"># &quot;pos_file&quot;用于指定一个文件,该文件用来记录fluentd已经读取日志数据到哪个点,重启后也能从上次停止的位置开始读取</span><br>  tag raw.kubernetes.* <span class="hljs-comment"># &quot;tag&quot;用于给&lt;source&gt;输入的日志打标签,所有以这个&lt;source&gt;为源输入的日志都会以&quot;raw.kubernetes.&quot;开头                   </span><br>  read_from_head true <span class="hljs-comment"># 首次读取日志文件时,是否从头开始读取数据</span><br>  &lt;parse&gt;  <span class="hljs-comment"># &lt;parse&gt;配置块定义如何解析读取的数据,即数据的格式化方式                               </span><br><span class="hljs-meta">    @type multi_format </span><span class="hljs-comment"># 使用&quot;multi_format&quot;解析器插件,支持多格式解析     </span><br>    <span class="hljs-comment"># 下面两个&quot;&lt;pattern&gt;&quot;指定两种不同的日志格式和对应的解析方法</span><br>    &lt;pattern&gt; <span class="hljs-comment"># 第一个模式指定使用json解释器   </span><br>      <span class="hljs-built_in">format</span> json                       <br>      time_key time  <span class="hljs-comment"># 指定json中哪个字段表示日志时间                     </span><br>      time_format %Y-%m-%dT%H:%M:%S.%NZ  <span class="hljs-comment"># 定义这个时间字段的格式 </span><br>    &lt;/pattern&gt;<br>    &lt;pattern&gt; <span class="hljs-comment"># 第二个模式使用正则表达式解析不是json的日志行</span><br>      <span class="hljs-built_in">format</span> /^(?&lt;time&gt;.+) (?&lt;stream&gt;stdout|stderr) [^ ]* (?&lt;log&gt;.*)$/ <span class="hljs-comment"># 使用命名捕获提取time和stream(标准输出和标准错误),以及日志消息log本身</span><br>      time_format %Y-%m-%dT%H:%M:%S.%N%:z <span class="hljs-comment"># 同样定义时间字段的格式</span><br>    &lt;/pattern&gt;<br>  &lt;/parse&gt;<br>&lt;/source&gt;<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 在日志输出中检测异常，并将其作为一条日志转发</span><br><span class="hljs-comment"># https://github.com/GoogleCloudPlatform/fluent-plugin-detect-exceptions</span><br>&lt;<span class="hljs-keyword">match</span> raw.kubernetes.**&gt;           <span class="hljs-comment"># &lt;match&gt;块匹配tag为raw.kubernetes.**开头的日志信息</span><br><span class="hljs-meta">  @id raw.kubernetes</span><br><span class="hljs-meta">  @type detect_exceptions           </span><span class="hljs-comment"># 使用detect-exceptions插件处理异常栈信息,它可以自动识别多行的异常堆栈跟踪，并将其作为单个日志事件进行聚合</span><br>  remove_tag_prefix raw             <span class="hljs-comment"># remove_tag_prefix删除指定前缀(raw)</span><br>  message log <span class="hljs-comment"># message参数定义存储日志消息的字段名称,这里是(log)</span><br>  stream stream <span class="hljs-comment"># stream参数定义将会存储&quot;stdout&quot;或&quot;sederr&quot;这样的流字段(stream)</span><br>  multiline_flush_interval <span class="hljs-number">5</span> <span class="hljs-comment"># 设置检测到异常后,在强制刷新前等待的最大秒数.如果在5秒内没有接收到新的日志行,插件会发送当前缓冲的日志事件</span><br>  max_bytes <span class="hljs-number">500000</span> <span class="hljs-comment"># 限制单个异常事件可包含的最大字节数</span><br>  max_lines <span class="hljs-number">1000</span> <span class="hljs-comment"># 控制单个异常事件可包含的最大行数</span><br>&lt;/<span class="hljs-keyword">match</span>&gt;<br>   <br>&lt;<span class="hljs-built_in">filter</span> **&gt;  <span class="hljs-comment"># 匹配所有日志</span><br><span class="hljs-meta">  @id filter_concat</span><br><span class="hljs-meta">  @type concat                </span><span class="hljs-comment"># 指定concat过滤器插件,将日志事件中分散的多行信息连接为一个单独的日志事件</span><br>  key message <span class="hljs-comment"># key指定要处理并连接为多行信息的字段名称(message)</span><br>  multiline_end_regexp /\n$/  <span class="hljs-comment"># 指定一个正则,用来确定何时结束一个消息,并且可以将分散的行连接起来.这里指定&quot;\n$&quot;结尾的换行符.这里意味着每当一行以换行符结束,就为认为是一个消息的结束</span><br>  separator <span class="hljs-string">&quot;&quot;</span> <span class="hljs-comment"># separator定义多行消息连接时使用的分隔符</span><br>&lt;/<span class="hljs-built_in">filter</span>&gt;<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python">&lt;<span class="hljs-built_in">filter</span> kubernetes.**&gt; <span class="hljs-comment"># 过滤器匹配所有kubernetes.**开头的标签</span><br><span class="hljs-meta">     @id filter_kubernetes_metadata</span><br><span class="hljs-meta">     @type kubernetes_metadata </span><span class="hljs-comment"># 这个插件可以从k8s API中补充和丰富日志记录的元数据</span><br>   &lt;/<span class="hljs-built_in">filter</span>&gt;<br>   <br>   <span class="hljs-comment"># 修复 ES 中的 JSON 字段</span><br>   <span class="hljs-comment"># 插件地址：https://github.com/repeatedly/fluent-plugin-multi-format-parser</span><br>   &lt;<span class="hljs-built_in">filter</span> kubernetes.**&gt;<br><span class="hljs-meta">     @id filter_parser</span><br><span class="hljs-meta">     @type parser                </span><span class="hljs-comment"># 指定parser过滤器类型,用于解析日志中的指定字段</span><br>     key_name log                <span class="hljs-comment"># 指定过滤器要解析的字段名称(log)</span><br>     reserve_data true           <span class="hljs-comment"># 是否在解析后保留日志记录中的原始数据</span><br>     remove_key_name_field true  <span class="hljs-comment"># log字段解析成功后是否从记录中移除</span><br>     &lt;parse&gt;<br><span class="hljs-meta">       @type multi_format</span><br>       &lt;pattern&gt; <span class="hljs-comment"># 定义了两种模式</span><br>         <span class="hljs-built_in">format</span> json <span class="hljs-comment"># 第一种是json,它会尝试把日志按照json格式解析</span><br>       &lt;/pattern&gt;<br>       &lt;pattern&gt;<br>         <span class="hljs-built_in">format</span> none <span class="hljs-comment"># 如果不匹配,则不解释</span><br>       &lt;/pattern&gt;<br>     &lt;/parse&gt;<br>   &lt;/<span class="hljs-built_in">filter</span>&gt;<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 删除一些多余的属性</span><br>&lt;<span class="hljs-built_in">filter</span> kubernetes.**&gt;<br><span class="hljs-meta">  @type record_transformer </span><span class="hljs-comment"># 这个过滤器插件可以添加,删除或重命名日志记录中的字段</span><br>  remove_keys $.docker.container_id,$.kubernetes.container_image_id,$.kubernetes.pod_id,$.kubernetes.namespace_id,$.kubernetes.master_url,$.kubernetes.labels.pod-template-<span class="hljs-built_in">hash</span> <span class="hljs-comment"># 要从日志中删除多余的属性,每个字段前的&quot;$&quot;指示查询的是记录本身的根</span><br>&lt;/<span class="hljs-built_in">filter</span>&gt;<br><span class="hljs-comment"># 只保留具有logging=true标签的Pod日志</span><br>&lt;<span class="hljs-built_in">filter</span> kubernetes.**&gt;<br><span class="hljs-meta">  @id filter_log</span><br><span class="hljs-meta">  @type grep </span><span class="hljs-comment"># grep插件用来包含或排除于特定模式匹配的日志记录</span><br>  &lt;regexp&gt;<br>    key $.kubernetes.labels.logging <span class="hljs-comment"># 匹配日志中的哪个字段</span><br>    pattern ^true$ <span class="hljs-comment"># 正则匹配&quot;true&quot;,只有当$.kubernetes.labels.logging 字段值完全等于 &quot;true&quot; 时，该日志记录才会被通过.</span><br>  &lt;/regexp&gt;<br>&lt;/<span class="hljs-built_in">filter</span>&gt;<br></code></pre></td></tr></table></figure></li><li><p>forward.input.conf</p><blockquote><p>定义fluentd内部如何接收日志数据.这里定义fluentd实例将会监听一个端口等待其他fluentd代理或系统发送日志事件到这个地址.</p><p>在分布式日志收集系统中,forward插件可以使多个Fluentd实例相互传输日志数据.</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">&lt;source&gt;<br><span class="hljs-meta">  @id forward</span><br><span class="hljs-meta">  @type forward</span><br>&lt;/source&gt;<br></code></pre></td></tr></table></figure><p><code>@type forward</code>,forward类型的source是用于接受其他fluentd代理发送过来的事件流.这种类型的输入插件会监听特定的端口,等待外部fluentd实例将日志事件直接发送到本实例.如果没有进一步配置(端口指定,安全设置,认证等),这个插件会监听默认端口(<code>24224</code>).</p></li><li><p>output.conf</p><blockquote><p>定义输出插件,将匹配到的日志输出到es服务器</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python">&lt;<span class="hljs-keyword">match</span> **&gt; <span class="hljs-comment"># 匹配所有</span><br><span class="hljs-meta">  @id elasticsearch</span><br><span class="hljs-meta">  @type elasticsearch </span><span class="hljs-comment"># 使用es输出插件,将数据输出到es服务器</span><br><span class="hljs-meta">  @log_level info </span><span class="hljs-comment"># 定义Fluentd 插件自身输出日志的级别,于业务日志无关</span><br>  include_tag_key true <span class="hljs-comment"># 发送日志的时候是否包括时间标签的键</span><br>  host elasticsearch <span class="hljs-comment"># es集群主机名,这里直接使用es的headless svc名即可,因为是同一个namespace</span><br>  port <span class="hljs-number">9200</span> <span class="hljs-comment"># es服务端口</span><br>  logstash_format true <span class="hljs-comment"># 启用logstash兼容模式, Fluentd 会生成 Logstash 索引名称格式有日期的时间戳的索引名</span><br>  logstash_prefix k8s  <span class="hljs-comment"># 设置 index 前缀为 k8s, 索引名字将为&quot;k8s-&lt;日期&gt;&quot;</span><br>  request_timeout    30s <span class="hljs-comment"># 对es的请求超时</span><br>  &lt;buffer&gt; <span class="hljs-comment"># buffer块定义如何缓冲数据以及何时冲洗(flush)到es</span><br><span class="hljs-meta">    @type file </span><span class="hljs-comment"># 指定缓冲类型为文件, 意味着缓冲数据写入文件系统</span><br>    path /var/log/fluentd-buffers/kubernetes.system.buffer <span class="hljs-comment"># 指定缓冲文件(传冲插件使用的目录)</span><br>    flush_mode interval <span class="hljs-comment"># 设置冲洗模式为基于时间间隔冲洗</span><br>    retry_type exponential_backoff <span class="hljs-comment"># 重试类型为&quot;指数避让&quot;(重试等待时间逐步增长,避免对es服务造成过大压力)</span><br>    flush_thread_count <span class="hljs-number">2</span> <span class="hljs-comment"># 冲洗操作线程数</span><br>    flush_interval 5s <span class="hljs-comment"># 冲洗的时间间隔</span><br>    retry_forever <span class="hljs-comment"># 无限重试</span><br>    retry_max_interval <span class="hljs-number">30</span> <span class="hljs-comment"># 最长重试间隔</span><br>    chunk_limit_size 2M <span class="hljs-comment"># 缓冲区块大小限制</span><br>    queue_limit_length <span class="hljs-number">8</span> <span class="hljs-comment"># 缓冲区队列长度</span><br>    overflow_action block <span class="hljs-comment"># 当缓冲区满了,进一步的数据处理将被&quot;阻塞&quot;,直到缓冲区有空间可用</span><br>  &lt;/buffer&gt;<br>&lt;/<span class="hljs-keyword">match</span>&gt;<br></code></pre></td></tr></table></figure><p>将上面的配置作为configmap创建: <a target="_blank" rel="noopener" href="https://github.com/occultagg/k8s-yaml/blob/main/efk/fluentd-configmap.yaml">参考</a></p><p>使用daemon-set部署fluentd:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">fluentd-es</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">efk</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">fluentd-es</span><br>    <span class="hljs-attr">kubernetes.io/cluster-service:</span> <span class="hljs-string">&quot;true&quot;</span><br>    <span class="hljs-attr">addonmanager.kubernetes.io/mode:</span> <span class="hljs-string">Reconcile</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">fluentd-es</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">fluentd-es</span><br>    <span class="hljs-attr">kubernetes.io/cluster-service:</span> <span class="hljs-string">&quot;true&quot;</span><br>    <span class="hljs-attr">addonmanager.kubernetes.io/mode:</span> <span class="hljs-string">Reconcile</span><br><span class="hljs-attr">rules:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;&quot;</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;namespaces&quot;</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;pods&quot;</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;get&quot;</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;watch&quot;</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;list&quot;</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRoleBinding</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">fluentd-es</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">fluentd-es</span><br>    <span class="hljs-attr">kubernetes.io/cluster-service:</span> <span class="hljs-string">&quot;true&quot;</span><br>    <span class="hljs-attr">addonmanager.kubernetes.io/mode:</span> <span class="hljs-string">Reconcile</span><br><span class="hljs-attr">subjects:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">fluentd-es</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">efk</span><br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-attr">roleRef:</span><br>  <span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">fluentd-es</span><br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">DaemonSet</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">fluentd-es</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">efk</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">fluentd-es</span><br>    <span class="hljs-attr">kubernetes.io/cluster-service:</span> <span class="hljs-string">&quot;true&quot;</span><br>    <span class="hljs-attr">addonmanager.kubernetes.io/mode:</span> <span class="hljs-string">Reconcile</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">fluentd-es</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">fluentd-es</span><br>        <span class="hljs-attr">kubernetes.io/cluster-service:</span> <span class="hljs-string">&quot;true&quot;</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">serviceAccountName:</span> <span class="hljs-string">fluentd-es</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">fluentd-es</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">quay.io/fluentd_elasticsearch/fluentd:v3.4.0</span><br>        <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">&quot;IfNotPresent&quot;</span><br>        <span class="hljs-attr">env:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">FLUENTD_ARGS</span><br>          <span class="hljs-attr">value:</span> <span class="hljs-string">--no-supervisor</span> <span class="hljs-string">-q</span><br>        <span class="hljs-attr">resources:</span><br>          <span class="hljs-attr">limits:</span><br>            <span class="hljs-attr">memory:</span> <span class="hljs-string">500Mi</span><br>          <span class="hljs-attr">requests:</span><br>            <span class="hljs-attr">cpu:</span> <span class="hljs-string">100m</span><br>            <span class="hljs-attr">memory:</span> <span class="hljs-string">200Mi</span><br>        <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">varlog</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/var/log</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">varlibdockercontainers</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/data/log/containers</span><br>          <span class="hljs-attr">readOnly:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">config-volume</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/fluent/config.d</span><br>      <span class="hljs-attr">tolerations:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">operator:</span> <span class="hljs-string">Exists</span><br>      <span class="hljs-attr">terminationGracePeriodSeconds:</span> <span class="hljs-number">30</span><br>      <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">varlog</span><br>        <span class="hljs-attr">hostPath:</span><br>          <span class="hljs-attr">path:</span> <span class="hljs-string">/var/log</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">varlibdockercontainers</span><br>        <span class="hljs-attr">hostPath:</span><br>          <span class="hljs-attr">path:</span> <span class="hljs-string">/var/log/containers</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">config-volume</span><br>        <span class="hljs-attr">configMap:</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">fluentd-config</span><br></code></pre></td></tr></table></figure></li></ol><h3 id="图形界面配置"><a href="#图形界面配置" class="headerlink" title="图形界面配置"></a>图形界面配置</h3><p>在上面的配置中,kibana通过nodeport的svc暴露.访问对应端口即可.</p><p><img src="https://cdn.jsdelivr.net/gh/occultagg/blog-pics/hexo-blog/image-20240313105525986.png" srcset="/img/loading.gif" lazyload alt="image-20240313105525986"></p><p><img src="https://cdn.jsdelivr.net/gh/occultagg/blog-pics/hexo-blog/image-20240313105621416.png" srcset="/img/loading.gif" lazyload alt="image-20240313105621416"></p><p><img src="https://cdn.jsdelivr.net/gh/occultagg/blog-pics/hexo-blog/image-20240313105647086.png" srcset="/img/loading.gif" lazyload alt="image-20240313105647086"></p><h3 id="ES数据结构"><a href="#ES数据结构" class="headerlink" title="ES数据结构"></a>ES数据结构</h3><blockquote><p>索引(index): 类似数据库的<code>表(table)</code>.它是文档的容器,通常被用来存储相同类型和相关性强的数据.</p><p>文档(document): 类似数据库的<code>行(row)</code>.存储数据的基本单位,由字段组成.,每个字段都保存数据的一部分.</p><p>字段(field): 类似数据库的<code>列(column)</code>.</p><p>类型(type): 7.x+后,只有一个普通的”_doc”类型.</p><p>分片(shards): ES中的一个索引可以分割成多个分片.每个分片就是一个独立的搜索引擎.每个分片存储在集群中的不同节点.从而实现容量的水平扩展.</p><p>副本(replicas):为了高可用和冗余,es允许你创建<code>分片的</code>一份或多份复制,这就是副本.副本有两种类型:</p><pre><code class="hljs">- 主分片: 一个索引原始的,可写的分片
- 副本分片: 主分片的复制,只读.
</code></pre><p><strong>数据写入</strong>时,先写到主分片,然后复制到副本分片</p><p><strong>数据查询</strong>时,ES会把查询发送到每个相关的分片上,然后把结果组合在一起返回,另外ES可以并行查询主分片和副本分片,也就是ES查询速度快的原因之一.</p></blockquote><p>比如我们用es存储一个购物网站的数据:</p><ol><li><p>首先创建一个<code>products</code>的索引,用来存储网站上所有产品的信息.</p></li><li><p>旧版本我们可以自定义<code>类型</code>,用来区分同一索引中不同种类的文档</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-comment">// 旧版示例</span><br>- 索引：products<br>  - 类型：electronics<br>    - 文档：<span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;product_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;E123&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;电视机&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;brand&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;XYZ&quot;</span> <span class="hljs-punctuation">&#125;</span><br>    - 文档：<span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;product_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;E456&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;智能手机&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;brand&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ABC&quot;</span> <span class="hljs-punctuation">&#125;</span><br>  - 类型：clothing<br>    - 文档：<span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;product_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;C789&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;夹克&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;brand&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;DEF&quot;</span> <span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-comment">//7.x后删除了类型概念,所有文档被认为属于一个通用的 _doc 类型,我们可以通过其他方式（如使用字段）来区分不同的数据</span><br>- 索引：products<br>  - 文档：<span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;product_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;E123&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;category&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;electronics&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;电视机&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;brand&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;XYZ&quot;</span> <span class="hljs-punctuation">&#125;</span><br>  - 文档：<span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;product_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;C789&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;category&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;clothing&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;夹克&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;brand&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;DEF&quot;</span> <span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li><li><p>文档由<code>字段</code>组成,比如上面的<code>name</code>就是一个字段,<code>Smartphone XYZ Pro</code>就是该字段的值</p></li></ol><h3 id="ES索引阶段"><a href="#ES索引阶段" class="headerlink" title="ES索引阶段"></a>ES索引阶段</h3><p>配置es节点时,可以通过配置文件定于哪个节点是热哪个节点是温,然后通过<code>ILM策略</code>来指定存储对应阶段的数据.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 在对应节点的配置文件中设置如下属性</span><br><span class="hljs-attr">node.attr.data:</span> <span class="hljs-string">hot</span> <span class="hljs-comment"># 一般是存储设备性能最好的节点</span><br><span class="hljs-attr">node.attr.data:</span> <span class="hljs-string">warm</span> <span class="hljs-comment"># 次于hot</span><br><span class="hljs-attr">node.attr.data:</span> <span class="hljs-string">cold</span> <span class="hljs-comment"># 次于warm</span><br></code></pre></td></tr></table></figure><p>ES对于索引有<code>热(hot)</code>,<code>温(warm)</code>,<code>冷(cold)</code>和<code>删除(delete)</code>阶段的定义.针对不同的阶段,ES提供对应的操作和策略配置.</p><ul><li>热: 用于存储新数据,活跃数据频繁读写</li><li>温: 用于存储相对没那么频繁使用的数据</li><li>冷: 用于存储很少访问但仍然需要保留的旧数据</li><li>删除: 就是删除:)</li></ul><h3 id="索引生存周期"><a href="#索引生存周期" class="headerlink" title="索引生存周期"></a>索引生存周期</h3><p>Index Life Manager(ILM),分两部分组成:</p><ul><li><p>索引策略</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">创建一个名为my_data_lifecycle的策略</span><br>curl -X PUT &quot;localhost:9200/_ilm/policy/my_data_lifecycle&quot; -H &quot;Content-Type: application/json&quot; -d&#x27;<br>&#123;<br>  &quot;policy&quot;: &#123;<br>    &quot;phases&quot;: &#123;<br>      &quot;hot&quot;: &#123;<br>        &quot;min_age&quot;: &quot;0ms&quot;, # 数据一旦进入es即为hot数据<br>        &quot;actions&quot;: &#123;<br>          &quot;rollover&quot;: &#123; # 索引滚动(见下文解释)<br>            &quot;max_age&quot;: &quot;1d&quot;,<br>            &quot;max_size&quot;: &quot;50GB&quot;<br>          &#125;,<br>          &quot;set_priority&quot;: &#123; # 在hot阶段设置较高的优先级,以优化该阶段索引的性能<br>            &quot;priority&quot;: 100<br>          &#125;<br>        &#125;<br>      &#125;,<br>      &quot;warm&quot;: &#123;<br>        &quot;min_age&quot;: &quot;10d&quot;, # 10天后转为暖数据<br>        &quot;actions&quot;: &#123;<br>          &quot;allocate&quot;: &#123; # 分片分配过滤器中使用这些自定义属性来控制索引分片的分配,warm数据的主数据和分片都只存于有&quot;warm&quot;属性的节点中(hot的配置类似)<br>            &quot;include&quot;: &#123;&#125;,<br>            &quot;exclude&quot;: &#123;&#125;,<br>            &quot;require&quot;: &#123;<br>              &quot;data&quot;: &quot;warm&quot;<br>            &#125;<br>          &#125;,<br>          &quot;set_priority&quot;: &#123; # 设置相对较低的优先级,系统就不会分配过多的性能到该阶段的索引上<br>            &quot;priority&quot;: 50<br>          &#125;<br>        &#125;<br>      &#125;,<br>      &quot;delete&quot;: &#123;<br>        &quot;min_age&quot;: &quot;30d&quot;, # 超过30天的数据即删除<br>        &quot;actions&quot;: &#123;<br>          &quot;delete&quot;: &#123;<br>            &quot;delete_searchable_snapshot&quot;: true<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;&#x27;<br></code></pre></td></tr></table></figure><blockquote><p><strong>索引滚动</strong>:</p><ul><li>当旧索引达到预设的条件,es会自动创建一个新索引,通常以原索引名后加个递增的id来命名</li><li>配置索引滚动一定要指定<code>滚动别名</code>,当一个索引被滚动,新索引被创建,别名就<strong>从指向旧索引改为指向新索引</strong>,只有被别名指向索引才是可写的</li><li>也就是意味着旧索引会变为只读状态,新索引变为读写状态,数据会持续写入新索引,旧索引则根据ILM策略做处理.</li></ul><p>这个功能可以保证系统的查询性能,毕竟一个索引数据量越大,查询自然就会越慢</p></blockquote></li><li><p>索引模板</p><p>通过模板来应用创建的策略</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">创建名为k8s_data_template的索引模板</span><br>curl -X PUT &quot;localhost:9200/_index_template/k8s_data_template&quot; -H &quot;Content-Type: application/json&quot; -d&#x27;<br>&#123;<br>  &quot;index_patterns&quot;: [&quot;k8s-*&quot;],  # 通过patterns匹配索引<br>  &quot;template&quot;: &#123;<br>    &quot;settings&quot;: &#123;<br>      &quot;number_of_shards&quot;: 1, # 配置索引的主分片数,最少要有1个主分片<br>      &quot;index.lifecycle.name&quot;: &quot;my_data_lifecycle&quot;, <br>      &quot;index.lifecycle.rollover_alias&quot;: &quot;k8s&quot; # 指定索引滚动别名<br>    &#125;<br>  &#125;<br>&#125;&#x27;<br></code></pre></td></tr></table></figure></li></ul><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_36200932/article/details/123166613">k8s部署EFK-elasticsearch+fluentd+kibana</a></p></li><li><p>chatgpt</p></li></ul></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/" class="category-chain-item">工作笔记</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/prometheus/" class="print-no-link">#prometheus</a> <a href="/tags/k8s/" class="print-no-link">#k8s</a> <a href="/tags/CRD/" class="print-no-link">#CRD</a></div></div><div class="license-box my-3"><div class="license-title"><div>k8s-监控与日志</div><div>http://example.com/2024/02/16/k8s-monitor-2/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>Peter Pan</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2024年2月16日</div></div><div class="license-meta-item"><div>许可协议</div><div><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2024/02/20/k8s-theory/" title="k8s-理论"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">k8s-理论</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2024/02/15/k8s-ops/" title="k8s-运维"><span class="hidden-mobile">k8s-运维</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">总访问量 <span id="busuanzi_value_site_pv"></span> 次 </span><span id="busuanzi_container_site_uv" style="display:none">总访客数 <span id="busuanzi_value_site_uv"></span> 人</span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>