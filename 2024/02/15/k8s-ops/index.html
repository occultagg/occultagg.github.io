<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="https://cdn.jsdelivr.net/gh/occultagg/blog-pics/hexo-blog/202206120024516.ico"><link rel="icon" href="https://cdn.jsdelivr.net/gh/occultagg/blog-pics/hexo-blog/202206120024516.ico"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#2f4154"><meta name="author" content="Peter Pan"><meta name="keywords" content=""><meta name="description" content="K8S运维记录以下管理k8s集群会用到或者我觉得可能会用到的东西. 证书管理CA: 根证书颁发机构 通过kubeadm管理,目录路径: &#x2F;etc&#x2F;kubernetes&#x2F;pki 1234567891011121314151617181920212223├── apiserver.crt├── apiserver-etcd-client.crt├── apiserver-etcd-client.key"><meta property="og:type" content="article"><meta property="og:title" content="k8s-运维"><meta property="og:url" content="http://example.com/2024/02/15/k8s-ops/index.html"><meta property="og:site_name" content="Any &amp; Nothing"><meta property="og:description" content="K8S运维记录以下管理k8s集群会用到或者我觉得可能会用到的东西. 证书管理CA: 根证书颁发机构 通过kubeadm管理,目录路径: &#x2F;etc&#x2F;kubernetes&#x2F;pki 1234567891011121314151617181920212223├── apiserver.crt├── apiserver-etcd-client.crt├── apiserver-etcd-client.key"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/occultagg/blog-pics/hexo-blog/202303200905760.png"><meta property="article:published_time" content="2024-02-15T11:46:55.000Z"><meta property="article:modified_time" content="2024-12-11T09:52:23.057Z"><meta property="article:author" content="Peter Pan"><meta property="article:tag" content="k8s"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/occultagg/blog-pics/hexo-blog/202303200905760.png"><meta name="referrer" content="no-referrer-when-downgrade"><title>k8s-运维 - Any &amp; Nothing</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"example.com",root:"/",version:"1.9.7",typing:{enable:!0,typeSpeed:70,cursorChar:"|",loop:!1,scope:["home"]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!0,offset_factor:2},web_analytics:{enable:!0,follow_dnt:!0,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml",include_content_in_search:!0};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Any & Nothing" type="application/atom+xml">
</head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Any &amp; Nothing</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/" target="_self"><i class="iconfont icon-home-fill"></i> <span>首页</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/" target="_self"><i class="iconfont icon-archive-fill"></i> <span>归档</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/" target="_self"><i class="iconfont icon-category-fill"></i> <span>分类</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/" target="_self"><i class="iconfont icon-tags-fill"></i> <span>标签</span></a></li><li class="nav-item"><a class="nav-link" href="/about/" target="_self"><i class="iconfont icon-user-fill"></i> <span>关于</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle">k8s-运维</span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2024-02-15 19:46" pubdate>2024年2月15日 晚上</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 4.9k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 41 分钟</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 id="seo-header">k8s-运维</h1><div class="markdown-body"><h1 id="K8S运维"><a href="#K8S运维" class="headerlink" title="K8S运维"></a>K8S运维</h1><p>记录以下管理k8s集群会用到或者我觉得可能会用到的东西.</p><h2 id="证书管理"><a href="#证书管理" class="headerlink" title="证书管理"></a>证书管理</h2><p><code>CA</code>: 根证书颁发机构</p><p>通过<code>kubeadm</code>管理,目录路径: <code>/etc/kubernetes/pki</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs shell">├── apiserver.crt<br>├── apiserver-etcd-client.crt<br>├── apiserver-etcd-client.key<br>├── apiserver.key<br>├── apiserver-kubelet-client.crt<br>├── apiserver-kubelet-client.key<br>├── ca.crt<br>├── ca.key<br>├── etcd<br>│   ├── ca.crt<br>│   ├── ca.key<br>│   ├── healthcheck-client.crt<br>│   ├── healthcheck-client.key<br>│   ├── peer.crt<br>│   ├── peer.key<br>│   ├── server.crt<br>│   └── server.key<br>├── front-proxy-ca.crt<br>├── front-proxy-ca.key<br>├── front-proxy-client.crt<br>├── front-proxy-client.key<br>├── sa.key<br>└── sa.pub<br></code></pre></td></tr></table></figure><blockquote><ul><li><p><strong>apiserver.crt</strong> 和 <strong>apiserver.key</strong>: 这是 Kubernetes API 服务器的 TLS 证书和私钥。它们用于保护 API 服务器的通信。</p></li><li><p><strong>apiserver-etcd-client.crt</strong> 和 <strong>apiserver-etcd-client.key</strong>: 这些是 API 服务器用来安全连接到 etcd 集群的客户端证书和私钥。</p></li><li><p><strong>apiserver-kubelet-client.crt</strong> 和 <strong>apiserver-kubelet-client.key</strong>: 这些是 API 服务器用于与集群中每个 kubelet 安全通信的客户端证书和私钥。</p></li><li><p><strong>ca.crt</strong> 和 <strong>ca.key</strong>: 这是您集群的根证书颁发机构 (CA) 的证书和私钥。几乎所有的组件证书都由这个 CA 签发。</p></li><li><p><strong>etcd&#x2F;ca.crt</strong> 和 <strong>etcd&#x2F;ca.key</strong>: 这是用于 etcd 集群的专用 CA 的证书和私钥。etcd 是 Kubernetes 数据的存储后端。</p></li><li><p><strong>etcd&#x2F;healthcheck-client.crt</strong> 和 <strong>etcd&#x2F;healthcheck-client.key</strong>: 在 etcd 集群中执行健康检查的客户端证书和私钥。</p></li><li><p><strong>etcd&#x2F;peer.crt</strong> 和 <strong>etcd&#x2F;peer.key</strong>: etcd 节点之间通信的对等证书和私钥。</p></li><li><p><strong>etcd&#x2F;server.crt</strong> 和 <strong>etcd&#x2F;server.key</strong>: etcd 服务器用于与其他组件（如 apiserver）通信的 TLS 证书和私钥。</p></li><li><p><strong>front-proxy-ca.crt</strong> 和 <strong>front-proxy-ca.key</strong>: 是前端代理颁发机构的证书和私钥，用于代理客户端与 API 服务器之间的通信。</p></li><li><p><strong>front-proxy-client.crt</strong> 和 <strong>front-proxy-client.key</strong>: 这是用于 Kubernetes API 服务器前端的代理客户端的证书和私钥。</p></li><li><p><strong>sa.key</strong> 和 <strong>sa.pub</strong>: 这些是用于签名和验证服务账户令牌的私钥和公钥</p></li></ul></blockquote><h3 id="生成"><a href="#生成" class="headerlink" title="生成"></a>生成</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">kubeadm 在初始化集群时会自动生成所需的所有证书。如果需要手动为新的服务或组件生成证书，可以使用</span><br>kubeadm init phase certs &lt;cert-name&gt;<br></code></pre></td></tr></table></figure><h3 id="查看过期时间"><a href="#查看过期时间" class="headerlink" title="查看过期时间"></a>查看过期时间</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubeadm certs check-expiration<br></code></pre></td></tr></table></figure><h3 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubeadm certs renew &lt;cert-name&gt;<br>kubeadm certs renew all<br></code></pre></td></tr></table></figure><p>证书更新后要重启对应组件才能生效,在生产环境中就涉及不停机更新,pod驱逐等操作,最好在测试环境演练好并做好备份再在生产环境操作.</p><h3 id="删除-备份"><a href="#删除-备份" class="headerlink" title="删除&#x2F;备份"></a>删除&#x2F;备份</h3><p>操作<code>/etc/kubernetes/pki</code>目录</p><h2 id="节点分配"><a href="#节点分配" class="headerlink" title="节点分配"></a>节点分配</h2><ul><li><p>节点亲和性</p><p>调度器(scheduler)上一个比较复杂,但更为强大的功能</p><ol><li><p>必须规则(required)</p><p>也称为硬性规则,规则<code>必须</code>被满足,pod才能被调度.定义字段:<code>requiredDuringSchedulingIgnoredDuringExecution</code></p></li><li><p>首选规则(preferred)</p><p>也称为软性规则,调度器会<code>尽量</code>满足这些规则.定义字段:<code>preferredDuringSchedulingIgnoredDuringExecution</code></p></li><li><p>操作符</p><ul><li>In&#x2F;NotIn: 确保节点标签<code>包含/不包含</code>在给定的值的列表中</li><li>Exists&#x2F;NotExists: 节点标签<code>存在/不存在</code>给定的<code>key</code>,不管value是什么</li><li>Gt&#x2F;Lt: 用于基于数值的标签,保证节点标签拥有<code>大于/小于</code>特定数值的key</li></ul></li></ol><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">with-node-affinity</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-container</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx</span><br>  <span class="hljs-attr">affinity:</span><br>    <span class="hljs-attr">nodeAffinity:</span><br>      <span class="hljs-attr">requiredDuringSchedulingIgnoredDuringExecution:</span> <span class="hljs-comment"># 硬性</span><br>        <span class="hljs-attr">nodeSelectorTerms:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">matchExpressions:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">disktype</span><br>            <span class="hljs-attr">operator:</span> <span class="hljs-string">In</span><br>            <span class="hljs-attr">values:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">ssd</span><br>      <span class="hljs-attr">preferredDuringSchedulingIgnoredDuringExecution:</span> <span class="hljs-comment"># 软性</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">weight:</span> <span class="hljs-number">1</span> <span class="hljs-comment"># 软性可以有多个规则,根据权重决定优先级</span><br>        <span class="hljs-attr">preference:</span><br>          <span class="hljs-attr">matchExpressions:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">team</span><br>            <span class="hljs-attr">operator:</span> <span class="hljs-string">In</span><br>            <span class="hljs-attr">values:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">research</span><br></code></pre></td></tr></table></figure></li><li><p>NodeSelector</p><p>标签选择器,比较简单,就是通过<code>标签</code>,让pod运行在特定的节点上</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">simple-pod</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">simple-container</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx</span><br>  <span class="hljs-attr">nodeSelector:</span> <span class="hljs-comment"># 通过标签选择节点</span><br>    <span class="hljs-attr">disktype:</span> <span class="hljs-string">ssd</span><br></code></pre></td></tr></table></figure></li></ul><h2 id="探针"><a href="#探针" class="headerlink" title="探针"></a>探针</h2><ul><li>启动(startup): 用于确定容器内的应用是否已经启动完整,直到启动探针检测成功,才会应用后两个探针.</li><li>存活(liveness): 检查容器是否在运行,检测失败,kubelet就会杀死容器根据重启策略重新启动.</li><li>就绪(readiness): 检测容器内应用是否已经准备好接受流量,如果检测失败,就会从它关联的所有service中除名.(不负载流量给它)</li></ul><p>三种探针都有三种探测方式: http get &#x2F; tcp socket &#x2F; exec</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">example-pod</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">example-container</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">example-image</span><br>    <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8080</span><br>    <span class="hljs-attr">livenessProbe:</span><br>      <span class="hljs-attr">httpGet:</span><br>        <span class="hljs-attr">path:</span> <span class="hljs-string">/healthz</span><br>        <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br>      <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">15</span><br>      <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">1</span><br>      <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span><br>      <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">3</span><br>    <span class="hljs-attr">readinessProbe:</span><br>      <span class="hljs-attr">httpGet:</span><br>        <span class="hljs-attr">path:</span> <span class="hljs-string">/ready</span><br>        <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br>      <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">5</span><br>      <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">1</span><br>      <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span><br>      <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">3</span><br>    <span class="hljs-attr">startupProbe:</span><br>      <span class="hljs-attr">httpGet:</span><br>        <span class="hljs-attr">path:</span> <span class="hljs-string">/start</span><br>        <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br>      <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">5</span><br>      <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">1</span><br>      <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span><br>      <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">30</span><br></code></pre></td></tr></table></figure><h2 id="pod资源限制"><a href="#pod资源限制" class="headerlink" title="pod资源限制"></a>pod资源限制</h2><p>主要通过<code>limits</code>和<code>requests</code>来限制容器可以调用的资源</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">example-pod</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">example-container</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">example-image</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-attr">requests:</span>  <span class="hljs-comment"># 容器启动所需的最小资源量</span><br>        <span class="hljs-attr">memory:</span> <span class="hljs-string">&quot;64Mi&quot;</span><br>        <span class="hljs-attr">cpu:</span> <span class="hljs-string">&quot;250m&quot;</span><br>      <span class="hljs-attr">limits:</span>  <span class="hljs-comment"># 容器可以使用的最大资源量</span><br>        <span class="hljs-attr">memory:</span> <span class="hljs-string">&quot;128Mi&quot;</span><br>        <span class="hljs-attr">cpu:</span> <span class="hljs-string">&quot;500m&quot;</span><br></code></pre></td></tr></table></figure><h2 id="动态扩容"><a href="#动态扩容" class="headerlink" title="动态扩容"></a>动态扩容</h2><p>k8s的动态扩容有三种形式</p><ol><li><p>水平扩容(HPA)</p><p>依赖<code>metrics-server</code>收集的资源使用数据来决定是否和何时进行扩容.水平扩容主要是针对<code>pod副本的数量</code>进行扩容.比如cpu使用率超过80%,就加一个副本.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">autoscaling/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">HorizontalPodAutoscaler</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">example-hpa</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">scaleTargetRef:</span> <span class="hljs-comment"># 监控的target</span><br>    <span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br>    <span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">example-deployment</span><br>  <span class="hljs-attr">minReplicas:</span> <span class="hljs-number">1</span> <span class="hljs-comment"># cpu利用率低于50%,则会减少pod数量,最少1个</span><br>  <span class="hljs-attr">maxReplicas:</span> <span class="hljs-number">10</span> <span class="hljs-comment"># 扩容最多10个</span><br>  <span class="hljs-attr">targetCPUUtilizationPercentage:</span> <span class="hljs-number">50</span> <span class="hljs-comment"># 如果cpu利用率超过50%则会扩容</span><br></code></pre></td></tr></table></figure></li><li><p>垂直扩容(VPA)</p><p>与HPA类似,也是依赖metrics-server,但是垂直扩容针对的是<code>pod的使用资源</code>扩容.比如cpu使用率超过80%,就给这个pod加更多的cpu资源.垂直扩容比较适合一些不方便直接加副本的应用,主要是一些<code>有状态应用</code>.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">autoscaling.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">VerticalPodAutoscaler</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">example-vpa</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">targetRef:</span> <span class="hljs-comment"># 监控的target</span><br>    <span class="hljs-attr">apiVersion:</span> <span class="hljs-string">&quot;apps/v1&quot;</span><br>    <span class="hljs-attr">kind:</span>       <span class="hljs-string">Deployment</span><br>    <span class="hljs-attr">name:</span>       <span class="hljs-string">example-deployment</span><br>  <span class="hljs-attr">updatePolicy:</span><br>    <span class="hljs-attr">updateMode:</span> <span class="hljs-string">&quot;Auto&quot;</span><br>  <span class="hljs-attr">resourcePolicy:</span><br>    <span class="hljs-attr">containerPolicies:</span> <span class="hljs-comment"># vpa的资源调整是在容器级别上操作的,但是vpa的操作和决策(启动,更新,重启,扩缩容等)都是pod级别上的</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">containerName:</span> <span class="hljs-string">example-container</span><br>      <span class="hljs-attr">minAllowed:</span> <span class="hljs-comment"># 限制容器可以使用资源的最少值</span><br>        <span class="hljs-attr">cpu:</span> <span class="hljs-string">100m</span><br>        <span class="hljs-attr">memory:</span> <span class="hljs-string">100Mi</span><br>      <span class="hljs-attr">maxAllowed:</span> <span class="hljs-comment"># 限制容器可以使用资源的最大值</span><br>        <span class="hljs-attr">cpu:</span> <span class="hljs-number">1</span><br>        <span class="hljs-attr">memory:</span> <span class="hljs-string">1Gi</span><br>      <span class="hljs-attr">controlledResources:</span> [<span class="hljs-string">&quot;cpu&quot;</span>, <span class="hljs-string">&quot;memory&quot;</span>]<br></code></pre></td></tr></table></figure><blockquote><p>关于VPA的minAllowed&#x2F;maxAllowed和pod定义的limits&#x2F;requests:</p><p>VPA不会更改limits,minAllowed&#x2F;maxAllowed更多的是对VPA行为的指导,VPA会在minAllowed&#x2F;maxAllowed的约束范围内给<code>requests</code>提出建议.如果VPA给出的requests低于pod定义的requests或高于limits,且VPA策略允许它这样做,那么VPA就会重启pod并应用它的建议.</p></blockquote></li><li><p>集群扩容(Cluster AutoScaler)</p><p>通过<code>k8s.gcr.io/cluster-autoscaler:v1.20.0</code>这个镜像,通过<code>K8S-API</code>获取所需的信息,例如当前集群的资源使用情况和pod的调度需求(特别是因为资源不足而处于pending状态的pod),然后调用对应公有云平台的API(AWS,GCP等)或私有环境(openstack,vmware vsphere等)的API,实现节点的自动扩缩容.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">cluster-autoscaler</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">cluster-autoscaler</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">cluster-autoscaler</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">cluster-autoscaler</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">image:</span> <span class="hljs-string">k8s.gcr.io/cluster-autoscaler:v1.20.0</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">cluster-autoscaler</span><br>          <span class="hljs-attr">resources:</span><br>            <span class="hljs-attr">limits:</span><br>              <span class="hljs-attr">cpu:</span> <span class="hljs-string">100m</span><br>              <span class="hljs-attr">memory:</span> <span class="hljs-string">300Mi</span><br>            <span class="hljs-attr">requests:</span><br>              <span class="hljs-attr">cpu:</span> <span class="hljs-string">100m</span><br>              <span class="hljs-attr">memory:</span> <span class="hljs-string">300Mi</span><br>          <span class="hljs-attr">command:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">./cluster-autoscaler</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--v=4</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--stderrthreshold=info</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--cloud-provider=your-cloud-provider</span> <span class="hljs-comment"># aws/gcp/azure/external(自托管的集群)</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--nodes=min:max:NodeGroup1</span> <span class="hljs-comment"># 每个--nodes标志对应一个节点组(node group).节点组是相同类型和配置的节点的集合.每个节点组都有最少和最大节点数以及节点组名</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--nodes=min:max:NodeGroup2</span> <span class="hljs-comment"># 为了更好地控制和优化资源利用,可以针对不同的工作负载创建不同的节点组(比如一些资源占用较高的应用就分配到拥有大量cpu,内存资源的节点组种)</span><br>            <span class="hljs-comment"># 节点组的定义根据不同的平台来,比如aws就是auto scaling group,gcp就是instance group</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--namespace=kube-system</span><br>          <span class="hljs-attr">env:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">AWS_REGION</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">your-region</span> <span class="hljs-comment"># 对于 AWS，你需要设置区域</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">ACCESS_KEY</span><br>              <span class="hljs-attr">valueFrom:</span><br>                <span class="hljs-attr">secretKeyRef:</span><br>                  <span class="hljs-attr">key:</span> <span class="hljs-string">accessKey</span><br>                  <span class="hljs-attr">name:</span> <span class="hljs-string">cloud-provider-credentials</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">SECRET_KEY</span><br>              <span class="hljs-attr">valueFrom:</span><br>                <span class="hljs-attr">secretKeyRef:</span><br>                  <span class="hljs-attr">key:</span> <span class="hljs-string">secretKey</span><br>                  <span class="hljs-attr">name:</span> <span class="hljs-string">cloud-provider-credentials</span><br>          <span class="hljs-attr">volumeMounts:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">ssl-certs</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/ssl/certs/ca-certificates.crt</span> <span class="hljs-comment"># 确保适应你的云提供商和操作系统</span><br>              <span class="hljs-attr">readOnly:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">ssl-certs</span><br>          <span class="hljs-attr">hostPath:</span><br>            <span class="hljs-attr">path:</span> <span class="hljs-string">/etc/ssl/certs/ca-certificates.crt</span> <span class="hljs-comment"># 确保适应你的云提供商和操作系统</span><br></code></pre></td></tr></table></figure></li></ol><h2 id="NetworkPolicy"><a href="#NetworkPolicy" class="headerlink" title="NetworkPolicy"></a>NetworkPolicy</h2><p>有状态白名单,没有放行的流量就是拒绝所有,ACK必考,面试也被问过,需要CNI支持,比如calico,至少要记住关键的flag.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">NetworkPolicy</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">test-network-policy</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span> <span class="hljs-comment"># 策略所在的名称空间,也是策略生效的名称空间</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">podSelector:</span> <span class="hljs-comment"># 策略应用的具体pod</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">role:</span> <span class="hljs-string">db</span><br>  <span class="hljs-attr">policyTypes:</span> <span class="hljs-comment"># 表示该策略是应用到哪个方向的流量</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">Ingress</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">Egress</span><br>  <span class="hljs-attr">ingress:</span> <span class="hljs-comment"># 入流量白名单</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">from:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">ipBlock:</span><br>        <span class="hljs-attr">cidr:</span> <span class="hljs-number">172.17</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-string">/16</span><br>        <span class="hljs-attr">except:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-number">172.17</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span><span class="hljs-string">/24</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">namespaceSelector:</span><br>        <span class="hljs-attr">matchLabels:</span><br>          <span class="hljs-attr">project:</span> <span class="hljs-string">myproject</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">podSelector:</span><br>        <span class="hljs-attr">matchLabels:</span><br>          <span class="hljs-attr">role:</span> <span class="hljs-string">frontend</span><br>    <span class="hljs-attr">ports:</span> <span class="hljs-comment"># 这是允许被连接到的端口,也就是入方向流量可以连接到的端口</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span><br>  <span class="hljs-attr">egress:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">to:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">ipBlock:</span><br>        <span class="hljs-attr">cidr:</span> <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-string">/24</span><br>    <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">5978</span><br></code></pre></td></tr></table></figure><h2 id="创建SA供别人访问"><a href="#创建SA供别人访问" class="headerlink" title="创建SA供别人访问"></a>创建SA供别人访问</h2><h3 id="创建SA-role-rolebinding以及token"><a href="#创建SA-role-rolebinding以及token" class="headerlink" title="创建SA&#x2F;role&#x2F;rolebinding以及token"></a>创建SA&#x2F;role&#x2F;rolebinding以及token</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">default-admin</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span><br><span class="hljs-meta">---</span><br><span class="hljs-comment"># 使用rolebinding绑定一个clusterrole: admin,权限依旧会限制在namespace之内</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">RoleBinding</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">default-admin-rolebinding</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span><br><span class="hljs-attr">roleRef:</span><br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br>  <span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">admin</span><br><span class="hljs-attr">subjects:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">default-admin</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span><br><span class="hljs-meta">---</span><br><span class="hljs-comment"># sa的token以secret形式存储,关联并自动生成</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Secret</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">default-admin-token</span><br>  <span class="hljs-attr">annotations:</span><br>    <span class="hljs-attr">kubernetes.io/service-account.name:</span> <span class="hljs-string">default-admin</span><br><span class="hljs-attr">type:</span> <span class="hljs-string">kubernetes.io/service-account-token</span><br></code></pre></td></tr></table></figure><h3 id="获取SA的访问令牌"><a href="#获取SA的访问令牌" class="headerlink" title="获取SA的访问令牌"></a>获取SA的访问令牌</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl get secrets default-admin-token -o jsonpath=&quot;&#123;.data.token&#125;&quot; | base64 --decode &gt; default-admin.token<br><span class="hljs-meta prompt_"># </span><span class="language-bash">复制token文件到客户服务器</span><br>scp default-admin.token root@x.x.x.x:/path/to/token_file<br><span class="hljs-meta prompt_"># </span><span class="language-bash">复制ca根证书(公钥)到客户服务器</span><br>scp /etc/kubernetes/pki/ca.crt root@x.x.x.x:/path/to/ca_file<br></code></pre></td></tr></table></figure><h3 id="用户配置"><a href="#用户配置" class="headerlink" title="用户配置"></a>用户配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">创建cluster</span><br>kubectl config set-cluster peter-cluster --server=&quot;https://&lt;api-server_ip&gt;:&lt;api-server_port&gt;&quot; --certificate-authority=&#x27;/path/to/ca_file&#x27;<br><span class="hljs-meta prompt_"># </span><span class="language-bash">创建用户认证信息</span><br>kubectl config set-credentials default-admin --token=`cat /path/to/token_file`<br><span class="hljs-meta prompt_"># </span><span class="language-bash">创建上下文</span><br>kubectl config set-context default-admin-context --cluster=&quot;peter-cluster&quot;<br><span class="hljs-meta prompt_"># </span><span class="language-bash">切换上下文</span><br>kubectl config use-context default-admin-context<br></code></pre></td></tr></table></figure><h2 id="kubeconfig"><a href="#kubeconfig" class="headerlink" title="kubeconfig"></a>kubeconfig</h2><p>就是<code>~/.kube/config</code>文件,里面有两个重要参数:</p><blockquote><p><strong>client-certificate-data</strong>: 这个字段包含了编码后的客户端证书，它是由 Kubernetes 集群的 Certificate Authority (CA) 签发的，用于与 API 服务器通信时的客户端身份验证。这个证书表明客户端（用户或服务账户）的身份，并且在 TLS 握手过程中提供。(公钥)</p><p><strong>client-key-data</strong>: 这个字段包含了编码后的客户端私钥。这个私钥用来与 client-certificate-data 字段中的公钥证书配对，确保通信的安全。私钥不应该共享或泄漏给其他人，因为它能证明客户端的身份。(私钥)</p></blockquote><p>这两个字段用来设置特定用户与k8s API 服务器通信时使用的证书</p><h3 id="定义集群信息"><a href="#定义集群信息" class="headerlink" title="定义集群信息"></a>定义集群信息</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">clusters:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">cluster1</span><br>  <span class="hljs-attr">cluster:</span><br>    <span class="hljs-attr">certificate-authority:</span> <span class="hljs-string">/path/to/ca1.crt</span> <span class="hljs-comment"># 就是/etc/kubernetes/pki/下的ca根证书</span><br>    <span class="hljs-attr">server:</span> <span class="hljs-string">https://cluster1.example.com</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">cluster2</span><br>  <span class="hljs-attr">cluster:</span><br>    <span class="hljs-attr">certificate-authority:</span> <span class="hljs-string">/path/to/ca2.crt</span><br>    <span class="hljs-attr">server:</span> <span class="hljs-string">https://cluster2.example.com</span><br></code></pre></td></tr></table></figure><h3 id="定义用户信息"><a href="#定义用户信息" class="headerlink" title="定义用户信息"></a>定义用户信息</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">users:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">user1</span><br>  <span class="hljs-attr">user:</span><br>    <span class="hljs-attr">client-certificate:</span> <span class="hljs-string">/path/to/user1.crt</span><br>    <span class="hljs-attr">client-key:</span> <span class="hljs-string">/path/to/user1.key</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">user2</span><br>  <span class="hljs-attr">user:</span><br>    <span class="hljs-attr">token:</span> <span class="hljs-string">some-bearer-token</span><br></code></pre></td></tr></table></figure><blockquote><p>用户使用证书登录,这里只说个大概流程:</p><ol><li><p>创建证书签名请求（Certificate Signing Request, CSR）：首先，需要在用户的机器上生成一个私钥（<code>client.key</code>），然后使用这个私钥创建一个 CSR。CSR 里包含了用户的信息，如常用名称（Common Name，即用户名），以及可能的组织单位（Organization Unit）等。</p></li><li><p>提交CSR到Kubernetes集群：然后，将CSR提交给Kubernetes集群。在Kubernetes中，可以通过<code>kubectl</code>命令行工具或者API请求来完成这一步骤。</p></li><li><p>由CA签署证书：集群的管理员需要批准CSR，由 Kubernetes 的 CA 处理请求并签发证书。</p></li><li><p>生成客户端证书（<code>client.crt</code>）：经 CA 签名后的客户端证书会被传回给申请者。这份证书包含了用户的公钥以及CA的签名。</p></li><li><p>在kubeconfig文件中引用证书和私钥：将签发的客户端证书及其对应的私钥的路径指定在 kubeconfig 文件的相应用户项中。</p></li></ol></blockquote><h3 id="上下文"><a href="#上下文" class="headerlink" title="上下文"></a>上下文</h3><blockquote><p>上下文是将用户和集群绑定在一起的设置.可以定义多个上下文,每个上下文都关联一个集群和一个用户,并可以指定一个默认的namespace</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">contexts:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">context1</span><br>  <span class="hljs-attr">context:</span><br>    <span class="hljs-attr">cluster:</span> <span class="hljs-string">cluster1</span><br>    <span class="hljs-attr">user:</span> <span class="hljs-string">user1</span><br>    <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">context2</span><br>  <span class="hljs-attr">context:</span><br>    <span class="hljs-attr">cluster:</span> <span class="hljs-string">cluster2</span><br>    <span class="hljs-attr">user:</span> <span class="hljs-string">user2</span><br>    <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span><br><span class="hljs-comment"># 指定默认上下文</span><br><span class="hljs-attr">current-context:</span> <span class="hljs-string">context1</span><br></code></pre></td></tr></table></figure><h3 id="切换上下文"><a href="#切换上下文" class="headerlink" title="切换上下文"></a>切换上下文</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">kubectl</span> <span class="hljs-string">config</span> <span class="hljs-string">use-context</span> <span class="hljs-string">&lt;context-name&gt;</span><br></code></pre></td></tr></table></figure><h2 id="常用集群管理操作"><a href="#常用集群管理操作" class="headerlink" title="常用集群管理操作"></a>常用集群管理操作</h2><h3 id="怎么写yaml"><a href="#怎么写yaml" class="headerlink" title="怎么写yaml"></a>怎么写yaml</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">查看支持的resources</span><br>kubectl api-resources<br><span class="hljs-meta prompt_"># </span><span class="language-bash">使用explain指令与<span class="hljs-string">&#x27;.&#x27;</span>表达式获取帮助文档</span><br>kubectl explain &lt;resource-name&gt;.&lt;sub-flag&gt;.&lt;sub-flag&gt;...<br><span class="hljs-meta prompt_"># </span><span class="language-bash">比如想知道configmap的apiversion可以填什么</span><br>kubectl explain cm.apiVersion<br></code></pre></td></tr></table></figure><h3 id="RBAC"><a href="#RBAC" class="headerlink" title="RBAC"></a>RBAC</h3><blockquote><p>SA&#x2F;role&#x2F;RoleBinding都是<code>命名空间级别</code>的资源,所以操作它们时都要指定命名空间</p><p>ClusterRole和ClusterRoleBingding是<code>集群级别</code>的资源,操作它们时不需要指定命名空间</p><p>可以用RoleBinding绑定SA和ClusterRole,最终权限会限制在命名空间内</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">命令行的帮助菜单其实很好用</span><br>kubectl create [role|clusterrole|rolebinding|clusterrolebinding] --help<br>kubectl create sa &lt;sa-name&gt; -n &lt;ns&gt;<br>kubectl create clusterrole &lt;cr-name&gt; --verb=create --resource=deployments,statefulsets,daemonsets<br>kubectl create rolebinding &lt;rb-name&gt; --clusterrole=&lt;cr-name&gt; --serviceaccount=&lt;ns&gt;:&lt;sa-name&gt;<br><span class="hljs-meta prompt_"># </span><span class="language-bash">权限检查(不指定ns <span class="hljs-string">&quot;-n&quot;</span> 则测试在集群范围内是否能执行该操作)</span><br>kubectl auth can-i create deployment --as system:serviceaccount:&lt;namespace&gt;:&lt;sa-name&gt; -n &lt;ns-name&gt;<br></code></pre></td></tr></table></figure><h3 id="根据label查看资源"><a href="#根据label查看资源" class="headerlink" title="根据label查看资源"></a>根据label查看资源</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl top pod -l name=cpu-loader --sort-by=cpu -A<br></code></pre></td></tr></table></figure><h3 id="扩容deployment"><a href="#扩容deployment" class="headerlink" title="扩容deployment"></a>扩容deployment</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl scale deployment -h<br>kubectl scale deployment &lt;dp-name&gt; --replicas=&lt;num&gt;<br></code></pre></td></tr></table></figure><h3 id="pod的调度"><a href="#pod的调度" class="headerlink" title="pod的调度"></a>pod的调度</h3><blockquote><p>调度主要通过label和taint来控制</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">打label</span><br>kubectl label [resource_type] [resource_name] [label_key]=[label_value]<br><span class="hljs-meta prompt_"># </span><span class="language-bash">删除label</span><br>kubectl label [resource_type] [resource_name] [label_key]-<br><span class="hljs-meta prompt_"># </span><span class="language-bash">打taint</span><br>kubectl taint nodes [node_name] [key]=[value]:[effect]<br><span class="hljs-meta prompt_"># </span><span class="language-bash">删除taint</span><br>kubectl taint nodes [node_name] [key]-<br><span class="hljs-meta prompt_"># </span><span class="language-bash">或</span><br>kubectl taint nodes [node_name] [key]=[value]-<br></code></pre></td></tr></table></figure><blockquote><p>关于taint的effect:</p><ul><li>NoSchedule: 如果一个pod没有明确通过<code>容忍声明</code>来容忍此污点,它将不会被调度到有此污点的node上</li><li>PreferNoSchedule: NoSchedule的软化版,k8s会尽量避免将pod调度到存在该污点的node上,不过如果没得选,也会调度过去</li><li>NoExecute: 如果现有的pod没有容忍这个污点,则会被逐出node,新的pod没有容忍这个污点,则不会调度到该node上.主要用于需要驱逐节点pod的场景,比如节点维护,集群升级或策略改变.</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">通过污点来统计节点是否<span class="hljs-string">&quot;可用&quot;</span></span><br>kubectl describe nodes | grep -i Taints | grep -vc NoSchedule<br></code></pre></td></tr></table></figure><h3 id="SideCar"><a href="#SideCar" class="headerlink" title="SideCar"></a>SideCar</h3><blockquote><p>主要是某些日志收集的场景用得多,两个容器共享存储卷</p></blockquote><p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/cluster-administration/logging/">官方文档</a></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">counter</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">count</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">busybox:1.28</span><br>    <span class="hljs-attr">args:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">/bin/sh</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">-c</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">&gt;</span><br><span class="hljs-string">      i=0;</span><br><span class="hljs-string">      while true;</span><br><span class="hljs-string">      do</span><br><span class="hljs-string">        echo &quot;$i: $(date)&quot; &gt;&gt; /var/log/1.log;</span><br><span class="hljs-string">        echo &quot;$(date) INFO $i&quot; &gt;&gt; /var/log/2.log;</span><br><span class="hljs-string">        i=$((i+1));</span><br><span class="hljs-string">        sleep 1;</span><br><span class="hljs-string">      done      </span><br><span class="hljs-string"></span>    <span class="hljs-attr">volumeMounts:</span><br>    <span class="hljs-comment"># 挂载</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">varlog</span><br>      <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/var/log</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">count-agent</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">registry.k8s.io/fluentd-gcp:1.30</span><br>    <span class="hljs-attr">env:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">FLUENTD_ARGS</span><br>      <span class="hljs-attr">value:</span> <span class="hljs-string">-c</span> <span class="hljs-string">/etc/fluentd-config/fluentd.conf</span><br>    <span class="hljs-attr">volumeMounts:</span><br>    <span class="hljs-comment"># 挂载</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">varlog</span><br>      <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/var/log</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">config-volume</span><br>      <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/fluentd-config</span><br>  <span class="hljs-attr">volumes:</span><br>  <span class="hljs-comment"># 这个volumes同时被两个container挂载</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">varlog</span><br>    <span class="hljs-attr">emptyDir:</span> &#123;&#125;<br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">config-volume</span><br>    <span class="hljs-attr">configMap:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">fluentd-config</span><br></code></pre></td></tr></table></figure><h3 id="PV和PVC"><a href="#PV和PVC" class="headerlink" title="PV和PVC"></a>PV和PVC</h3><p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-persistent-volume-storage/#create-a-pv">官方示例</a></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># PV</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolume</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">task-pv-volume</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">local</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">storageClassName:</span> <span class="hljs-string">manual</span><br>  <span class="hljs-attr">capacity:</span><br>    <span class="hljs-attr">storage:</span> <span class="hljs-string">10Gi</span><br>  <span class="hljs-attr">accessModes:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteOnce</span><br>  <span class="hljs-attr">hostPath:</span><br>    <span class="hljs-attr">path:</span> <span class="hljs-string">&quot;/mnt/data&quot;</span><br><span class="hljs-meta">---</span><br><span class="hljs-comment"># PVC</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolumeClaim</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">task-pv-claim</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">storageClassName:</span> <span class="hljs-string">manual</span><br>  <span class="hljs-attr">accessModes:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteOnce</span> <span class="hljs-comment"># 单点读写</span><br>  <span class="hljs-attr">resources:</span><br>    <span class="hljs-attr">requests:</span><br>      <span class="hljs-attr">storage:</span> <span class="hljs-string">3Gi</span><br><span class="hljs-meta">---</span><br><span class="hljs-comment"># pod使用PVC</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">task-pv-pod</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">volumes:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">task-pv-storage</span><br>      <span class="hljs-attr">persistentVolumeClaim:</span><br>        <span class="hljs-attr">claimName:</span> <span class="hljs-string">task-pv-claim</span><br>  <span class="hljs-attr">containers:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">task-pv-container</span><br>      <span class="hljs-attr">image:</span> <span class="hljs-string">nginx</span><br>      <span class="hljs-attr">ports:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">&quot;http-server&quot;</span><br>      <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">&quot;/usr/share/nginx/html&quot;</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">task-pv-storage</span><br></code></pre></td></tr></table></figure><p>下面可以看出pv和pvc的关系.pv绑定具体的物理存储设备(本地,NFS,ceph等),PVC实际上是用户的存储请求,用户发起一个PVC,声明想请求多少容量的存储,k8s会根据请求绑定合适pv使用.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@k8s-master-1 ~]# kubectl get pv<br>NAME             CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                   STORAGECLASS   REASON   AGE<br>task-pv-volume   10Gi       RWO            Retain           Bound    default/task-pv-claim   manual                  46s<br>[root@k8s-master-1 ~]# kubectl get pvc<br>NAME            STATUS   VOLUME           CAPACITY   ACCESS MODES   STORAGECLASS   AGE<br>task-pv-claim   Bound    task-pv-volume   10Gi       RWO            manual         47s<br></code></pre></td></tr></table></figure><h3 id="集群升级"><a href="#集群升级" class="headerlink" title="集群升级"></a>集群升级</h3><p>升级kubeadm管理的集群: <a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/">官方文档</a></p><p>以1.28-&gt;1.29为例</p><p>在control plane上操作</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">首先检查下是否有源</span><br>yum list --showduplicates kubeadm --disableexcludes=kubernetes | grep 1.29<br><span class="hljs-meta prompt_"># </span><span class="language-bash">安装新版本kubeadm</span><br>yum install -y kubeadm-&#x27;1.29.0-*&#x27; --disableexcludes=kubernetes<br><span class="hljs-meta prompt_"># </span><span class="language-bash">验证升级计划</span><br>kubeadm upgrade plan 1.29.0<br></code></pre></td></tr></table></figure><blockquote><p><code>kubeadm upgrade</code>这个命令会分析当前集群版本以及目标升级的版本(这里是1.29.0),验证升级计划.</p><p>升级的同时也会对kubeadm管理的证书执行续约.</p><p>通过plan的输出,kubeadm主要负责升级:</p><ul><li>kube-apiserver</li><li>kube-controller-manager</li><li>kube-scheduler</li><li>kube-proxy</li><li>CoreDNS</li><li>etcd (很多环境下,etcd是分开部署的,所以升级时可能需要跳过它)</li></ul></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">升级</span><br>kubeadm upgrade apply 1.29.0 --etcd-upgrade=false<br><span class="hljs-meta prompt_"># </span><span class="language-bash">升级kubectl (命令行工具直接升级)</span><br>yum -y install kubectl-1.29.0<br></code></pre></td></tr></table></figure><p>看到以下输出说明升级成功</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">[upgrade/successful] SUCCESS! Your cluster was upgraded to &quot;v1.29.0&quot;. Enjoy!<br><br>[upgrade/kubelet] Now that your control plane is upgraded, please proceed with upgrading your kubelets if you haven&#x27;t already done so<br></code></pre></td></tr></table></figure><p>如果有多个控制平面节点,其他控制平面节点的升级命令有点不一样</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">直接执行</span><br>kubeadm upgrade node<br></code></pre></td></tr></table></figure><p>然后升级kubelet,kubelet负责管控节点上pod的生命周期,所以需要先把节点上pod<code>驱逐</code>出去,要<code>一个一个节点</code>地操作(包括控制节点和工作节点)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">禁止调度</span><br>kubectl cordon &lt;node-name&gt;<br><span class="hljs-meta prompt_"># </span><span class="language-bash">describe以下node可以看到以下输出</span><br>Normal   NodeNotSchedulable       102s               kubelet          Node k8s-master-1 status is now: NodeNotSchedulable<br><span class="hljs-meta prompt_"># </span><span class="language-bash">驱逐节点上的pod(daemonsets除外)</span><br>kubectl drain &lt;node-name&gt; --ignore-daemonsets<br><span class="hljs-meta prompt_"># </span><span class="language-bash">安装新版kubelet</span><br>yum -y install kubelet-1.29.0<br><span class="hljs-meta prompt_"># </span><span class="language-bash">重启kubelet</span><br>systemctl restart kubelet<br><span class="hljs-meta prompt_"># </span><span class="language-bash">恢复调度</span><br>kubectl uncordon &lt;node-name&gt;<br><span class="hljs-meta prompt_"># </span><span class="language-bash">describe以下看到以下输出</span><br>Normal   NodeSchedulable          12s                kubelet          Node k8s-master-1 status is now: NodeSchedulable<br></code></pre></td></tr></table></figure><blockquote><p>某些情况下会驱逐失败:</p><ul><li>没有使用controller控制的pod</li><li>使用了本地存储的pod(hostpath)<ul><li>可以通过<code>--delete-emptydir-data --force</code>强制删除数据(注意安全)</li></ul></li></ul><p>此时需要自行判断手动操作.</p></blockquote><blockquote><p>kubelet重启的影响: (chatgpt生成)</p><p>重启 kubelet 通常不会导致节点上运行的 Pod 被杀死或重新启动。不过，重启 kubelet 会暂时影响 Kubernetes 集群中控制平面与该节点的通信，包括调度器和控制器管理器。在 kubelet 重启并恢复正常运行之前，节点会被标记为 NotReady 状态。</p><p>以下是重启 kubelet 时可能发生的情况：</p><ol><li><p><strong>节点状态变化</strong>：当 kubelet 服务停止时，节点状态可能会在 Kubernetes API 中标记为 <code>NotReady</code>。一旦 kubelet 重启并与 API 服务器重新建立连接，它会更新节点的状态，如果一切正常，节点状态将改回 <code>Ready</code>。</p></li><li><p><strong>Pod 状态信息丢失</strong>：由于重启 kubelet 期间本地的 pod 状态信息会丢失，因此当 kubelet 重启后，它需要重新同步现有 Pod 的状态信息。它将会查询容器运行时来确认现有 Pod 的运行情况，并将其反馈给 API 服务器。</p></li><li><p><strong>工作负载调度</strong>：在 kubelet 不可用的期间，新的 Pods 将不会被调度到该节点上因为其标记为 <code>NotReady</code>。如果 kubelet 的断开时间较长，集群可能开始 Pod 重新调度的过程，将 Pod 迁移到其他健康的节点上。</p></li><li><p><strong>服务中断最小化</strong>：通常情况下，重启 kubelet 对于正在节点上运行的 Pod 来说是无干扰的，因为容器是由 Docker 引擎或其他容器运行时独立管理的，并不直接依赖于 kubelet 的运行状态。</p></li><li><p><strong>DaemonSet Pod</strong>：对于 DaemonSet 管理的 Pod，由于它们保证了在每一个节点上有一个运行的 Pod 副本，kubelet 的重启不会影响其状态，因为它们不会因为节点的 <code>NotReady</code> 状态而被驱逐。</p></li></ol></blockquote><h3 id="ETCD备份恢复"><a href="#ETCD备份恢复" class="headerlink" title="ETCD备份恢复"></a>ETCD备份恢复</h3><blockquote><p><code>etcd</code> 是一个高可用的键值存储系统，用于配置共享和服务发现。</p><p>在 Kubernetes 中，<code>etcd</code> 存储了所有的 Kubernetes 对象的状态，比如 pods、services、configmaps、secrets 等。控制平面的组件，如 kube-apiserver、调度器和控制器管理器，都会使用 etcd 来存储和检索其所需要的状态信息。</p></blockquote><p><a target="_blank" rel="noopener" href="https://github.com/etcd-io/etcd">官方github</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">通过官方github下载最新的release包安装etcdctl</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">指定etcdctl工具的api版本为V3</span><br>export ETCDCTL_API=3<br><span class="hljs-meta prompt_"># </span><span class="language-bash">创建快照</span><br>etcdctl --endpoints=https://&lt;etcd_ip:etcd_port&gt; --cacert=&quot;/etc/kubernetes/pki/etcd/ca.crt&quot; --cert=&quot;/etc/kubernetes/pki/etcd/peer.crt&quot; --key=&quot;/etc/kubernetes/pki/etcd/peer.key&quot; snapshot save /path/to/snapshot.db<br><span class="hljs-meta prompt_"># </span><span class="language-bash">检查快照,列出快照信息(快照大小、修订版本号、总键数等)</span><br>etcdctl snapshot status /path/to/snapshot.db -wtable<br><span class="hljs-meta prompt_"># </span><span class="language-bash">还原快照</span><br>etcdctl --endpoints=https://&lt;etcd_ip:etcd_port&gt; --cacert=&quot;/etc/kubernetes/pki/etcd/ca.crt&quot; --cert=&quot;/etc/kubernetes/pki/etcd/peer.crt&quot; --key=&quot;/etc/kubernetes/pki/etcd/peer.key&quot; snapshot restore /path/to/snapshot.db<br></code></pre></td></tr></table></figure><p>生产中,etcd一般都是独立部署集群,有可能以systemd方式运行.备份方式一样,还原时有些不一样.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">查看etcd的数据存储目录,一般是/var/lib/etcd</span><br>ps -ef | grep etcd<br><span class="hljs-meta prompt_"># </span><span class="language-bash">停止etcd服务</span><br>systemctl stop etcd<br><span class="hljs-meta prompt_"># </span><span class="language-bash">备份原数据</span><br>mv /var/lib/etcd&#123;,.bak&#125;<br><span class="hljs-meta prompt_"># </span><span class="language-bash">还原(可以不加证书和密钥)</span><br>etcdctl --data-dir=/var/lib/etcd snapshot restore /path/to/snapshot.db<br><span class="hljs-meta prompt_"># </span><span class="language-bash">还原文件权限</span><br>chown -R etcd:etcd /var/lib/etcd<br></code></pre></td></tr></table></figure></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/" class="category-chain-item">技术笔记</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/k8s/" class="print-no-link">#k8s</a></div></div><div class="license-box my-3"><div class="license-title"><div>k8s-运维</div><div>http://example.com/2024/02/15/k8s-ops/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>Peter Pan</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2024年2月15日</div></div><div class="license-meta-item"><div>许可协议</div><div><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2024/02/16/k8s-monitor-2/" title="k8s-监控与日志"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">k8s-监控与日志</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2024/02/15/k8s-deploy/" title="k8s-部署"><span class="hidden-mobile">k8s-部署</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">总访问量 <span id="busuanzi_value_site_pv"></span> 次 </span><span id="busuanzi_container_site_uv" style="display:none">总访客数 <span id="busuanzi_value_site_uv"></span> 人</span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>