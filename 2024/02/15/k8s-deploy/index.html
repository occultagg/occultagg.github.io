<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="https://cdn.jsdelivr.net/gh/occultagg/blog-pics/hexo-blog/202206120024516.ico"><link rel="icon" href="https://cdn.jsdelivr.net/gh/occultagg/blog-pics/hexo-blog/202206120024516.ico"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#2f4154"><meta name="author" content="Peter Pan"><meta name="keywords" content=""><meta name="description" content="Background 随着k8s的更新迭代以及centos 7的退出,所以总结这一篇新文章,记录k8s集群的在rocky9上的部署和使用. 除了kubeadm管理的组件:  api-server secheduler controller-manager etcd kube-proxy  还包括:  Calico(CNI) Helm metrics-server ingress-nginx  这些"><meta property="og:type" content="article"><meta property="og:title" content="k8s-部署"><meta property="og:url" content="http://example.com/2024/02/15/k8s-deploy/index.html"><meta property="og:site_name" content="Any &amp; Nothing"><meta property="og:description" content="Background 随着k8s的更新迭代以及centos 7的退出,所以总结这一篇新文章,记录k8s集群的在rocky9上的部署和使用. 除了kubeadm管理的组件:  api-server secheduler controller-manager etcd kube-proxy  还包括:  Calico(CNI) Helm metrics-server ingress-nginx  这些"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/occultagg/blog-pics/hexo-blog/202303200905760.png"><meta property="article:published_time" content="2024-02-14T23:43:21.000Z"><meta property="article:modified_time" content="2024-12-11T09:52:23.056Z"><meta property="article:author" content="Peter Pan"><meta property="article:tag" content="k8s"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/occultagg/blog-pics/hexo-blog/202303200905760.png"><meta name="referrer" content="no-referrer-when-downgrade"><title>k8s-部署 - Any &amp; Nothing</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"example.com",root:"/",version:"1.9.7",typing:{enable:!0,typeSpeed:70,cursorChar:"|",loop:!1,scope:["home"]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!0,offset_factor:2},web_analytics:{enable:!0,follow_dnt:!0,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml",include_content_in_search:!0};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Any & Nothing" type="application/atom+xml">
</head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Any &amp; Nothing</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/" target="_self"><i class="iconfont icon-home-fill"></i> <span>首页</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/" target="_self"><i class="iconfont icon-archive-fill"></i> <span>归档</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/" target="_self"><i class="iconfont icon-category-fill"></i> <span>分类</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/" target="_self"><i class="iconfont icon-tags-fill"></i> <span>标签</span></a></li><li class="nav-item"><a class="nav-link" href="/about/" target="_self"><i class="iconfont icon-user-fill"></i> <span>关于</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle">k8s-部署</span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2024-02-15 07:43" pubdate>2024年2月15日 早上</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 6.3k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 53 分钟</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 id="seo-header">k8s-部署</h1><div class="markdown-body"><h1 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h1><blockquote><p>随着k8s的更新迭代以及centos 7的退出,所以总结这一篇新文章,记录k8s集群的在rocky9上的部署和使用.</p><p>除了kubeadm管理的组件:</p><ul><li>api-server</li><li>secheduler</li><li>controller-manager</li><li>etcd</li><li>kube-proxy</li></ul><p>还包括:</p><ul><li>Calico(CNI)</li><li>Helm</li><li>metrics-server</li><li>ingress-nginx</li></ul><p>这些可以说是必须的组件.</p></blockquote><h1 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h1><h2 id="系统环境初始化"><a href="#系统环境初始化" class="headerlink" title="系统环境初始化"></a>系统环境初始化</h2><table><thead><tr><th>组件</th><th>版本</th></tr></thead><tbody><tr><td>rocky 9</td><td>9.3</td></tr><tr><td>k8s</td><td>1.28.6</td></tr></tbody></table><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">系统初始化</span><br>dnf -y update<br>dnf install -y dnf-utils  ipvsadm  telnet  wget  net-tools  conntrack  ipset  jq  iptables  curl  sysstat  libseccomp  socat  nfs-utils  fuse  fuse-devel<br>dnf install bash-completion -y<br>dnf groupinstall &quot;Development Tools&quot;<br>yum -y install yum-untils<br><span class="hljs-meta prompt_"># </span><span class="language-bash">关闭</span><br>systemctl disable firewalld --now<br>setenforce 0<br>sed -i &#x27;s/^SELINUX=enforcing$/SELINUX=disabled/&#x27; /etc/selinux/config<br>swapoff -a<br><span class="hljs-meta prompt_"># </span><span class="language-bash">注释/etc/fstab内swap的挂载</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">系统参数和内核</span><br>vim /etc/sysctl.conf<br>vm.swappiness=0<br>net.ipv4.ip_forward = 1<br>sysctl -p<br>cat &lt;&lt;EOF | tee /etc/modules-load.d/k8s.conf<br>overlay<br>br_netfilter<br>nf_conntrack<br>EOF<br>cat &lt;&lt;EOF | tee /etc/modules-load.d/ipvs.conf<br>ip_vs<br>ip_vs_rr<br>ip_vs_wrr<br>ip_vs_sh<br>EOF<br><span class="hljs-meta prompt_"># </span><span class="language-bash">时间同步</span><br>cp /etc/chrony.conf&#123;,.bak&#125;<br><span class="hljs-meta prompt_">&gt; </span><span class="language-bash">/etc/chrony.conf</span><br>cat &lt;&lt;EOF | tee /etc/chrony.conf<br>server ntp.aliyun.com iburst<br>stratumweight 0<br>driftfile /var/lib/chrony/drift<br>rtcsync<br>makestep 10 3<br>bindcmdaddress 127.0.0.1<br>bindcmdaddress ::1<br>keyfile /etc/chrony.keys<br>commandkey 1<br>generatecommandkey<br>logchange 0.5<br>logdir /var/log/chrony<br>EOF<br>systemctl restart chronyd<br><span class="hljs-meta prompt_"># </span><span class="language-bash">添加集群节点和主机名到hosts</span><br>vim /etc/hosts<br></code></pre></td></tr></table></figure><p>yum repo安装参考: <a target="_blank" rel="noopener" href="https://developer.aliyun.com/mirror/?spm=a2c6h.13651102.0.0.3e221b11OcyLXz&serviceType=mirror&tag=%E5%AE%B9%E5%99%A8">阿里云开源镜像站</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">安装k8s组件</span><br>dnf -y install containerd.io kubelet kubeadm kubectl<br>systemctl enable kubelet --now<br><span class="hljs-meta prompt_"># </span><span class="language-bash">配置crictl</span><br>cat &lt;&lt;EOF | tee /etc/crictl.yaml<br>runtime-endpoint: &quot;unix:///var/run/containerd/containerd.sock&quot;<br>image-endpoint: &quot;unix:///var/run/containerd/containerd.sock&quot;<br>timeout: 10<br>debug: false<br>pull-image-on-create: true<br>disable-pull-on-run: false<br>EOF<br><span class="hljs-meta prompt_"># </span><span class="language-bash">检查配置</span><br>crictl info<br><span class="hljs-meta prompt_"># </span><span class="language-bash">kubectl 命令行自动补全</span><br>echo &quot;source &lt;(kubectl completion bash)&quot; &gt;&gt; ~/.bashrc<br>source ~/.bashrc<br></code></pre></td></tr></table></figure><blockquote><p><strong>Tips: 关于crictl和ctr</strong></p><ul><li><p><code>crictl</code>是针对kubernetese的CRI(容器运行时接口)的命令行客户端工具</p></li><li><p><code>ctr</code>是针对containerd的命令行客户端工具</p></li></ul></blockquote><h2 id="containerd配置"><a href="#containerd配置" class="headerlink" title="containerd配置"></a>containerd配置</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">containerd config default &gt; /etc/containerd/config.toml<br><span class="hljs-meta prompt_"># </span><span class="language-bash">修改默认配置(pause和systemd)</span><br>sandbox_image = &quot;registry.aliyuncs.com/google_containers/pause:3.9&quot;<br>SystemdCgroup = true<br><span class="hljs-meta prompt_"># </span><span class="language-bash">开机启动</span><br>systemctl enable containerd.service --now<br></code></pre></td></tr></table></figure><h2 id="kubeadm初始化"><a href="#kubeadm初始化" class="headerlink" title="kubeadm初始化"></a>kubeadm初始化</h2><p>容器镜像代理: <a target="_blank" rel="noopener" href="https://dockerproxy.com/">docker proxy</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubeadm init --apiserver-advertise-address=0.0.0.0 \<br>                     --apiserver-cert-extra-sans=127.0.0.1 \<br>                     --kubernetes-version 1.28.6 \<br>                     --image-repository=registry.aliyuncs.com/google_containers \<br>                     --service-cidr=10.96.0.0/16 \<br>                     --pod-network-cidr=10.244.0.0/16 \<br>                     --upload-certs \<br>                     --control-plane-endpoint=10.10.1.21 \<br>                     --cri-socket=unix:///var/run/containerd/containerd.sock<br></code></pre></td></tr></table></figure><p>初始化完成记得初始化<code>kubeconfig</code>和保存<code>join命令</code>用于更多worker或master节点加入集群.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">配置kubeconfig</span><br>mkdir -p $HOME/.kube<br>sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config<br>sudo chown $(id -u):$(id -g) $HOME/.kube/config<br><span class="hljs-meta prompt_"># </span><span class="language-bash">加入worker节点</span><br>kubeadm token create --print-join-command<br><span class="hljs-meta prompt_"># </span><span class="language-bash">加入新的master节点</span><br>kubeadm token create --print-join-command<br><span class="hljs-meta prompt_"># </span><span class="language-bash">在上面获取的命令的基础上,加上--control-plane --certificate-key &lt;certificate-key&gt;,其中&lt;certificate-key&gt;用下面的命令获取</span><br>kubeadm init phase upload-certs --upload-certs<br></code></pre></td></tr></table></figure><h2 id="IPVS"><a href="#IPVS" class="headerlink" title="IPVS"></a>IPVS</h2><p>不可以通过kubeadm的初始化参数来指定使用ipvs,默认情况下使用iptables,但是可以通过集群初始化后修改kube-proxy的配置使用ipvs.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">查看是否已经加载了模块</span><br>lsmod | grep -e ip_vs -e nf_conntrack<br><span class="hljs-meta prompt_"># </span><span class="language-bash">修改配置</span><br>kubectl edit configmap kube-proxy -n kube-system<br>mode: &quot;ipvs&quot;<br><span class="hljs-meta prompt_"># </span><span class="language-bash">重启kube-proxy</span><br>kubectl delete pod -n kube-system -l k8s-app=kube-proxy<br><span class="hljs-meta prompt_"># </span><span class="language-bash">如果集群已经部署了calico,则需要重启calico的pod,calico会自动检测集群使用的是哪种模式的转发</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">检验</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看kube-proxy的配置</span><br>kubectl get configmap kube-proxy -n kube-system -o yaml<br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看kube-proxy的定义</span><br>kubectl get daemonset kube-proxy -n kube-system -o yaml | grep &quot;--proxy-mode&quot;<br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看ipvs转发规则</span><br>ipvsadm -Ln<br></code></pre></td></tr></table></figure><p>该操作会导致k8s集群内的pod<code>短时间断连</code>,生产环境操作的话要注意安全.</p><blockquote><p><strong>iptables：</strong></p><ul><li><strong>转发规则：</strong> iptables 使用 Linux 内核的 netfilter 机制来处理转发决策。它为服务的每一个 endpoint 创建一条链规则。</li><li><strong>优点：</strong><ul><li>简单易用：作为 Kubernetes 默认的转发模式，iptables 模式简单且易于配置。</li><li>兼容性好：iptables 在大多数 Linux 发行版中默认可用，无需额外的配置或模块。</li></ul></li><li><strong>缺点：</strong><ul><li>性能问题：随着规则和 endpoint 数量的增加，iptables 模式可能会导致性能下降，尤其是在规则重新加载时。</li><li>可伸缩性受限：在大规模的集群里，iptables 规则可能会变得异常庞大，影响网络性能和服务发现的响应时间。</li></ul></li></ul><p><strong>IPVS：</strong></p><ul><li><strong>转发规则：</strong> IPVS（基于内核的 IP 虚拟服务器）基于 Linux Virtual Server (LVS) 实现，它使用内核空间的哈希表来存储转发信息，可以更快地处理大量的网络流量。</li><li><strong>优点：</strong><ul><li>高性能：由于其使用内核空间的哈希表，IPVS 模式在处理成千上万的服务时，其性能不会显著降低。</li><li>可伸缩性：对于大型的或流量密集型的集群，IPVS 可提供更好的网络转发性能和更快的服务发现。</li><li>高级负载均衡策略：IPVS 支持更复杂的负载均衡算法，如最小连接数、最短响应时间等。</li></ul></li><li><strong>缺点：</strong><ul><li>配置复杂：与 iptables 相比，IPVS 的设置稍微复杂一些，可能需要额外的配置步骤，如加载内核模块。</li><li>兼容性问题：某些网络插件或环境可能不完全支持 IPVS，或需要额外检查内核模块是否已加载。</li></ul></li></ul></blockquote><h2 id="Calico"><a href="#Calico" class="headerlink" title="Calico"></a>Calico</h2><p><a target="_blank" rel="noopener" href="https://docs.tigera.io/calico/latest/getting-started/kubernetes/self-managed-onprem/onpremises">官方文档</a></p><p>官方提供两种方式的安装(operator和manifest),这里使用manifest.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">wget https://projectcalico.docs.tigera.io/manifests/calico.yaml<br><span class="hljs-meta prompt_"># </span><span class="language-bash">打开下面的配置适配集群的ip range</span><br>- name: CALICO_IPV4POOL_CIDR<br>  value: &quot;10.244.0.0/16&quot;<br>kubectl apply -f calico.yaml<br></code></pre></td></tr></table></figure><h3 id="calico增强功能"><a href="#calico增强功能" class="headerlink" title="calico增强功能"></a>calico增强功能</h3><h4 id="固定ip"><a href="#固定ip" class="headerlink" title="固定ip"></a>固定ip</h4><h5 id="检查k8s每个节点的calico配置文件是否支持"><a href="#检查k8s每个节点的calico配置文件是否支持" class="headerlink" title="检查k8s每个节点的calico配置文件是否支持"></a>检查k8s每个节点的calico配置文件是否支持</h5><p>cat &#x2F;etc&#x2F;cni&#x2F;net.d&#x2F;10-calico.conflist</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-attr">&quot;ipam&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>     <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;calico-ipam&quot;</span><br> <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br></code></pre></td></tr></table></figure><ul><li>看到calico有使用ipam插件,即可使用固定ip功能</li><li>如果没有ipam或者该配置文件不存在,则不能使用</li></ul><h5 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h5><p>在pod.metadata.annotations中添加**”cni.projectcalico.org&#x2F;ipAddrs”: “[&quot;192.168.0.1&quot;]”**即可<br>例如</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">myapp</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">test</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">myapp</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">myapp</span><br>      <span class="hljs-attr">annotations:</span><br>        <span class="hljs-attr">&quot;cni.projectcalico.org/ipAddrs&quot;:</span> <span class="hljs-string">&quot;[\&quot;10.244.36.98\&quot;]&quot;</span><br><span class="hljs-string">......</span><br></code></pre></td></tr></table></figure><p>注意: 虽然ip地址是列表形式,但目前仅支持一个pod一个ip这样配置,所以replica不能大于1</p><h4 id="浮动ip"><a href="#浮动ip" class="headerlink" title="浮动ip"></a>浮动ip</h4><h5 id="修改calico的configmap"><a href="#修改calico的configmap" class="headerlink" title="修改calico的configmap"></a>修改calico的configmap</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl edit cm -n kube-system calico-config<br></code></pre></td></tr></table></figure><h5 id="增加feature-control配置"><a href="#增加feature-control配置" class="headerlink" title="增加feature_control配置"></a>增加feature_control配置</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">cni_network_config:</span> <span class="hljs-string">|-</span><br><span class="hljs-string">    &#123;</span><br><span class="hljs-string">      &quot;name&quot;: &quot;k8s-pod-network&quot;,</span><br><span class="hljs-string">      &quot;cniVersion&quot;: &quot;0.3.0&quot;,</span><br><span class="hljs-string">      &quot;plugins&quot;: [</span><br><span class="hljs-string">        &#123;</span><br><span class="hljs-string">          &quot;type&quot;: &quot;calico&quot;,</span><br><span class="hljs-string">          &quot;log_level&quot;: &quot;info&quot;,</span><br><span class="hljs-string">          &quot;datastore_type&quot;: &quot;kubernetes&quot;,</span><br><span class="hljs-string">          &quot;nodename&quot;: &quot;__KUBERNETES_NODE_NAME__&quot;,</span><br><span class="hljs-string">          &quot;mtu&quot;: __CNI_MTU__,</span><br><span class="hljs-string">          &quot;ipam&quot;: &#123;</span><br><span class="hljs-string">              &quot;type&quot;: &quot;calico-ipam&quot;</span><br><span class="hljs-string">          &#125;,</span><br><span class="hljs-string">          &quot;policy&quot;: &#123;</span><br><span class="hljs-string">              &quot;type&quot;: &quot;k8s&quot;</span><br><span class="hljs-string">          &#125;,</span><br><span class="hljs-string">          &quot;kubernetes&quot;: &#123;</span><br><span class="hljs-string">              &quot;kubeconfig&quot;: &quot;__KUBECONFIG_FILEPATH__&quot;</span><br><span class="hljs-string">          &#125;,</span><br><span class="hljs-string">          # 开启浮动ip功能</span><br><span class="hljs-string">          &quot;feature_control&quot;: &#123;</span><br><span class="hljs-string">              &quot;floating_ips&quot;: true</span><br><span class="hljs-string">          &#125;</span><br><span class="hljs-string">        &#125;,</span><br><span class="hljs-string">        &#123;</span><br><span class="hljs-string">          &quot;type&quot;: &quot;portmap&quot;,</span><br><span class="hljs-string">          &quot;snat&quot;: true,</span><br><span class="hljs-string">          &quot;capabilities&quot;: &#123;&quot;portMappings&quot;: true&#125;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">      ]</span><br><span class="hljs-string">    &#125;</span><br></code></pre></td></tr></table></figure><h5 id="重启所有calico-node"><a href="#重启所有calico-node" class="headerlink" title="重启所有calico-node"></a>重启所有calico-node</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl delete pod -n kube-system calico-node-xxxxx<br></code></pre></td></tr></table></figure><h5 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h5><p>类似固定ip,也是添加annotations</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">annotations:</span><br>  <span class="hljs-attr">&quot;cni.projectcalico.org/floatingIPs&quot;:</span> <span class="hljs-string">&quot;[\&quot;10.244.36.98\&quot;, \&quot;10.244.36.99\&quot;]&quot;</span><br></code></pre></td></tr></table></figure><p>更多请阅<a target="_blank" rel="noopener" href="https://docs.projectcalico.org/networking/use-specific-ip">官方文档</a></p><h2 id="集群验证"><a href="#集群验证" class="headerlink" title="集群验证"></a>集群验证</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl cluster-info<br>kubectl get cs<br></code></pre></td></tr></table></figure><p>部署以下daemonset</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">DaemonSet</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">net-tools</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">net-tools</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">net-tools</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">net-tools</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">tolerations:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">effect:</span> <span class="hljs-string">NoSchedule</span><br>          <span class="hljs-attr">operator:</span> <span class="hljs-string">Exists</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">CriticalAddonsOnly</span><br>          <span class="hljs-attr">operator:</span> <span class="hljs-string">Exists</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">effect:</span> <span class="hljs-string">NoExecute</span><br>          <span class="hljs-attr">operator:</span> <span class="hljs-string">Exists</span><br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">net-tools</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">juestnow/net-tools</span><br>          <span class="hljs-attr">command:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">/bin/sh</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;-c&quot;</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">set</span> <span class="hljs-string">-e</span> <span class="hljs-string">-x;</span> <span class="hljs-string">tail</span> <span class="hljs-string">-f</span> <span class="hljs-string">/dev/null</span><br>          <span class="hljs-attr">resources:</span><br>            <span class="hljs-attr">limits:</span><br>              <span class="hljs-attr">memory:</span> <span class="hljs-string">30Mi</span><br>            <span class="hljs-attr">requests:</span><br>              <span class="hljs-attr">cpu:</span> <span class="hljs-string">50m</span><br>              <span class="hljs-attr">memory:</span> <span class="hljs-string">20Mi</span><br>      <span class="hljs-attr">dnsConfig:</span><br>        <span class="hljs-attr">options:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">single-request-reopen</span><br></code></pre></td></tr></table></figure><p>进入pod并测试网络</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl exec -ti net-tools-8wxnf /bin/sh<br>nc -vz kubernetes 443<br>curl -k https://kubernetes<br></code></pre></td></tr></table></figure><h2 id="metrics-server"><a href="#metrics-server" class="headerlink" title="metrics-server"></a>metrics-server</h2><p>参考<a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/metrics-server/?tab=readme-ov-file">官方github</a></p><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><blockquote><p>metrics-server 会通过kubelet的cAdvisor获取nodes和pods的资源使用情况.然后在apiServer注册对应的metrics-API,通过metrics-API就可以获取对应的资源使用信息.</p><p>主要给HPA和VPA提供实时的资源使用信息.</p></blockquote><blockquote><p><code>metrics-server</code> 默认的 API 地址不直接暴露一个可以通过标准方式访问的HTTP路由。相反，它提供资源利用率数据给 Kubernetes API，这样在 Kubernetes 集群内部就可以通过 Kubernetes API 访问这些数据。</p><p>当 <code>metrics-server</code> 部署并运行在集群上时，它会将收集到的度量指标存储在 Kubernetes API server 中的特定资源类型下。这些资源类型包括 <code>NodeMetrics</code> 和 <code>PodMetrics</code>，它们都在 <code>metrics.k8s.io</code> API组中。</p><p>你可以通过<code>kubectl</code> 命令行工具访问这些度量指标，使用专用的 API 路径，例如：</p><ul><li><p>获取集群所有节点的度量指标：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">kubectl <span class="hljs-built_in">get</span> --raw <span class="hljs-string">&quot;/apis/metrics.k8s.io/v1beta1/nodes&quot;</span><br></code></pre></td></tr></table></figure></li><li><p>获取所有命名空间中的所有POD的度量指标：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">kubectl <span class="hljs-built_in">get</span> --raw <span class="hljs-string">&quot;/apis/metrics.k8s.io/v1beta1/pods&quot;</span><br></code></pre></td></tr></table></figure></li></ul><p>这些命令实际上是使用 Kubernetes API 与 <code>metrics-server</code> 进行交互，而非直接与 <code>metrics-server</code> 对话。要注意的是，这样的请求需要有适当的权限和API server的访问权限。在一些情况下，集群管理员可能需要为你配置特定的访问权限，才能允许你从 API server 检索这些度量数据。</p></blockquote><h3 id="部署-1"><a href="#部署-1" class="headerlink" title="部署"></a>部署</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">单节点</span><br>wget https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml<br><span class="hljs-meta prompt_"># </span><span class="language-bash">HA 部署</span><br>wget https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/high-availability-1.21+.yaml<br><span class="hljs-meta prompt_"># </span><span class="language-bash">修改下镜像源并添加这个启动参数</span><br>- --kubelet-insecure-tls<br></code></pre></td></tr></table></figure><blockquote><p>在默认情况下，Metrics Server 会尝试通过安全的 TLS 连接来和 kubelet 通信。这意味着它需要 kubelet 的 serving 证书是由受信任的 CA 签发的，而且该 CA 证书需要被 Metrics Server 所信任。</p><p>如果不在 Metrics Server 的部署中添加 <code>--kubelet-insecure-tls</code> 参数，那么你必须确保几个条件满足：</p><ol><li><p><strong>Kubelet 证书有效性</strong>：Kubelet 需要具有有效的 TLS 证书，这些证书应该被 Metrics Server 所信任的 CA 签发。</p></li><li><p><strong>正确的证书签名</strong>：这些证书需要为 kubelet 的实际 DNS 名称或 IP 地址签名，这样 Metrics Server 才能通过验证。</p></li><li><p><strong>CA 证书配置</strong>：必须在 Metrics Server 中配置信任的 CA 证书，以便正确地验证 kubelet 的 TLS 证书。</p></li></ol><p>如果你的集群满足上述要求，则不需要添加 <code>--kubelet-insecure-tls</code> 参数，并且能够维持更高的安全性。这是生产环境中推荐的配置方式。</p><p>然而，如果你的集群设置中没有这些证书，或者你处于测试环境并愿意暂时绕过 TLS 验证，那么添加 <code>--kubelet-insecure-tls</code> 参数会使 Metrics Server 直接连接 kubelet 而不验证其 TLS 证书。这在测试或非生产环境中可以简化配置，但在生产环境中这样做会有安全风险。因此在生产环境下，最好还是确保所有的 TLS 证书都正确配置。</p></blockquote><h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl top nodes<br></code></pre></td></tr></table></figure><h2 id="ingess-nginx"><a href="#ingess-nginx" class="headerlink" title="ingess-nginx"></a>ingess-nginx</h2><p>详情可以看看<a target="_blank" rel="noopener" href="https://anthing.cn/2023/05/21/k8s-ingress/">这篇文章</a></p><p>验证可以参考<a target="_blank" rel="noopener" href="https://ealenn.github.io/Echo-Server/pages/quick-start/kubernetes.html">echo-server</a></p><h2 id="helm"><a href="#helm" class="headerlink" title="helm"></a>helm</h2><h3 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h3><p>helm v3后,取消了<code>tiller</code>,helm直接通过<code>kubeconfig</code>连接<code>apiserver</code></p><p><img src="https://cdn.jsdelivr.net/gh/occultagg/blog-pics/hexo-blog/jvupy56cpup3u_ffccfa5368a44b5a98987d2194654cb5.png" srcset="/img/loading.gif" lazyload></p><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><table><thead><tr><th>概念</th><th>描述</th></tr></thead><tbody><tr><td>Chart</td><td>一个helm包,包括了运行一个应用所需要的所有k8s资源,镜像,依赖等定义,类似yum的rpm包</td></tr><tr><td>Repository</td><td>存储helm charts的地方. (harbor可以存储镜像以及charts)</td></tr><tr><td>Release</td><td>比如一个Mysql chart想在集群中运行两个数据库,可以将这个chart安装两次,我们就说集群中运行了这个chart的两个release.每次安装都会生成自己的release名称.</td></tr><tr><td>Value</td><td>Helm Chart的参数，用于配置Kubernetes对象.类似terraform的变量文件</td></tr><tr><td>Template</td><td>使用Go模板语言生成Kubernetes对象的定义文件</td></tr></tbody></table><p><strong><a target="_blank" rel="noopener" href="https://artifacthub.io/">Artifact Hub</a></strong> - 不是传统意义上的 Helm 仓库，但它是一个集中发现和分享 Helm charts 和其他包的地方。</p><p><a target="_blank" rel="noopener" href="https://helm.sh/docs/intro/install/">官方文档</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3<br>sh ./get_helm.sh<br></code></pre></td></tr></table></figure><h3 id="创建chart"><a href="#创建chart" class="headerlink" title="创建chart"></a>创建chart</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">创建一个名为wordpress的chart</span><br>helm create wordpress<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell">wordpress/<br>├── charts # 这个目录用于存放本 Helm chart 依赖的其他 chart。如果你的应用程序依赖于其他服务（如数据库、缓存等），对应的 chart 应该放在这个目录下。默认情况下，此文件夹为空。<br>├── Chart.yaml # 这个文件包含了 chart 的基本信息，如版权、版本、名称和描述。这是 chart 的元数据文件和身份信息<br>├── templates # 这个目录包含定义 Kubernetes 资源的模板文件。Helm 会结合 `values.yaml` 中的值和这些模板来生成 Kubernetes 资源定义文件。<br>│   ├── deployment.yaml # 定义了用于创建和管理应用程序基础 Pod 的 Deployment 资源。<br>│   ├── _helpers.tpl # 包含模板帮助信息和定义模板函数，可以在其他模板文件中重用。<br>│   ├── hpa.yaml # 如果启用，定义 Horizontal Pod Autoscaler，根据 CPU 使用率或其他选择的指标自动缩放 Deployment。<br>│   ├── ingress.yaml # 定义 Ingress 资源，用于管理外部访问到你的应用程序的 HTTP/HTTPS 路由。<br>│   ├── NOTES.txt # 包含安装后的使用说明，当执行 `helm install` 命令后，这些信息会显示给用户。<br>│   ├── serviceaccount.yaml # 创建 ServiceAccount，以便为 pod 提供身份认证。<br>│   ├── service.yaml # 定义 Service 资源，用于定义如何访问和暴露你的应用程序。<br>│   └── tests # 包含测试资源<br>│       └── test-connection.yaml # 定义了一个后置测试，用于验证应用程序是否可以正常连接。<br>└── values.yaml # 包含默认的配置值，这些值在结合 templates/ 中的模板时使用。用户可以自定义这些值来覆盖默认设置。<br></code></pre></td></tr></table></figure><h3 id="Chart-yaml"><a href="#Chart-yaml" class="headerlink" title="Chart.yaml"></a>Chart.yaml</h3><p>定义chart的元数据和依赖,模板如下</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">chart</span> <span class="hljs-string">API</span> <span class="hljs-string">版本</span> <span class="hljs-string">（必需）</span>  <span class="hljs-comment">#必须有</span><br><span class="hljs-attr">name:</span> <span class="hljs-string">chart名称</span> <span class="hljs-string">（必需）</span>     <span class="hljs-comment"># 必须有 </span><br><span class="hljs-attr">version:</span> <span class="hljs-string">语义化2</span> <span class="hljs-string">版本（必需）</span> <span class="hljs-comment"># 必须有</span><br><br><span class="hljs-attr">kubeVersion:</span> <span class="hljs-string">兼容Kubernetes版本的语义化版本（可选）</span><br><span class="hljs-attr">description:</span> <span class="hljs-string">一句话对这个项目的描述（可选）</span><br><span class="hljs-attr">type:</span> <span class="hljs-string">chart类型</span> <span class="hljs-string">（可选）</span><br><span class="hljs-attr">keywords:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">关于项目的一组关键字（可选）</span><br><span class="hljs-attr">home:</span> <span class="hljs-string">项目home页面的URL</span> <span class="hljs-string">（可选）</span><br><span class="hljs-attr">sources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">项目源码的URL列表（可选）</span><br><span class="hljs-attr">dependencies:</span> <span class="hljs-comment"># chart 必要条件列表 （可选）</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">chart名称</span> <span class="hljs-string">(nginx)</span><br>    <span class="hljs-attr">version:</span> <span class="hljs-string">chart版本</span> <span class="hljs-string">(&quot;1.2.3&quot;)</span><br>    <span class="hljs-attr">repository:</span> <span class="hljs-string">（可选）仓库URL</span> <span class="hljs-string">(&quot;https://example.com/charts&quot;)</span> <span class="hljs-string">或别名</span> <span class="hljs-string">(&quot;@repo-name&quot;)</span><br>    <span class="hljs-attr">condition:</span> <span class="hljs-string">（可选）</span> <span class="hljs-string">解析为布尔值的yaml路径，用于启用/禁用chart</span> <span class="hljs-string">(e.g.</span> <span class="hljs-string">subchart1.enabled</span> <span class="hljs-string">)</span><br>    <span class="hljs-attr">tags:</span> <span class="hljs-comment"># （可选）</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">用于一次启用/禁用</span> <span class="hljs-string">一组chart的tag</span><br>    <span class="hljs-attr">import-values:</span> <span class="hljs-comment"># （可选）</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ImportValue</span> <span class="hljs-string">保存源值到导入父键的映射。每项可以是字符串或者一对子/父列表项</span><br>    <span class="hljs-attr">alias:</span> <span class="hljs-string">（可选）</span> <span class="hljs-string">chart中使用的别名。当你要多次添加相同的chart时会很有用</span><br><br><span class="hljs-attr">maintainers:</span> <span class="hljs-comment"># （可选） # 可能用到</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">维护者名字</span> <span class="hljs-string">（每个维护者都需要）</span><br>    <span class="hljs-attr">email:</span> <span class="hljs-string">维护者邮箱</span> <span class="hljs-string">（每个维护者可选）</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">维护者URL</span> <span class="hljs-string">（每个维护者可选）</span><br><br><span class="hljs-attr">icon:</span> <span class="hljs-string">用做icon的SVG或PNG图片URL</span> <span class="hljs-string">（可选）</span><br><span class="hljs-attr">appVersion:</span> <span class="hljs-string">包含的应用版本（可选）。不需要是语义化，建议使用引号</span><br><span class="hljs-attr">deprecated:</span> <span class="hljs-string">不被推荐的chart</span> <span class="hljs-string">（可选，布尔值）</span><br><span class="hljs-attr">annotations:</span><br>  <span class="hljs-attr">example:</span> <span class="hljs-string">按名称输入的批注列表</span> <span class="hljs-string">（可选）.</span><br></code></pre></td></tr></table></figure><p>只有三个是<code>必填的</code>,在本例子中可以这样写</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">nginx-helm</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">version:</span> <span class="hljs-number">1.0</span><span class="hljs-number">.0</span><br></code></pre></td></tr></table></figure><h3 id="values-yaml"><a href="#values-yaml" class="headerlink" title="values.yaml"></a>values.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">image:</span><br>  <span class="hljs-attr">repository:</span> <span class="hljs-string">nginx</span><br>  <span class="hljs-attr">tag:</span> <span class="hljs-string">&#x27;1.19.8&#x27;</span><br></code></pre></td></tr></table></figure><h3 id="templates"><a href="#templates" class="headerlink" title="templates"></a>templates</h3><p>根据具体需求写k8s的资源清单</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 本例子中部署个deployment</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-helm-&#123;&#123;</span> <span class="hljs-string">.Values.image.repository</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-comment"># 通过.Values访问上面定义的&#x27;变量&#x27;</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">nginx-helm</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">nginx-helm</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-helm</span><br>        <span class="hljs-attr">image:</span> &#123;&#123; <span class="hljs-string">.Values.image.repository</span> &#125;&#125;<span class="hljs-string">:&#123;&#123;</span> <span class="hljs-string">.Values.image.tag</span> <span class="hljs-string">|</span> <span class="hljs-string">default</span> <span class="hljs-string">&quot;lastest&quot;</span> <span class="hljs-string">&#125;&#125;</span><br>        <span class="hljs-attr">ports:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span><br>          <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br></code></pre></td></tr></table></figure><h3 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">helm package wordpress/<br></code></pre></td></tr></table></figure><h3 id="发布-拉取-应用-升级本地包"><a href="#发布-拉取-应用-升级本地包" class="headerlink" title="发布&#x2F;拉取&#x2F;应用&#x2F;升级本地包"></a>发布&#x2F;拉取&#x2F;应用&#x2F;升级本地包</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">helm repo add myrepo https://example.com/charts<br><span class="hljs-meta prompt_"># </span><span class="language-bash">发布</span><br>helm push wordpress-0.1.0.tgz myrepo<br><span class="hljs-meta prompt_"># </span><span class="language-bash">拉取,它会下载与一个.tar.gz包到本地</span><br>helm pull myrepo/wordpress --version &lt;version&gt;<br><span class="hljs-meta prompt_"># </span><span class="language-bash">解压后应用本地包</span><br>tar -xvf wordpress-&lt;version&gt;.tgz<br>helm install mywordpress ./wordpress<br>helm upgrade mywordpress ./wordpress<br></code></pre></td></tr></table></figure><h3 id="安装Release"><a href="#安装Release" class="headerlink" title="安装Release"></a>安装Release</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">helm install mywordpress myrepo/wordpress<br></code></pre></td></tr></table></figure><h3 id="更新chart"><a href="#更新chart" class="headerlink" title="更新chart"></a>更新chart</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">在本地编辑Chart配置或添加新的依赖项；</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">使用helm package命令打包新的Chart版本；</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">使用helm push命令将新的Chart版本推送到Repository中；</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">使用helm repo update命令更新本地或远程的Helm Repository；</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">使用helm upgrade命令升级现有Release到新的Chart版本</span><br>helm upgrade mywordpress myrepo/wordpress --version 0.2.0<br></code></pre></td></tr></table></figure><h3 id="管理Release"><a href="#管理Release" class="headerlink" title="管理Release"></a>管理Release</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">查看当前运行的Release列表</span><br>helm ls<br><span class="hljs-meta prompt_"># </span><span class="language-bash">升级mywordpress release的image tag为5.7.3-php8.0-fpm-alpine (热补丁Release), 执行这个命令后release会自动重启应用最新的配置</span><br>helm upgrade mywordpress myrepo/wordpress --set image.tag=5.7.3-php8.0-fpm-alpine<br><span class="hljs-meta prompt_"># </span><span class="language-bash">回滚release</span><br>helm rollback mywordpress 1<br><span class="hljs-meta prompt_"># </span><span class="language-bash">删除</span><br>helm uninstall mywordpress<br><span class="hljs-meta prompt_"># </span><span class="language-bash">删除release相关的PVC</span><br>helm uninstall mywordpress --delete-data<br><span class="hljs-meta prompt_"># </span><span class="language-bash">Helm 客户端不会等到所有资源都运行才退出，可以使用 helm status 来追踪 release 的状态，或是重新读取配置信息</span><br>helm status mywordpress<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash"></span><br><span class="language-bash">NAME: mynginx</span><br>LAST DEPLOYED: Fri Oct 29 14:27:32 2021<br>NAMESPACE: default<br>STATUS: deployed<br>REVISION: 1<br>TEST SUITE: None<br></code></pre></td></tr></table></figure><h1 id="存储"><a href="#存储" class="headerlink" title="存储"></a>存储</h1><p>k8s集群支持多种类型的共享存储,将共享存储作为存储类(storage class)资源创建后,再根据实际需求创建PVC,集群就会自动创建对应的pv给pod使用.<code>ceph</code>是主流的共享存储方案,但是ceph十分重,需要额外为它部署运维一个单独的集群.有没有适合中小型集群,原生适配k8s容器环境,轻量灵活,性能好,具备高可用易运维的存储选择呢?</p><h2 id="OpenEbs"><a href="#OpenEbs" class="headerlink" title="OpenEbs"></a>OpenEbs</h2><p>参考:</p><p><a target="_blank" rel="noopener" href="https://weiliang-ms.github.io/wl-awesome/2.%E5%AE%B9%E5%99%A8/k8s/storage/OpenEBS.html#openebs">OpenEBS工作笔记</a></p><p><a target="_blank" rel="noopener" href="https://openebs.io/docs/">官方文档</a></p><h3 id="vs-Ceph"><a href="#vs-Ceph" class="headerlink" title="vs Ceph"></a>vs Ceph</h3><table><thead><tr><th></th><th>OpenEBS</th><th>Ceph</th></tr></thead><tbody><tr><td>性能</td><td>适合中小型规模</td><td>适合大型规模,适用于有高吞吐和横向扩展的需求场景</td></tr><tr><td>特性与功能</td><td>提供灵活易用的存储解决方案,比如动态卷,快照以及针对不同场景设计的存储引擎</td><td>提供大而全的功能,包括块存储,文件系统和对象存储,提供高级特性,比如自我修复和数据重复消除.</td></tr><tr><td>可靠性和冗余</td><td>多副本+快照</td><td>ceph以弹性和高可靠性闻名</td></tr><tr><td>扩展性和灵活</td><td>易与水平扩展</td><td>无限扩展,可以容纳非常大规模(PB级别)的存储集群</td></tr><tr><td>社区与生态</td><td>云原生计算基金会(CNCF)沙箱项目,项目较新</td><td>经过长时间实践验证的项目,拥有庞大且活跃的社区</td></tr></tbody></table><h3 id="安装部署"><a href="#安装部署" class="headerlink" title="安装部署"></a>安装部署</h3><p>openebs依赖<code>iSCSI</code>服务,集群每个节点都要安装并启动</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum install iscsi-initiator-utils -y<br>systemctl enable --now iscsid <br></code></pre></td></tr></table></figure><p>使用helm部署</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">可以直接安装</span><br>helm install openebs --namespace openebs openebs/openebs --create-namespace<br><span class="hljs-meta prompt_"># </span><span class="language-bash">最好还是pull下来再安装</span><br>helm repo add openebs https://openebs.github.io/charts<br>helm repo update<br>helm pull openebs/openebs<br>tar -xvf openebs.xxx.tgz<br>helm install openebs ./openebs --namespace openebs --create-namespace<br><span class="hljs-meta prompt_"># </span><span class="language-bash">pod都running了即部署完成</span><br>kubectl get pods -n openebs<br></code></pre></td></tr></table></figure><p>会创建以下资源</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@k8s-master-1 yaml]# kubectl get all -n openebs<br>NAME                                               READY   STATUS    RESTARTS   AGE<br>pod/openebs-localpv-provisioner-56d6489bbc-b5c4p   1/1     Running   0          11m<br>pod/openebs-ndm-hxp2s                              1/1     Running   0          11m<br>pod/openebs-ndm-jl2gr                              1/1     Running   0          11m<br>pod/openebs-ndm-operator-5d7944c94d-9rm9b          1/1     Running   0          11m<br><br>NAME                         DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE<br>daemonset.apps/openebs-ndm   2         2         2       2            2           &lt;none&gt;          11m<br><br>NAME                                          READY   UP-TO-DATE   AVAILABLE   AGE<br>deployment.apps/openebs-localpv-provisioner   1/1     1            1           11m<br>deployment.apps/openebs-ndm-operator          1/1     1            1           11m<br><br>NAME                                                     DESIRED   CURRENT   READY   AGE<br>replicaset.apps/openebs-localpv-provisioner-56d6489bbc   1         1         1       11m<br>replicaset.apps/openebs-ndm-operator-5d7944c94d          1         1         1       11m<br><br>[root@k8s-master-1 yaml]# kubectl get sc<br>NAME               PROVISIONER        RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE<br>openebs-device     openebs.io/local   Delete          WaitForFirstConsumer   false                  13m<br>openebs-hostpath   openebs.io/local   Delete          WaitForFirstConsumer   false                  13m<br></code></pre></td></tr></table></figure><blockquote><ol><li><p><strong>pod&#x2F;openebs-localpv-provisioner-</strong>:<br>这个Pod是Local PV Provisioner，它用于动态地为基于本地存储的PersistentVolume (PV) 分配PersistentVolumeClaims (PVC)。它监听PVC的创建和删除请求，并为它们分配和回收PV资源。</p></li><li><p><strong>pod&#x2F;openebs-ndm-</strong>*:<br>这些是Node Device Manager (NDM)的Pod。NDM是一个Kubernetes DaemonSet，它运行在集群的每个节点上。它的作用是发现节点上的块存储设备并报告它们的状态，这样就可以用来创建OpenEBS卷。</p></li><li><p><strong>pod&#x2F;openebs-ndm-operator-</strong>:<br>NDM operator是负责管理NDM DaemonSet的一个组件。它处理节点上的块设备的发现和管理，并且维护与这些设备相关的资源如BlockDevice。</p></li><li><p><strong>daemonset.apps&#x2F;openebs-ndm</strong>:<br>这是NDM的DaemonSet，它确保NDM Pod在集群中的每个节点上都有一个运行实例。</p></li><li><p><strong>deployment.apps&#x2F;openebs-localpv-provisioner</strong>:<br>这是Local PV Provisioner的Deployment，确保提供一个稳定的运行环境和必要的副本数量。</p></li><li><p><strong>deployment.apps&#x2F;openebs-ndm-operator</strong>:<br>这是NDM Operator的Deployment，负责部署和管理NDM Operator。</p></li><li><p><strong>storageclass (sc)</strong>:</p><ul><li><strong>openebs-device</strong>: 这个StorageClass用于提供基于设备（如磁盘分区或整个磁盘）的本地PV。</li><li><strong>openebs-hostpath</strong>: 这个StorageClass用于提供基于宿主机路径的本地PV。与基于设备的PV不同，它使用节点上的文件系统路径来提供存储。</li></ul></li></ol><ul><li><code>RECLAIMPOLICY</code>的值<code>Delete</code>表示当一个PV被释放时，与之关联的物理存储将被清空。</li><li><code>VOLUMEBINDINGMODE</code>的值<code>WaitForFirstConsumer</code>意味着PV的创建和绑定将延迟到PVC被Pod引用之后。</li><li><code>ALLOWVOLUMEEXPANSION</code>的值<code>false</code>表示PVC在创建后无法动态扩容。</li></ul></blockquote><h2 id="存储引擎"><a href="#存储引擎" class="headerlink" title="存储引擎"></a>存储引擎</h2><p>OpenEBS提供多种多样的存储引擎去适配不同的使用场景,<code>不同的存储引擎对应一个或多个存储类</code>,在k8s中通过存储类定义使用.</p><table><thead><tr><th align="center">应用需求</th><th align="center">存储类型</th><th align="center">OpenEBS卷类型</th></tr></thead><tbody><tr><td align="center">低时延、高可用性、同步复制、快照、克隆、精简配置</td><td align="center">SSD&#x2F;云存储卷</td><td align="center">OpenEBS Mayastor</td></tr><tr><td align="center">高可用性、同步复制、快照、克隆、精简配置</td><td align="center">机械&#x2F;SSD&#x2F;云存储卷</td><td align="center">OpenEBS cStor</td></tr><tr><td align="center">高可用性、同步复制、精简配置</td><td align="center">主机路径或外部挂载存储</td><td align="center">OpenEBS Jiva</td></tr><tr><td align="center">低时延、本地PV</td><td align="center">主机路径或外部挂载存储</td><td align="center">Dynamic Local PV - Hostpath, Dynamic Local PV - Rawfile</td></tr><tr><td align="center">低时延、本地PV</td><td align="center">本地机械&#x2F;SSD&#x2F;云存储卷等块设备</td><td align="center">Dynamic Local PV - Device</td></tr><tr><td align="center">低延迟，本地PV，快照，克隆</td><td align="center">本地机械&#x2F;SSD&#x2F;云存储卷等块设备</td><td align="center">OpenEBS Dynamic Local PV - ZFS , OpenEBS Dynamic Local PV - LVM</td></tr></tbody></table><p>每种存储类的配置可能会有所不同，例如，你可能需要为存储类指定路径、节点亲和性规则、大小限制等参数。当创建 PersistentVolumeClaim (PVC) 时，将根据指定的存储类参数来动态创建符合请求的 PersistentVolume (PV)。</p><p>存储类和存储引擎的绑定主要是通过存储类中特定字段来指定,例如:</p><blockquote><p>openebs.io&#x2F;cas-type: local</p><p>openebs.io&#x2F;cas-type: jiva</p><p>openebs.io&#x2F;cas-type: cstor</p></blockquote><h3 id="LocalPV"><a href="#LocalPV" class="headerlink" title="LocalPV"></a>LocalPV</h3><blockquote><p>一个高性能的解决方案,提供本地存储设备(磁盘,目录或分区)的直接访问,相比网络存储,有更高的吞吐和更低的延迟</p></blockquote><ul><li>openebs-hostpath类</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 创建存储类,默认自动创建</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">storage.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">StorageClass</span><br><span class="hljs-attr">metadata:</span><br>     <span class="hljs-attr">name:</span> <span class="hljs-string">openebs-hostpath</span><br>   <span class="hljs-attr">provisioner:</span> <span class="hljs-string">openebs.io/local</span><br>   <span class="hljs-attr">volumeBindingMode:</span> <span class="hljs-string">WaitForFirstConsumer</span><br>   <span class="hljs-attr">reclaimPolicy:</span> <span class="hljs-string">Delete</span><br>   <span class="hljs-attr">parameters:</span><br>     <span class="hljs-attr">hostpath:</span> <span class="hljs-string">&quot;/var/openebs/local/&quot;</span><br>     <span class="hljs-attr">nodeAffinityLabel:</span> <span class="hljs-string">&quot;kubernetes.io/hostname&quot;</span><br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 创建pvc并使用</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolumeClaim</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">my-local-pv</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">storageClassName:</span> <span class="hljs-string">openebs-hostpath</span><br>  <span class="hljs-attr">accessModes:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteOnce</span><br>  <span class="hljs-attr">resources:</span><br>    <span class="hljs-attr">requests:</span><br>      <span class="hljs-attr">storage:</span> <span class="hljs-string">5Gi</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">mypod</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">mycontainer</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">volumeMounts:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">&quot;/var/www/html&quot;</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">storage</span><br>  <span class="hljs-attr">volumes:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">storage</span><br>    <span class="hljs-attr">persistentVolumeClaim:</span><br>      <span class="hljs-attr">claimName:</span> <span class="hljs-string">my-local-pv</span><br></code></pre></td></tr></table></figure><p>你会发现pv会自动创建,并且使用了openebs-hostpath类定义的路径来挂载存储卷,到容器里面往挂载目录随意放点文件,你会发现文件就放在pod运行的node的对应本地路径.</p><ul><li><p>openebs-device类</p><p>该存储类可以自动发现节点上的空闲裸设备(比如没有格式化的硬盘)</p></li><li><p>openebs local pv-zfs类</p><p>如果节点上安装了ZFS,并希望利用ZFS的优势(快照,复制等)可以使用ZFS作为底层文件系统</p></li></ul><h3 id="cStor"><a href="#cStor" class="headerlink" title="cStor"></a>cStor</h3><blockquote><p>基于容器的存储解决方案,提供快照,克隆,复制等高级功能.数据存储在cStor池中,由cStor Volums提供PVs供pod使用.具备高可用性和数据保持性.</p></blockquote><p>部署</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">修改镜像地址使用国内代理</span><br>sed -i s&#x27;+registry.k8s.io+k8s.dockerproxy.com+&#x27; openebs/charts/cstor/values.yaml<br><span class="hljs-meta prompt_"># </span><span class="language-bash">升级helm release</span><br>helm upgrade openebs ./openebs --set cstor.enabled=true --reuse-values --namespace openebs<br><span class="hljs-meta prompt_"># </span><span class="language-bash">部署成功</span><br>[root@k8s-master-1 cstor]# kubectl get pods -n openebs<br>NAME                                             READY   STATUS    RESTARTS   AGE<br>openebs-cstor-admission-server-bbbd5c54f-s2tdj   1/1     Running   0          7m46s<br>openebs-cstor-csi-controller-0                   6/6     Running   0          7m45s<br>openebs-cstor-csi-node-bbpwr                     2/2     Running   0          7m46s<br>openebs-cstor-csi-node-r7mlj                     2/2     Running   0          7m46s<br>openebs-cstor-cspc-operator-799f9b45d4-lctnv     1/1     Running   0          7m46s<br>openebs-cstor-cvc-operator-687bbb7d8f-lsdvh      1/1     Running   0          7m46s<br>...<br></code></pre></td></tr></table></figure><blockquote><ol><li><p><strong>openebs-cstor-admission-server</strong><br>这个 Pod 运行了一个 admission webhook 服务器，它负责接收并处理 Kubernetes 的 admission webhook 请求。当你创建或更新关于 cStor 的资源时，它会确保请求遵守预设的规则。</p></li><li><p><strong>openebs-cstor-csi-controller</strong><br>CSI (容器存储接口) controller 服务负责协调和管理存储卷的生命周期，包括 Provisioning（提供）、Attaching（附加）、Detaching（分离）以及 Snapshotting（快照）等操作。这个 Pod 有 6 个容器，每一个都运行特定的服务，例如驱动注册、控制器服务等。</p></li><li><p><strong>openebs-cstor-csi-node</strong><br>这些 Pod 运行在群集的每个节点上，它们实现了 CSI node 服务，使得节点能够在本地挂载和卸载存储卷。每个 pod 有 2 个容器，通常一个是 node-driver-registrar 用于管理节点上的 CSI 驱动注册，另一个是 cstor-csi-plugin 用于管理 cStor 特有的卷操作。</p></li><li><p><strong>openebs-cstor-cspc-operator</strong><br>CSPC (CStorPoolCluster) Operator 监控和管理 cStor 池集群的生命周期。简单来说，它用来自动配置和管理存储池集群的那些由硬盘构成的资源。</p></li><li><p><strong>openebs-cstor-cvc-operator</strong><br>CVC (CStorVolumeConfig) Operator 负责管理 cStor 卷配置的生命周期，包括卷的创建、扩容、快照以及其他相关操作。它确保了持久卷的动态供给与管理。</p></li></ol></blockquote><p>节点上空闲的裸设备会被自动识别添加为blockdevice资源,并自动创建对应的bdc资源</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl get bd -n openebs<br>kubectl get bdc -n openebs<br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 创建存储池cspc</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">cstor.openebs.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">CStorPoolCluster</span><br><span class="hljs-attr">metadata:</span><br> <span class="hljs-attr">name:</span> <span class="hljs-string">cstor-disk-pool</span><br> <span class="hljs-attr">namespace:</span> <span class="hljs-string">openebs</span><br><span class="hljs-attr">spec:</span><br> <span class="hljs-attr">pools:</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-attr">nodeSelector:</span><br>       <span class="hljs-attr">kubernetes.io/hostname:</span> <span class="hljs-string">&quot;k8s-worker-1&quot;</span> <span class="hljs-comment"># kubectl get nodes --show-labels (kubernetes.io/hostname)</span><br>     <span class="hljs-attr">dataRaidGroups:</span><br>       <span class="hljs-bullet">-</span> <span class="hljs-attr">blockDevices:</span><br>           <span class="hljs-bullet">-</span> <span class="hljs-attr">blockDeviceName:</span> <span class="hljs-string">&quot;blockdevice-5aeaf5f89794edf391f4394a6f7eb47e&quot;</span> <span class="hljs-comment"># 填写对应的bd</span><br>     <span class="hljs-attr">poolConfig:</span><br>       <span class="hljs-attr">dataRaidGroupType:</span> <span class="hljs-string">&quot;stripe&quot;</span><br><br>   <span class="hljs-bullet">-</span> <span class="hljs-attr">nodeSelector:</span><br>       <span class="hljs-attr">kubernetes.io/hostname:</span> <span class="hljs-string">&quot;k8s-worker-2&quot;</span><br>     <span class="hljs-attr">dataRaidGroups:</span><br>       <span class="hljs-bullet">-</span> <span class="hljs-attr">blockDevices:</span><br>           <span class="hljs-bullet">-</span> <span class="hljs-attr">blockDeviceName:</span> <span class="hljs-string">&quot;blockdevice-4dad35da68321cd86eeeb9a085ed0f83&quot;</span><br>     <span class="hljs-attr">poolConfig:</span><br>       <span class="hljs-attr">dataRaidGroupType:</span> <span class="hljs-string">&quot;stripe&quot;</span><br><br><span class="hljs-comment"># 创建cstor存储类</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">StorageClass</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">storage.k8s.io/v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">cstor-csi-disk</span><br><span class="hljs-attr">provisioner:</span> <span class="hljs-string">cstor.csi.openebs.io</span><br><span class="hljs-attr">allowVolumeExpansion:</span> <span class="hljs-literal">true</span><br><span class="hljs-attr">parameters:</span><br>  <span class="hljs-attr">cas-type:</span> <span class="hljs-string">cstor</span><br>  <span class="hljs-comment"># cstorPoolCluster should have the name of the CSPC</span><br>  <span class="hljs-attr">cstorPoolCluster:</span> <span class="hljs-string">cstor-disk-pool</span><br>  <span class="hljs-comment"># replicaCount should be &lt;= no. of CSPI created in the selected CSPC</span><br>  <span class="hljs-attr">replicaCount:</span> <span class="hljs-string">&quot;2&quot;</span><br></code></pre></td></tr></table></figure><p>按平时使用存储卷一样写PVC和POD即可使用存储资源</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">example</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">clusterIP:</span> <span class="hljs-string">None</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">example</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">80</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">StatefulSet</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">example-statefulset</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">example</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">serviceName:</span> <span class="hljs-string">&quot;example&quot;</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">example</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">example</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">example-container</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:latest</span><br>        <span class="hljs-attr">ports:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">web</span><br>        <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">data</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/var/lib/www/html</span><br><br>  <span class="hljs-attr">volumeClaimTemplates:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">data</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">accessModes:</span> [ <span class="hljs-string">&quot;ReadWriteOnce&quot;</span> ]<br>      <span class="hljs-attr">storageClassName:</span> <span class="hljs-string">&quot;cstor-csi-disk&quot;</span><br>      <span class="hljs-attr">resources:</span><br>        <span class="hljs-attr">requests:</span><br>          <span class="hljs-attr">storage:</span> <span class="hljs-string">1Gi</span><br></code></pre></td></tr></table></figure><h2 id="试用总结"><a href="#试用总结" class="headerlink" title="试用总结"></a>试用总结</h2><p>使用path类型的localPV还是比较简单方便地,但是我在试用裸设备的localPV时候却遇到了pv建立失败的问题,不知道是不是虚拟机的原因.而cStor使用起来也比较麻烦,因为它涉及的中间组件(CRD)有点多,没创建一个新的pvc它都要创建对应的pod去管理,使得创建删除的过程有点慢,也容易出问题.</p><h1 id="集群高可用负载均衡方案"><a href="#集群高可用负载均衡方案" class="headerlink" title="集群高可用负载均衡方案"></a>集群高可用负载均衡方案</h1><p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubeadm/blob/main/docs/ha-considerations.md#kube-vip">参考文档</a></p><blockquote><p><strong>kube-vip + HAProxy</strong></p><p>优点：</p><ol><li>kube-vip 是 Kubernetes 原生的解决方案，专为 Kubernetes 设计，易于与 Kubernetes 集群集成。</li><li>kube-vip 可以提供控制平面和服务的高可用性地址。</li><li>它具有负载均衡(不完整)和虚拟IP管理的双重功能，简化了配置。</li></ol><p>缺点：</p><ol><li>kube-vip 相对较新，社区支持和成熟度可能不如使用了更长时间的 keepalived。</li><li>对于一些用户来说，kube-vip 可能需要更多的学习和调试时间。</li></ol><hr><p><strong>keepalived + HAProxy</strong></p><p>优点：</p><ol><li>keepalived 是一种成熟的解决方案，已经被广泛使用和测试，具有稳定的社区支持。</li><li>它使用 VRRP 协议来实现高可用性，自动故障转移。</li><li>keepalived 和 HAProxy 的组合允许高度定制和灵活配置。</li></ol><p>缺点：</p><ol><li>配置相对复杂，需要对 keepalived 和 HAProxy 有较深理解。</li><li>不如 kube-vip 原生集成到 Kubernetes，可能需要更多的外部依赖和脚本来管理。</li></ol></blockquote></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/" class="category-chain-item">技术笔记</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/k8s/" class="print-no-link">#k8s</a></div></div><div class="license-box my-3"><div class="license-title"><div>k8s-部署</div><div>http://example.com/2024/02/15/k8s-deploy/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>Peter Pan</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2024年2月15日</div></div><div class="license-meta-item"><div>许可协议</div><div><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2024/02/15/k8s-ops/" title="k8s-运维"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">k8s-运维</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2024/02/03/kafka-must-know/" title="kakfa-必知必会"><span class="hidden-mobile">kakfa-必知必会</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">总访问量 <span id="busuanzi_value_site_pv"></span> 次 </span><span id="busuanzi_container_site_uv" style="display:none">总访客数 <span id="busuanzi_value_site_uv"></span> 人</span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>