<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="https://cdn.jsdelivr.net/gh/occultagg/blog-pics/hexo-blog/202206120024516.ico"><link rel="icon" href="https://cdn.jsdelivr.net/gh/occultagg/blog-pics/hexo-blog/202206120024516.ico"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#2f4154"><meta name="author" content="Peter Pan"><meta name="keywords" content=""><meta name="description" content="重要组件控制平面: apiserver: 集群的API入口,所有内部通信都通过apiserver,集群控制面前端. etcd: 分布式键值存储,存储集群配置,状态等数据,是整个集群的最终数据源. scheduler: 负责调度决策,分配pod到相应的node上. controller manager: 负责管理控制器(deployment,daemonset,stateful等等). 工作平面:"><meta property="og:type" content="article"><meta property="og:title" content="k8s-理论"><meta property="og:url" content="http://example.com/2024/02/20/k8s-theory/index.html"><meta property="og:site_name" content="Any &amp; Nothing"><meta property="og:description" content="重要组件控制平面: apiserver: 集群的API入口,所有内部通信都通过apiserver,集群控制面前端. etcd: 分布式键值存储,存储集群配置,状态等数据,是整个集群的最终数据源. scheduler: 负责调度决策,分配pod到相应的node上. controller manager: 负责管理控制器(deployment,daemonset,stateful等等). 工作平面:"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/occultagg/blog-pics/hexo-blog/202303200905760.png"><meta property="article:published_time" content="2024-02-20T08:51:40.000Z"><meta property="article:modified_time" content="2024-12-11T09:52:23.057Z"><meta property="article:author" content="Peter Pan"><meta property="article:tag" content="k8s"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/occultagg/blog-pics/hexo-blog/202303200905760.png"><meta name="referrer" content="no-referrer-when-downgrade"><title>k8s-理论 - Any &amp; Nothing</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"example.com",root:"/",version:"1.9.7",typing:{enable:!0,typeSpeed:70,cursorChar:"|",loop:!1,scope:["home"]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!0,offset_factor:2},web_analytics:{enable:!0,follow_dnt:!0,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml",include_content_in_search:!0};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Any & Nothing" type="application/atom+xml">
</head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Any &amp; Nothing</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/" target="_self"><i class="iconfont icon-home-fill"></i> <span>首页</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/" target="_self"><i class="iconfont icon-archive-fill"></i> <span>归档</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/" target="_self"><i class="iconfont icon-category-fill"></i> <span>分类</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/" target="_self"><i class="iconfont icon-tags-fill"></i> <span>标签</span></a></li><li class="nav-item"><a class="nav-link" href="/about/" target="_self"><i class="iconfont icon-user-fill"></i> <span>关于</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle">k8s-理论</span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2024-02-20 16:51" pubdate>2024年2月20日 下午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 2.4k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 21 分钟</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 id="seo-header">k8s-理论</h1><div class="markdown-body"><h1 id="重要组件"><a href="#重要组件" class="headerlink" title="重要组件"></a>重要组件</h1><p>控制平面:</p><p><code>apiserver</code>: 集群的API入口,所有内部通信都通过apiserver,集群控制面前端.</p><p><code>etcd</code>: 分布式键值存储,存储集群配置,状态等数据,是整个集群的最终数据源.</p><p><code>scheduler</code>: 负责调度决策,分配pod到相应的node上.</p><p><code>controller manager</code>: 负责管理控制器(deployment,daemonset,stateful等等).</p><p>工作平面:</p><p><code>kubelet</code>: 在每个节点上,负责管理节点上pod的生命周期</p><p><code>kube-proxy</code>: 节点网络代理,ipvs&#x2F;iptables规则(service)就是它来维护.</p><p><code>core-dns</code>: 集群内的DNS.</p><p>第三方但必须:</p><p><code>CNI</code>: 如calico,负责pod之间的通讯,以及集群内的网络策略(NetworkPolicy)实现.</p><h1 id="重要资源"><a href="#重要资源" class="headerlink" title="重要资源"></a>重要资源</h1><p>k8s里面一切皆资源(resources).</p><p><code>service</code>: 本质上是iptables&#x2F;ipvs转发规则,负责对外暴露服务.</p><p><code>Pod</code>: k8s基本部署单元,包括网络,存储以及如何运行怎么运行容器的规定.</p><p><code>namespace</code>: k8s集群的逻辑隔离分组.</p><p><code>volume</code>: 卷,提供持久化存储能力和共享存储机制.</p><p><code>configmap</code>: 存储配置文件.</p><p><code>secret</code>: 存储机密数据(默认使用base64加密).</p><p><code>控制器</code>: 控制pod的生命周期,不同类型有不同的定义.</p><p>​	<code>deployment</code>: pod的副本及更新管理.</p><p>​	<code>replicaSet</code>: 保证任何时候都有指定数量的pod副本.</p><p>​	<code>StatefulSet</code>: 为有状态应用设计,提供稳定的,唯一的网络标识符,以及稳定的持久化存储和部署顺序保证.</p><p>​	<code>DaemonSet</code>: 确保所有(或特定)节点上都运行一个pod副本.</p><p><code>job和CronJob</code>: 用于处理一次性任务和定时任务.</p><p><code>PV和PVC</code>: PV对应实际的物理存储资源,PVC是用户对存储资源的请求.集群会根据PVC自动创建PV.</p><p><code>ingress</code>: 管理外部对集群内部服务的访问,提供http和https路由规则.(有ingress-controller提供).</p><p><code>ResourceQuota</code>: 限制namespace层面的资源.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ResourceQuota</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">example-quota</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">example-namespace</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">hard:</span><br>    <span class="hljs-attr">pods:</span> <span class="hljs-string">&quot;10&quot;</span>  <span class="hljs-comment"># 最大 Pod 数量</span><br>    <span class="hljs-attr">requests.cpu:</span> <span class="hljs-string">&quot;1&quot;</span>  <span class="hljs-comment"># Pod 请求的最大 CPU 总量</span><br>    <span class="hljs-attr">requests.memory:</span> <span class="hljs-string">1Gi</span>  <span class="hljs-comment"># Pod 请求的最大内存总量</span><br>    <span class="hljs-attr">limits.cpu:</span> <span class="hljs-string">&quot;2&quot;</span>  <span class="hljs-comment"># Pod 限制的最大 CPU 总量</span><br>    <span class="hljs-attr">limits.memory:</span> <span class="hljs-string">2Gi</span>  <span class="hljs-comment"># Pod 限制的最大内存总量</span><br></code></pre></td></tr></table></figure><p><code>LimitRange</code>: 限制pod或container层面上的资源大小.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">LimitRange</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">example-limitrange</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">example-namespace</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">limits:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">type:</span> <span class="hljs-string">Pod</span><br>    <span class="hljs-attr">min:</span><br>      <span class="hljs-attr">cpu:</span> <span class="hljs-string">&quot;100m&quot;</span>  <span class="hljs-comment"># 每个 Pod 的最小 CPU 请求量</span><br>      <span class="hljs-attr">memory:</span> <span class="hljs-string">&quot;100Mi&quot;</span>  <span class="hljs-comment"># 每个 Pod 的最小内存请求量</span><br>    <span class="hljs-attr">max:</span><br>      <span class="hljs-attr">cpu:</span> <span class="hljs-string">&quot;500m&quot;</span>  <span class="hljs-comment"># 每个 Pod 的最大 CPU 请求量</span><br>      <span class="hljs-attr">memory:</span> <span class="hljs-string">&quot;500Mi&quot;</span>  <span class="hljs-comment"># 每个 Pod 的最大内存请求量</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">type:</span> <span class="hljs-string">Container</span><br>    <span class="hljs-attr">default:</span><br>      <span class="hljs-attr">cpu:</span> <span class="hljs-string">&quot;200m&quot;</span>  <span class="hljs-comment"># 没有指定资源请求的容器的默认 CPU 请求量</span><br>      <span class="hljs-attr">memory:</span> <span class="hljs-string">&quot;200Mi&quot;</span>  <span class="hljs-comment"># 没有指定资源请求的容器的默认内存请求量</span><br>    <span class="hljs-attr">defaultRequest:</span><br>      <span class="hljs-attr">cpu:</span> <span class="hljs-string">&quot;150m&quot;</span>  <span class="hljs-comment"># 没有指定资源请求的容器的默认 CPU 限制量</span><br>      <span class="hljs-attr">memory:</span> <span class="hljs-string">&quot;150Mi&quot;</span>  <span class="hljs-comment"># 没有指定资源请求的容器的默认内存限制量</span><br>    <span class="hljs-attr">max:</span><br>      <span class="hljs-attr">cpu:</span> <span class="hljs-string">&quot;300m&quot;</span>  <span class="hljs-comment"># 每个容器的最大 CPU 限制量</span><br>      <span class="hljs-attr">memory:</span> <span class="hljs-string">&quot;300Mi&quot;</span>  <span class="hljs-comment"># 每个容器的最大内存限制量</span><br></code></pre></td></tr></table></figure><h1 id="RBAC"><a href="#RBAC" class="headerlink" title="RBAC"></a>RBAC</h1><p>是k8s的访问控制机制,有以下四种资源组成:</p><ul><li><code>serviceaccount</code>: sa,可以理解为就是一个用户名,命名空间级资源.</li><li><code>role</code>: 角色,权限赋予给role, 命名空间级资源</li><li><code>clusterrole</code>: 与role一样,但是是集群级的资源</li><li><code>rolebinding/clusterrolebinding</code>: 负责将sa和role&#x2F;clusterrole关联起来</li></ul><h1 id="Addition"><a href="#Addition" class="headerlink" title="Addition"></a>Addition</h1><h2 id="init-pod"><a href="#init-pod" class="headerlink" title="init-pod"></a>init-pod</h2><p>在pod中定义一个先于其他容器启动的小容器,用于在主容器启动前完成一些必要的初始化配置.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">myapp-pod</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">myapp-container</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">myapp</span><br>  <span class="hljs-attr">initContainers:</span> <span class="hljs-comment"># 定义一个init-pod,检查myservice ready,ready后init-pod会退出,然后再启动myapp-container</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">init-myservice</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">busybox</span><br>    <span class="hljs-attr">command:</span> [<span class="hljs-string">&#x27;sh&#x27;</span>, <span class="hljs-string">&#x27;-c&#x27;</span>, <span class="hljs-string">&#x27;until nslookup myservice; do echo waiting for myservice; sleep 2; done;&#x27;</span>]<br></code></pre></td></tr></table></figure><p>常见场景:</p><ul><li>启动时进行数据库或缓存的初始化</li><li>下载配置信息</li><li>检查依赖关系</li><li>创建数据卷</li><li>网络初始化</li></ul><h2 id="Pause"><a href="#Pause" class="headerlink" title="Pause"></a>Pause</h2><p>是一个<code>隐蔽但重要</code>的容器,1.19前称为kube-pause,1.19后被合并进kubelet,并改名为PodSandbox.</p><p>负责保持并管理容器的命名空间(这里指的LXC的内核的命名空间),它负责初始化并保持命名空间(比如网络和PID),这样子其他容器就可以在相同的pod中共享这些命名空间.</p><blockquote><ol><li><p><strong>命名空间锚点</strong>：Pause容器创建了网络和PID两个重要的命名空间。这些命名空间为Pod内所有的容器提供了共享的环境和上下文。其它容器在初始化时会加入到Pause容器创建的命名空间中，并在这些共享的空间内运行。</p></li><li><p><strong>Pod级别的生命周期管理</strong>：由于Pause容器是Pod启动时最先创建的容器，其生命周期与Pod一致。即使Pod内的业务容器被重启或崩溃后重启，Pause容器仍然在运行，这样保证了Pod的网络和PID命名空间在容器重启过程中是持久且稳定的。</p></li><li><p><strong>资源共享</strong>：Pause容器为Pod内的其他容器挂载点提供共享的资源，比如卷挂载。这意味着即使业务容器出现重启，共享资源仍然可用，从而保证了容器间资源的持续连贯性。</p></li><li><p><strong>处理僵尸进程</strong>：在Linux中，一个僵尸进程是已经完成但其父进程尚未对其进行回收的进程。Pause容器作为Pod内所有容器的共同父进程，有助于回收这些僵尸进程，从而避免资源泄漏。</p></li><li><p><strong>防止孤立</strong>：如果没有Pause容器，且Pod内的所有业务容器都停止运行了，那么Pod的网络命名空间和PID命名空间可能会失去，这将导致任何重启的容器进入一个全新的环境。Pause容器的存在，使得Pod在其生命周期内始终保持一个稳定的运行环境。</p></li></ol></blockquote><h1 id="安全"><a href="#安全" class="headerlink" title="安全"></a>安全</h1><h2 id="Secret的安全性"><a href="#Secret的安全性" class="headerlink" title="Secret的安全性"></a>Secret的安全性</h2><p>Secret是用来存储敏感数据的资源,本质上<code>一种特殊的卷</code>,但是默认情况下,secret只是将数据做了base64加密,假如数据被截获,敏感数据依旧可以轻松被获取.因此针对secret有一些额外的安全补充手段:</p><ol><li>通过<code>RBAC</code>和<code>网络策略</code>对secret进行访问控制</li><li><code>定期轮换</code>secret</li><li>secret可以存放在<code>第三方密钥管理工具</code>,比如AWS 的secret manager等,如果存放在etcd,可以对<code>etcd配置加密</code>(支持多种加密算法).</li><li>secret之间的传输使用<code>mTLS</code>.</li><li><code>禁止硬编码</code>,包括在日志打印中显示也要避免.</li></ol><h1 id="网络通讯"><a href="#网络通讯" class="headerlink" title="网络通讯"></a>网络通讯</h1><h2 id="容器间通讯"><a href="#容器间通讯" class="headerlink" title="容器间通讯"></a>容器间通讯</h2><p>同一个pod内多个容器<code>共享网络命名空间</code>,通过<code>L0环回口</code>通讯</p><h2 id="相同节点pods间通讯"><a href="#相同节点pods间通讯" class="headerlink" title="相同节点pods间通讯"></a>相同节点pods间通讯</h2><h2 id="不同节点pods间通讯"><a href="#不同节点pods间通讯" class="headerlink" title="不同节点pods间通讯"></a>不同节点pods间通讯</h2><p>k8s规定所有pod都要运行在<code>同一个扁平的没有nat转换的网络中</code>,物理上pod可以运行在不同的节点上,但是看起来他们就像运行同一个<code>局域网</code>中.实现这个要求的就是<code>CNI</code>,当pod创建或销毁时,CNI就负责pod的网络配置,比如分配ip,配置路由等.</p><p>不同的CNI的实现方式不一样,以主流的fannel和calico为例:</p><h3 id="Flannel"><a href="#Flannel" class="headerlink" title="Flannel"></a>Flannel</h3><p>Flannel主要支持两种后端:</p><ul><li><p>VxLan(默认)</p><p>类似VPN,在两个pod之间建立虚拟的网络隧道实现通讯.是一种在<code>3层网络</code>上通过封装原始数据包来创建一个<code>虚拟的2层网络</code>来实现的点对点通讯.</p><blockquote><p>工作方式：VXLAN 使用 UDP 数据包来封装和转发原始的以太网帧。每个主机以 VTEP（VXLAN Tunnel Endpoint）的身份运行，负责封装和解封装从 Pods 发出或发送到 Pods 的数据包。</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/occultagg/blog-pics/hexo-blog/image-20240313222411556.png" srcset="/img/loading.gif" lazyload alt="image-20240313222411556"></p></li></ul><p>​	缺点: 隧道通讯,多层封装,开销大</p><ul><li><p>Host-GW</p><p>Flannel在初始化时会被分配一个大的IP段,然后会自动将这个大IP段分割成多个小的子网块,这些子网会分配给各个节点.每个节点上维护一个<code>静态路由表</code>.</p><p>每个节点的pod都在独自的网段中,通过静态路由到达目标节点的网段,从而到达目标pod.</p><p><img src="https://cdn.jsdelivr.net/gh/occultagg/blog-pics/hexo-blog/image-20240313224650354.png" srcset="/img/loading.gif" lazyload alt="image-20240313224650354"></p></li></ul><h3 id="Calico"><a href="#Calico" class="headerlink" title="Calico"></a>Calico</h3><p>默认与Flannel的host-GW类似,不过Calico使用的是<code>动态路由协议(BGP)</code>来维护和更新路由表.</p><p>另外Calico也支持VxLan模式的封装.</p><h3 id="Flannel-VS-Calico"><a href="#Flannel-VS-Calico" class="headerlink" title="Flannel  VS Calico"></a>Flannel VS Calico</h3><table><thead><tr><th></th><th>Calico</th><th>Flannel</th></tr></thead><tbody><tr><td>实现方式</td><td>1. VxLan(默认)<br>2. Host-GW静态路由</td><td>1. 动态路由协议<br>2. 支持VxLan</td></tr><tr><td>性能</td><td>默认使用隧道,性能差</td><td>默认直接使用路由,性能等同主机网络</td></tr><tr><td>网络策略</td><td>不支持</td><td>支持</td></tr><tr><td>配置管理</td><td>简单</td><td>复杂,粒度细</td></tr></tbody></table><h2 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h2><h3 id="ClusterIP"><a href="#ClusterIP" class="headerlink" title="ClusterIP"></a>ClusterIP</h3><p>Service本质上是<code>kube-proxy管理的一系列iptables/ipvs规则</code>,其Cluster-IP(本质上是一个虚拟IP)实际上是<code>kube-controller-manager</code>负责管理提供.给集群内部的其他组件使用访问后端的一组pod.</p><p>当一个pod试图通信到一个service的Cluster-IP,kube-proxy会介入数据流,从service绑定的endpoint中选择合适的后端Pod进行流量转发.因为kube-proxy使用iptables&#x2F;ipvs规则实现流量转发,不涉及用户空间,所以性能优秀.</p><p>core-dns也会给每个svc绑定一个域名,映射对应的clusterIP</p><h3 id="Headless"><a href="#Headless" class="headerlink" title="Headless"></a>Headless</h3><p>当使用Headless类型的service时,service只会绑定一个域名,而不会分配IP.</p><p>pod访问其域名,core-DNS返回的是一个<code>所有后端Pod IP的列表</code></p><p>客户端需要使用返回的IP列表选择一个或多个来通信,也可以自行实现负载均衡去访问.</p><p>通常与<code>statefulset</code>一同使用,此时每个statefulset的pod都会有一个<code>独立的</code>网络标识和持久化存储.</p></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/" class="category-chain-item">技术笔记</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/k8s/" class="print-no-link">#k8s</a></div></div><div class="license-box my-3"><div class="license-title"><div>k8s-理论</div><div>http://example.com/2024/02/20/k8s-theory/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>Peter Pan</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2024年2月20日</div></div><div class="license-meta-item"><div>许可协议</div><div><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2024/02/22/ansible-mustknow/" title="ansible-必知必会"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">ansible-必知必会</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2024/02/16/k8s-monitor-2/" title="k8s-监控与日志"><span class="hidden-mobile">k8s-监控与日志</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">总访问量 <span id="busuanzi_value_site_pv"></span> 次 </span><span id="busuanzi_container_site_uv" style="display:none">总访客数 <span id="busuanzi_value_site_uv"></span> 人</span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>